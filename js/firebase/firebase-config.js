import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

// Firebase konfigur√°ci√≥
const firebaseConfig = {
    apiKey: "AIzaSyCsN0iILNbrGpofT5hGsaXtWrQ0WJpBDKM",
    authDomain: "perfectcircle-8f981.firebaseapp.com",
    projectId: "perfectcircle-8f981",
    storageBucket: "perfectcircle-8f981.firebasestorage.app",
    messagingSenderId: "314252830723",
    appId: "1:314252830723:web:bc4f681f74247d6de20636",
    measurementId: "G-6XR5FNJLHF"
};

// Firebase √°llapot kezel√©s
let app, db;
let firebaseReady = false;

// St√°tusz friss√≠t≈ë f√ºggv√©ny
function updateFirebaseStatus(status, message) {
    const statusEl = document.getElementById('firebaseStatus');
    const offlineNotice = document.getElementById('offlineNotice');
    
    statusEl.className = `firebase-status ${status}`;
    
    switch(status) {
        case 'online':
            statusEl.innerHTML = 'üü¢ Online';
            offlineNotice.classList.remove('show');
            break;
        case 'offline':
            statusEl.innerHTML = 'üî¥ Offline';
            offlineNotice.classList.add('show');
            break;
        case 'connecting':
            statusEl.innerHTML = 'üü° Connecting...';
            offlineNotice.classList.remove('show');
            break;
        case 'error':
            statusEl.innerHTML = '‚ùå Error';
            offlineNotice.classList.add('show');
            break;
    }
    
    console.log(`üî• Firebase: ${status} - ${message || ''}`);
}

// Firebase inicializ√°l√°s
async function initializeFirebase() {
    updateFirebaseStatus('connecting', 'Inicializ√°l√°s...');
    
    try {
        console.log('üî• Firebase inicializ√°l√°sa...');
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        
        // Egyszer≈± kapcsolat teszt
        console.log('üîó Firestore teszt...');
        const testQuery = query(collection(db, 'scores'), limit(1));
        const querySnapshot = await getDocs(testQuery);
        
        firebaseReady = true;
        updateFirebaseStatus('online', `M≈±k√∂dik! ${querySnapshot.size} dokumentum`);
        console.log('‚úÖ Firebase sikeresen m≈±k√∂dik!');
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Firebase hiba:', error);
        firebaseReady = false;
        
        if (error.code === 'permission-denied') {
            updateFirebaseStatus('error', 'Firestore Rules hiba');
            console.error('üö´ FIRESTORE RULES HIBA! Sz√ºks√©ges: allow read, write: if true;');
        } else {
            updateFirebaseStatus('offline', error.code || error.message);
        }
        
        return false;
    }
}

// Firebase API
window.firebaseAPI = {
    // ‚úÖ JAV√çTOTT SAVESCORE F√úGGV√âNY THUMBNAIL T√ÅMOGAT√ÅSSAL
    saveScore: async (data) => {
        console.log('üî• Firebase saveScore - kapott adat:', data);
        console.log('üî• Thumbnail ellen≈ërz√©s:', {
            hasThumbnail: !!data.thumbnail,
            thumbnailType: typeof data.thumbnail,
            thumbnailLength: data.thumbnail ? data.thumbnail.length : 0,
            thumbnailSize: data.thumbnail ? Math.round(data.thumbnail.length / 1024) + 'KB' : 'N/A'
        });
        
        if (!firebaseReady) {
            throw new Error('Firebase nem el√©rhet≈ë');
        }
        
        // ‚úÖ BIZTOS v√°ltoz√≥k
        const safePlayerName = String(data.playerName || 'N√©vtelen').trim();
        const safeScore = Number(data.score);
        const safeDifficulty = String(data.difficulty || 'easy');
        const safeTransformation = String(data.transformation || '');
        const safeThumbnail = data.thumbnail || null; // ‚úÖ THUMBNAIL KEZEL√âS
        
        console.log('üî• Feldolgozott √©rt√©kek:', { 
            safePlayerName, 
            safeScore, 
            scoreType: typeof safeScore,
            safeDifficulty, 
            safeTransformation,
            hasThumbnail: !!safeThumbnail,
            thumbnailSize: safeThumbnail ? Math.round(safeThumbnail.length / 1024) + 'KB' : 'nincs'
        });
        
        if (isNaN(safeScore)) {
            throw new Error(`Score NaN hiba: ${data.score} -> ${safeScore}`);
        }
        
        // ‚úÖ THUMBNAIL VALID√ÅL√ÅS
        if (safeThumbnail) {
            if (typeof safeThumbnail !== 'string') {
                console.warn('‚ö†Ô∏è Thumbnail nem string t√≠pus√∫, √°talak√≠t√°s...');
            }
            
            if (!safeThumbnail.startsWith('data:image/')) {
                console.warn('‚ö†Ô∏è Thumbnail nem valid base64 image!');
            } else {
                console.log('‚úÖ Thumbnail valid base64 image');
            }
        }
        
        const firebaseData = {
            playerName: safePlayerName,
            score: safeScore,
            difficulty: safeDifficulty,
            transformation: safeTransformation,
            thumbnail: safeThumbnail, // ‚úÖ THUMBNAIL MEZ≈ê HOZZ√ÅADVA
            timestamp: serverTimestamp(),
            date: new Date().toLocaleDateString('hu-HU'),
            created: new Date().toISOString()
        };
        
        console.log('üî• Firebase-nek k√ºld√∂tt adat:', {
            ...firebaseData,
            thumbnail: firebaseData.thumbnail ? `[${Math.round(firebaseData.thumbnail.length / 1024)}KB image]` : null
        });
        
        try {
            const docRef = await addDoc(collection(db, 'scores'), firebaseData);
            console.log('‚úÖ Pontsz√°m mentve thumbnaillal:', docRef.id);
            
            // ‚úÖ VISSZAT√âR√âSI √âRT√âK THUMBNAIL-LAL
            const result = { 
                id: docRef.id, 
                ...firebaseData,
                thumbnailSaved: !!safeThumbnail
            };
            
            console.log('‚úÖ Ment√©s eredm√©nye:', {
                id: result.id,
                score: result.score,
                playerName: result.playerName,
                thumbnailSaved: result.thumbnailSaved
            });
            
            return result;
            
        } catch (error) {
            console.error('‚ùå Ment√©si hiba:', error);
            console.error('‚ùå K√ºld√∂tt adat m√©rete:', JSON.stringify(firebaseData).length, 'karakter');
            
            // ‚úÖ HA T√öLS√ÅGOSAN NAGY A THUMBNAIL, PR√ìB√ÅLJUK N√âLK√úLE
            if (error.code === 'invalid-argument' && safeThumbnail) {
                console.log('üîÑ T√∫l nagy thumbnail, √∫jrapr√≥b√°l√°s n√©lk√ºle...');
                
                const dataWithoutThumbnail = {
                    ...firebaseData,
                    thumbnail: null
                };
                
                try {
                    const docRef = await addDoc(collection(db, 'scores'), dataWithoutThumbnail);
                    console.log('‚úÖ Pontsz√°m mentve thumbnail n√©lk√ºl:', docRef.id);
                    return { id: docRef.id, ...dataWithoutThumbnail, thumbnailSaved: false };
                } catch (retryError) {
                    console.error('‚ùå √öjrapr√≥b√°l√°s is sikertelen:', retryError);
                    throw retryError;
                }
            }
            
            throw error;
        }
    },

    getTopScores: async (limitCount = 10) => {
        if (!firebaseReady) {
            throw new Error('Firebase nem el√©rhet≈ë');
        }
        
        try {
            const q = query(
                collection(db, 'scores'), 
                orderBy('score', 'desc'), 
                limit(limitCount)
            );
            
            const querySnapshot = await getDocs(q);
            const scores = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                
                // ‚úÖ THUMBNAIL ELLEN≈êRZ√âS A BET√ñLT√âSN√âL
                const scoreData = { 
                    id: doc.id, 
                    ...data 
                };
                
                if (data.thumbnail) {
                    console.log(`üì∏ Score ${doc.id} tartalmaz thumbnail-t (${Math.round(data.thumbnail.length / 1024)}KB)`);
                } else {
                    console.log(`üì∑ Score ${doc.id} nem tartalmaz thumbnail-t`);
                }
                
                scores.push(scoreData);
            });
            
            console.log(`üìä ${scores.length} eredm√©ny bet√∂ltve, ebb≈ël ${scores.filter(s => s.thumbnail).length} tartalmaz thumbnail-t`);
            return scores;
            
        } catch (error) {
            console.error('‚ùå Lek√©rdez√©si hiba:', error);
            throw error;
        }
    },

    saveVisit: async (visitData) => {
        if (!firebaseReady) {
            throw new Error('Firebase nem el√©rhet≈ë');
        }
        
        try {
            const docRef = await addDoc(collection(db, 'visits'), {
                ...visitData,
                serverTimestamp: serverTimestamp()
            });
            
            console.log('‚úÖ L√°togat√°s mentve:', docRef.id);
            return docRef.id;
            
        } catch (error) {
            console.error('‚ùå L√°togat√°s ment√©si hiba:', error);
            throw error;
        }
    },

    getVisitCount: async () => {
        if (!firebaseReady) {
            throw new Error('Firebase nem el√©rhet≈ë');
        }
        
        try {
            const q = query(collection(db, 'visits'));
            const querySnapshot = await getDocs(q);
            
            const count = querySnapshot.size;
            console.log(`üìä √ñsszes l√°togat√°s: ${count}`);
            return count;
            
        } catch (error) {
            console.error('‚ùå L√°togat√°ssz√°m lek√©rdez√©si hiba:', error);
            throw error;
        }
    },

    getTodayVisitCount: async () => {
        if (!firebaseReady) {
            throw new Error('Firebase nem el√©rhet≈ë');
        }
        
        try {
            const today = new Date().toLocaleDateString('hu-HU');
            const q = query(
                collection(db, 'visits'),
                where('date', '==', today)
            );
            
            const querySnapshot = await getDocs(q);
            const count = querySnapshot.size;
            
            console.log(`üìä Mai l√°togat√°sok: ${count}`);
            return count;
            
        } catch (error) {
            console.error('‚ùå Mai l√°togat√°ssz√°m lek√©rdez√©si hiba:', error);
            throw error;
        }
    },

    getVisitStats: async () => {
        if (!firebaseReady) {
            throw new Error('Firebase nem el√©rhet≈ë');
        }
        
        try {
            const q = query(collection(db, 'visits'), orderBy('timestamp', 'desc'), limit(100));
            const querySnapshot = await getDocs(q);
            
            const visits = [];
            querySnapshot.forEach((doc) => {
                visits.push({ id: doc.id, ...doc.data() });
            });
            
            const today = new Date().toLocaleDateString('hu-HU');
            const todayVisits = visits.filter(v => v.date === today).length;
            const uniqueSessions = new Set(visits.map(v => v.sessionId)).size;
            
            const stats = {
                total: querySnapshot.size,
                today: todayVisits,
                uniqueSessions: uniqueSessions,
                recentVisits: visits.slice(0, 10)
            };
            
            console.log('üìä L√°togat√°si statisztik√°k:', stats);
            return stats;
            
        } catch (error) {
            console.error('‚ùå L√°togat√°si statisztik√°k lek√©rdez√©si hiba:', error);
            throw error;
        }
    },

    isReady: () => firebaseReady,
    
    reconnect: async () => {
        return await initializeFirebase();
    },

    // ‚úÖ THUMBNAIL TESZT F√úGGV√âNY
    testThumbnail: async () => {
        console.log('üß™ Thumbnail teszt ind√≠t√°sa...');
        
        if (!firebaseReady) {
            console.error('‚ùå Firebase nem el√©rhet≈ë');
            return false;
        }
        
        // Kis teszt thumbnail k√©sz√≠t√©se
        const canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        
        // Egyszer≈± k√∂r rajzol√°sa
        ctx.fillStyle = '#ff6b6b';
        ctx.beginPath();
        ctx.arc(50, 50, 40, 0, Math.PI * 2);
        ctx.fill();
        
        const testThumbnail = canvas.toDataURL('image/jpeg', 0.8);
        console.log('üß™ Teszt thumbnail k√©sz√≠tve:', Math.round(testThumbnail.length / 1024) + 'KB');
        
        try {
            const testData = {
                playerName: 'Teszt',
                score: 99,
                difficulty: 'easy',
                transformation: 'teszt',
                thumbnail: testThumbnail
            };
            
            const result = await window.firebaseAPI.saveScore(testData);
            console.log('‚úÖ Thumbnail teszt sikeres:', result.id);
            return true;
            
        } catch (error) {
            console.error('‚ùå Thumbnail teszt sikertelen:', error);
            return false;
        }
    }
};

// Firebase info megjelen√≠t≈ë - KIB≈êV√çTETT VERZI√ì
window.showFirebaseInfo = () => {
    const status = firebaseReady ? 'Online' : 'Offline';
    const info = `
üî• Firebase St√°tusz: ${status}
üèóÔ∏è Projekt: perfectcircle-8f981
üìä Firestore: ${firebaseReady ? 'M≈±k√∂dik' : 'Hiba'}
üì∏ Thumbnail t√°mogat√°s: ${firebaseReady ? 'Akt√≠v' : 'Inakt√≠v'}

${!firebaseReady ? `
‚ùå PROBL√âMA MEGOLD√ÅSA:
1. Firebase Console > Firestore > Rules
2. M√°sold be ezt:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /scores/{document} {
      allow read, write: if true;
    }
    match /visits/{document} {
      allow read, write: if true;
    }
  }
}

3. Publish gomb
4. Friss√≠tsd az oldalt (F5)
` : '‚úÖ Minden rendben!'}

üß™ THUMBNAIL TESZT:
Konzolban √≠rd be: window.firebaseAPI.testThumbnail()
    `;
    alert(info);
};

// ‚úÖ THUMBNAIL HIBAKERES√âSI F√úGGV√âNY
window.debugFirebaseThumbnails = async () => {
    console.log('üîç === FIREBASE THUMBNAIL HIBAKERES√âS ===');
    console.log('- Firebase ready:', firebaseReady);
    console.log('- firebaseAPI:', !!window.firebaseAPI);
    console.log('- saveScore:', typeof window.firebaseAPI?.saveScore);
    console.log('- ThumbnailGenerator:', !!window.ThumbnailGenerator);
    
    if (window.ThumbnailGenerator) {
        const testCanvas = document.getElementById('gameCanvas');
        if (testCanvas) {
            const thumbnail = window.ThumbnailGenerator.captureCanvasThumbnail('gameCanvas');
            console.log('- Teszt thumbnail k√©sz√ºlt:', !!thumbnail);
            console.log('- Thumbnail m√©rete:', thumbnail ? Math.round(thumbnail.length / 1024) + 'KB' : 'N/A');
            
            if (thumbnail && firebaseReady) {
                console.log('üß™ Firebase thumbnail teszt ind√≠t√°sa...');
                const testResult = await window.firebaseAPI.testThumbnail();
                console.log('- Firebase teszt eredm√©nye:', testResult);
            }
        } else {
            console.log('- gameCanvas elem nem tal√°lhat√≥');
        }
    }
    
    console.log('=== HIBAKERES√âS V√âGE ===');
};

// Glob√°lis hozz√°f√©r√©s
window.updateFirebaseStatus = updateFirebaseStatus;

// Inicializ√°l√°s ind√≠t√°sa
initializeFirebase();

// Firebase imports glob√°lis el√©rhet≈ëv√© t√©tele a visitor counter sz√°m√°ra
window.firebaseImports = {
    collection,
    addDoc,
    query,
    orderBy,
    limit,
    getDocs,
    serverTimestamp,
    where,
    doc: (db, path, id) => {
        return { path: `${path}/${id}`, id: id };
    },
    setDoc: async (docRef, data) => {
        const collectionPath = docRef.path.split('/')[0];
        const docId = docRef.id;
        return await addDoc(collection(db, collectionPath), { ...data, customId: docId });
    },
    getDoc: async (docRef) => {
        const collectionPath = docRef.path.split('/')[0];
        const docId = docRef.id;
        
        const q = query(
            collection(db, collectionPath),
            where('customId', '==', docId),
            limit(1)
        );
        
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            return { exists: () => false };
        }
        
        const doc = querySnapshot.docs[0];
        return {
            exists: () => true,
            data: () => doc.data(),
            id: doc.id
        };
    },
    updateDoc: async (docRef, data) => {
        console.log('‚ö†Ô∏è updateDoc nem implement√°lt, √∫j dokumentum l√©trehoz√°sa...');
        const collectionPath = docRef.path.split('/')[0];
        return await addDoc(collection(db, collectionPath), data);
    },
    increment: (value) => {
        return value;
    }
};

// Firebase database glob√°lis el√©rhet≈ëv√© t√©tele
window.db = db;

console.log('‚úÖ Firebase imports √©s db glob√°lisan el√©rhet≈ëk a visitor counter sz√°m√°ra');
console.log('üì∏ Firebase thumbnail t√°mogat√°s aktiv√°lva');
