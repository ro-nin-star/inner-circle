<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Perfect Circle - Rajzolj Tökéletes Kört!</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- ✅ GLOBÁLIS LEADERBOARD TÍPUS KÖVETÉSE - HTML SZINTEN -->
    <script>
        window.currentLeaderboardType = 'local';
        console.log('🔧 HTML szintű leaderboard típus beállítva:', window.currentLeaderboardType);
    </script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

</head>

<body>
    <!-- Játékos animált háttér elemek -->
    <div class="decoration-circle"></div>
    <div class="decoration-circle"></div>
    <div class="decoration-circle"></div>

    <!-- ===== JÁTÉKOS FELSŐ FIX FEJLÉC ===== -->
    <div class="top-fixed-header">
        <!-- Firebase Status -->
        <div class="firebase-status connecting" id="firebaseStatus" data-i18n="firebase.connecting">🟡 Kapcsolódás...</div>
        <!-- Nyelv váltó -->
        <div class="language-selector" id="languageSelector">
            <div class="current-language" onclick="window.i18nManager?.toggleLanguageMenu()">
                <span id="currentLanguageFlag">🇭🇺</span>
                <span id="currentLanguageCode">HU</span>
            </div>
            <div class="language-menu" id="languageMenu">
                <!-- Dinamikusan töltődik a JavaScript által -->
            </div>
        </div>
    </div>
    <!-- ==================================================== -->

    <div class="game-container" id="gameContainer">
        <h1 data-i18n="title">🎯 Perfect Circle</h1>
        <p class="subtitle" data-i18n="subtitle">Rajzolj a lehető legtökéletesebb kört egyetlen mozdulattal!</p>
        
        <div class="instructions">
            <strong data-i18n="instructions.title">🎮 Hogyan játssz:</strong> 
            <span data-i18n="instructions.text">Kattints és húzd az egeret (vagy érintsd és húzd az ujjad) hogy egy kört rajzolj. Minél tökéletesebb a köröd, annál több pontot kapsz! A kör varázslatos módon át fog változni! ✨</span>
        </div>

        <!-- Offline notice -->
        <div class="offline-notice" id="offlineNotice" style="display: none;">
            <span data-i18n="firebase.offlineNotice">⚠️ <strong>Offline mód:</strong> A globális ranglista nem elérhető. Az eredmények helyben mentődnek.</span>
        </div>

        <!-- PLAYER NAME SECTION -->
        <div class="player-name-section">
            <label for="playerName"><strong data-i18n="player.label">👤 Játékos név:</strong></label>
            <input type="text" id="playerName" class="player-name-input" data-i18n="player.placeholder" placeholder="Add meg a neved" maxlength="20" value="">
            <button id="saveNameBtn" data-i18n="buttons.save">💾 Mentés</button>
        </div>

        <div class="difficulty-selector">
            <strong data-i18n="difficulty.label">🎯 Nehézség:</strong><br>
            <button class="difficulty-btn active" onclick="setDifficulty('easy')" data-difficulty="easy" data-i18n="difficulty.easy">Könnyű 😊</button>
            <button class="difficulty-btn" onclick="setDifficulty('hard')" data-difficulty="hard" data-i18n="difficulty.hard">Nehéz 🌀</button>
        </div>
<!-- 🎯 RAJZOLÁS GOMB - FELÜL -->
    <div class="draw-start-container">
        <div class="arrow arrow-left">👈</div>
        <div class="arrow arrow-top">👆</div>
        <button class="draw-start-button" id="startDrawingBtn" onclick="startDrawing()">
            🎨 Kezdj Rajzolni! 🎨
        </button>
        <div class="arrow arrow-right">👉</div>
        <div class="arrow arrow-bottom">👇</div>
    </div>
<!-- ✅ JAVÍTOTT STATISZTIKÁK HTML -->
<div class="stats-container">
    <div class="stat-item">
        <div class="stat-label">Jelenlegi</div>
        <div class="stat-value" id="currentScore">0</div>
    </div>
    <div class="stat-item">
        <div class="stat-label">Legjobb</div>
        <div class="stat-value" id="bestScore">0</div>
    </div>
    <div class="stat-item">
        <div class="stat-label">Játékok</div>
        <div class="stat-value" id="gamesPlayed">0</div>
    </div>
    <div class="stat-item">
        <div class="stat-label">Átlag</div>
        <div class="stat-value" id="averageScore">0</div>
    </div>
</div>


        <!-- ✅ NÉGYZETES CANVAS CONTAINER -->
        <div class="canvas-container">
            <canvas id="gameCanvas" width="460" height="460"></canvas>
            <canvas id="idealCircleCanvas" width="460" height="460"></canvas>
            <div class="canvas-overlay" id="canvasOverlay"></div>
            <div class="transformation-overlay" id="transformationOverlay">
                <div class="transformation-content">
                    <h2 id="transformationText" data-i18n="transformation.magic">✨ Varázslat történik... ✨</h2>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" data-i18n="buttons.startDrawing" >🎯 Rajzolás Kezdése</button>
            <button id="clearBtn" disabled data-i18n="buttons.clear">🗑️ Törlés</button>
            <button id="helpBtn" data-i18n="buttons.help">❓ Segítség</button>
            <button id="clearScoresBtn" data-i18n="buttons.clearScores">🗑️ Helyi Eredmények Törlése</button>
        </div>

        <!-- Pontszám megjelenítő -->
        <div class="score-display" id="scoreDisplay" style="display: none;">
            <h3 id="scoreTitle" data-i18n="scoreTitle.result">🏆 Eredmény</h3>
            <div class="score-number">
                <span id="finalScore">0</span>/100 <span data-i18n="common.points">pont</span>
            </div>
            <div class="score-breakdown" id="scoreBreakdown">
                <!-- Dinamikusan töltődik -->
            </div>
            
            <!-- Ideális kör összehasonlítás -->
            <div id="idealCircleContainer" class="ideal-circle-container" style="display: none;">
                <h4 data-i18n="analysis.idealCircle">Ideális kör összehasonlítás:</h4>
                <div class="ideal-circle-canvas-container">
                    <canvas id="idealComparisonCanvas" width="200" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD WITH TABS -->
        <div class="leaderboard">
            <h3 data-i18n="leaderboard.title">🏆 Ranglista</h3>
            <div class="leaderboard-tabs">
                <button id="localTab" class="tab-btn active">
                    📱 Helyi
                </button>
                <button id="globalTab" class="tab-btn">
                    🌍 Globális
                </button>
            </div>

            <div class="leaderboard-status" id="leaderboardStatus" data-i18n="leaderboard.localResults">
                📱 Helyi eredmények
            </div>
            <div id="leaderboardList">
                <div class="score-entry">
                    <span data-i18n="leaderboard.noResults">Még nincsenek eredmények</span>
                </div>
            </div>
        </div>

        <!-- Részletes instrukciók -->
        <div class="detailed-instructions">
            <h3 data-i18n="instructions.detailedTitle">📖 Részletes Útmutató</h3>
            <div class="instruction-section">
                <h4 data-i18n="instructions.gameplayTitle">🎮 Játékmenet:</h4>
                <ul>
                    <li data-i18n="instructions.step1">Kattints a "Rajzolás Kezdése" gombra</li>
                    <li data-i18n="instructions.step2">Rajzolj egy kört egyetlen mozdulattal</li>
                    <li data-i18n="instructions.step3">Nézd meg az eredményed és a transzformációt!</li>
                </ul>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.scoringTitle">📊 Pontszámítás:</h4>
                <ul>
                    <li data-i18n="instructions.shapeScore">🔵 Köralak (40 pont): Mennyire hasonlít körre</li>
                    <li data-i18n="instructions.closureScore">🔗 Záródás (20 pont): Mennyire zárt a forma</li>
                    <li data-i18n="instructions.smoothnessScore">🌊 Egyenletesség (25 pont): Mennyire egyenletes a vonal</li>
                    <li data-i18n="instructions.sizeScore">📏 Méret (15 pont): Optimális méret használata</li>
                </ul>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.transformationsTitle">🎨 Transzformációk:</h4>
                <p data-i18n="instructions.transformationsText">70+ pont esetén a köröd varázslatos alakzattá változik! Minden transzformáció után egy mosolygó arc jelenik meg! 😊</p>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.controlsTitle">⌨️ Billentyű parancsok:</h4>
                <ul>
                    <li data-i18n="instructions.ctrlS">Ctrl+S: Rajzolás kezdése</li>
                    <li data-i18n="instructions.ctrlR">Ctrl+R: Törlés</li>
                    <li data-i18n="instructions.ctrlH">Ctrl+H: Segítség</li>
                    <li data-i18n="instructions.ctrlL">Ctrl+L: Nyelv menü</li>
                    <li data-i18n="instructions.escape">Esc: Játék megszakítása</li>
                    <li data-i18n="instructions.f1">F1: Segítség</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Látogatásszámláló -->
    <div class="visitor-counter" id="visitorCounter" onclick="showVisitStats()">
        <span data-i18n="visitors.label">👥 Látogatások:</span> <span class="visitor-number" id="visitCount">0</span>
    </div>

    <!-- Fejlesztői információk -->
    <div class="dev-info">
        <span data-i18n="dev.version">v2.1</span> | 
        <span onclick="window.debugGameEngine?.()" data-i18n="dev.debug">Debug</span>
    </div>

    <!-- JavaScript fájlok betöltése -->
    <script>
        // Globális nyelvi adatok tárolója
        window.languageData = {};
        
        // Magyar nyelv beágyazása (egyszerűsített verzió)
        window.languageData.hu = {
            title: "Perfect Circle - Rajzolj Tökéletes Kört!",
            subtitle: "Rajzolj a lehető legtökéletesebb kört egyetlen mozdulattal!",
            instructions: {
                title: "🎮 Hogyan játssz:",
                text: "Kattints és húzd az egeret (vagy érintsd és húzd az ujjad) hogy egy kört rajzolj. Minél tökéletesebb a köröd, annál több pontot kapsz! A kör varázslatos módon át fog változni! ✨"
            },
            buttons: {
                startDrawing: "🎯 Rajzolás Kezdése",
                clear: "🗑️ Törlés",
                help: "❓ Segítség",
                save: "💾 Mentés",
                clearScores: "🗑️ Helyi Eredmények Törlése"
            },
            player: {
                label: "👤 Játékos név:",
                placeholder: "Add meg a neved"
            },
            difficulty: {
                label: "🎯 Nehézség:",
                easy: "Könnyű 😊",
                hard: "Nehéz 🌀"
            },
            stats: {
                currentScore: "Jelenlegi Pontszám",
                bestScore: "Legjobb Eredmény",
                gamesPlayed: "Játékok Száma",
                averageScore: "Átlag Pontszám"
            },
            leaderboard: {
                title: "🏆 Ranglista",
                localResults: "📱 Helyi eredmények",
                noResults: "Még nincsenek eredmények"
            },
            common: {
                points: "pont"
            },
            scoreTitle: {
                result: "🏆 Eredmény"
            },
            transformation: {
                magic: "✨ Varázslat történik... ✨"
            },
            firebase: {
                connecting: "🟡 Kapcsolódás...",
                offlineNotice: "⚠️ <strong>Offline mód:</strong> A globális ranglista nem elérhető. Az eredmények helyben mentődnek."
            },
            visitors: {
                label: "👥 Látogatások:"
            },
            dev: {
                version: "v2.1",
                debug: "Debug"
            }
        };
    </script>

    <!-- THUMBNAIL GENERATOR BEÁGYAZVA -->
    <script>
        // js/utils/thumbnailGenerator.js - BEÁGYAZVA
        window.ThumbnailGenerator = {
            
            // Canvas tartalom mentése thumbnail-ként
            captureCanvasThumbnail: function(canvasId, maxWidth = 100, maxHeight = 100, quality = 0.8) {
                try {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) {
                        console.error('❌ Canvas nem található:', canvasId);
                        return null;
                    }
                    
                    // Thumbnail canvas létrehozása
                    const thumbCanvas = document.createElement('canvas');
                    const thumbCtx = thumbCanvas.getContext('2d');
                    
                    // Arányos átméretezés számítása
                    const originalWidth = canvas.width;
                    const originalHeight = canvas.height;
                    const aspectRatio = originalWidth / originalHeight;
                    
                    let thumbWidth = maxWidth;
                    let thumbHeight = maxHeight;
                    
                    if (aspectRatio > 1) {
                        thumbHeight = maxWidth / aspectRatio;
                    } else {
                        thumbWidth = maxHeight * aspectRatio;
                    }
                    
                    thumbCanvas.width = Math.round(thumbWidth);
                    thumbCanvas.height = Math.round(thumbHeight);
                    
                    // Háttér beállítása (átlátszó helyett fehér)
                    thumbCtx.fillStyle = '#ffffff';
                    thumbCtx.fillRect(0, 0, thumbCanvas.width, thumbCanvas.height);
                    
                    // Eredeti canvas tartalom átmásolása
                    thumbCtx.drawImage(canvas, 0, 0, thumbCanvas.width, thumbCanvas.height);
                    
                    // Base64 string visszaadása
                    const thumbnailData = thumbCanvas.toDataURL('image/jpeg', quality);
                    
                    console.log('✅ Thumbnail készítve:', {
                        originalSize: `${originalWidth}x${originalHeight}`,
                        thumbnailSize: `${thumbCanvas.width}x${thumbCanvas.height}`,
                        dataSize: Math.round(thumbnailData.length / 1024) + 'KB'
                    });
                    
                    return thumbnailData;
                    
                } catch (error) {
                    console.error('❌ Thumbnail készítési hiba:', error);
                    return null;
                }
            },

            // Transzformáció után thumbnail készítés
            captureTransformationThumbnail: function(delay = 500) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Próbáljuk meg a gameCanvas-ról
                        let thumbnail = this.captureCanvasThumbnail('gameCanvas');
                        
                        // Ha nincs, próbáljuk az idealCircleCanvas-ról
                        if (!thumbnail) {
                            thumbnail = this.captureCanvasThumbnail('idealCircleCanvas');
                        }
                        
                        resolve(thumbnail);
                    }, delay);
                });
            },

            // Thumbnail megjelenítése DOM elemben
            displayThumbnail: function(thumbnailData, containerId, className = 'score-thumbnail') {
                try {
                    if (!thumbnailData) return false;
                    
                    const container = document.getElementById(containerId);
                    if (!container) return false;
                    
                    // Meglévő thumbnail eltávolítása
                    const existingThumbnail = container.querySelector('.' + className);
                    if (existingThumbnail) {
                        existingThumbnail.remove();
                    }
                    
                    // Új thumbnail elem létrehozása
                    const img = document.createElement('img');
                    img.src = thumbnailData;
                    img.className = className;
                    img.style.cssText = `
                        width: 60px;
                        height: 60px;
                        object-fit: cover;
                        border-radius: 8px;
                        border: 2px solid #ddd;
                        margin-left: 10px;
                        cursor: pointer;
                        transition: transform 0.2s;
                    `;
                    
                    // Hover effekt
                    img.addEventListener('mouseenter', () => {
                        img.style.transform = 'scale(1.1)';
                    });
                    
                    img.addEventListener('mouseleave', () => {
                        img.style.transform = 'scale(1)';
                    });
                    
                    // Kattintásra nagyítás
                    img.addEventListener('click', () => {
                        this.showThumbnailModal(thumbnailData);
                    });
                    
                    container.appendChild(img);
                    return true;
                    
                } catch (error) {
                    console.error('❌ Thumbnail megjelenítési hiba:', error);
                    return false;
                }
            },

            // Thumbnail modal megjelenítése
            showThumbnailModal: function(thumbnailData) {
                // Modal létrehozása
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    cursor: pointer;
                `;
                
                const img = document.createElement('img');
                img.src = thumbnailData;
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                `;
                
                modal.appendChild(img);
                document.body.appendChild(modal);
                
                // Kattintásra bezárás
                modal.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // ESC billentyűre bezárás
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }
        };

        console.log('✅ ThumbnailGenerator betöltve');
    </script>

    <!-- SCORE ANIMATOR -->
    <script>
        window.ScoreAnimator = {
            
            // Főbb animáció indítása
            animateScore: function(score, breakdown, transformationName = '') {
                console.log('🎉 Score animáció indítása:', score);
                
                try {
                    // Score kategória meghatározása
                    const category = this.getScoreCategory(score);
                    
                    // Nagy score felfedés
                    this.showBigScoreReveal(score, category);
                    
                    // Részletek animálása
                    setTimeout(() => {
                        this.animateScoreBreakdown(breakdown);
                    }, 1500);
                    
                    // Egyéb effektek
                    setTimeout(() => {
                        this.addScoreEffects(score, category);
                    }, 500);
                    
                    // Score display animálása
                    setTimeout(() => {
                        this.animateScoreDisplay(score, category);
                    }, 2000);
                    
                } catch (error) {
                    console.error('❌ Score animáció hiba:', error);
                }
            },
            
            // Score kategória meghatározása
            getScoreCategory: function(score) {
                if (score >= 95) return { name: 'perfect', text: 'TÖKÉLETES!', emoji: '🏆' };
                if (score >= 85) return { name: 'excellent', text: 'KIVÁLÓ!', emoji: '⭐' };
                if (score >= 70) return { name: 'good', text: 'JÓ!', emoji: '👍' };
                if (score >= 50) return { name: 'fair', text: 'ELFOGADHATÓ', emoji: '👌' };
                return { name: 'poor', text: 'GYAKOROLJ MÉG!', emoji: '💪' };
            },
            
            // Nagy score felfedés
            showBigScoreReveal: function(score, category) {
                // Overlay létrehozása
                const overlay = document.createElement('div');
                overlay.className = 'score-animation-overlay';
                
                // Score szöveg
                const scoreText = document.createElement('div');
                scoreText.className = `score-big-reveal score-${category.name}`;
                scoreText.innerHTML = `
                    <div style="font-size: 0.3em; margin-bottom: 10px;">${category.emoji} ${category.text} ${category.emoji}</div>
                    <div>${Math.round(score)}</div>
                    <div style="font-size: 0.4em; margin-top: 10px;">PONT</div>
                `;
                
                overlay.appendChild(scoreText);
                document.body.appendChild(overlay);
                
                // Hang lejátszása (ha van AudioManager)
                if (window.AudioManager && window.AudioManager.playScoreReveal) {
                    window.AudioManager.playScoreReveal(score);
                }
                
                // Eltávolítás
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 3000);
            },
            
            // Score breakdown animálása
            animateScoreBreakdown: function(breakdown) {
                const scoreBreakdown = document.getElementById('scoreBreakdown');
                if (!scoreBreakdown || !breakdown) return;
                
                // Elemek animálása egyenként
                const items = scoreBreakdown.querySelectorAll('div');
                items.forEach((item, index) => {
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(-50px)';
                    item.style.transition = 'all 0.5s ease';
                    
                    setTimeout(() => {
                        item.style.opacity = '1';
                        item.style.transform = 'translateX(0)';
                    }, index * 200);
                });
            },
            
            // Score display animálása
            animateScoreDisplay: function(score, category) {
                const scoreDisplay = document.getElementById('scoreDisplay');
                if (!scoreDisplay) return;
                
                // CSS class hozzáadása
                scoreDisplay.classList.add('score-revealed');
                
                // Badge hozzáadása
                this.addScoreBadge(scoreDisplay, category);
                
                // Class eltávolítása
                setTimeout(() => {
                    scoreDisplay.classList.remove('score-revealed');
                }, 2000);
            },
            
            // Score badge hozzáadása
            addScoreBadge: function(container, category) {
                // Meglévő badge eltávolítása
                const existingBadge = container.querySelector('.score-grade-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Új badge
                const badge = document.createElement('div');
                badge.className = 'score-grade-badge';
                badge.textContent = category.emoji + ' ' + category.text;
                
                container.style.position = 'relative';
                container.appendChild(badge);
                
                // Badge eltávolítása
                setTimeout(() => {
                    if (badge.parentNode) {
                        badge.parentNode.removeChild(badge);
                    }
                }, 3000);
            },
            
            // Egyéb effektek
            addScoreEffects: function(score, category) {
                // Particle effekt
                this.createParticles(score);
                
                // Confetti nagy score esetén
                if (score >= 80) {
                    this.createConfetti();
                }
                
                // Tűzijáték tökéletes score esetén
                if (score >= 95) {
                    this.createFireworks();
                }
            },
            
            // Particle effekt
            createParticles: function(score) {
                const container = document.createElement('div');
                container.className = 'score-particles';
                
                const particleCount = Math.min(score / 2, 50);
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'score-particle';
                    
                    // Random pozíció és irány
                    const angle = (Math.PI * 2 * i) / particleCount;
                    const distance = 100 + Math.random() * 100;
                    const dx = Math.cos(angle) * distance;
                    const dy = Math.sin(angle) * distance;
                    
                    particle.style.setProperty('--dx', dx + 'px');
                    particle.style.setProperty('--dy', dy + 'px');
                    particle.style.backgroundColor = this.getRandomColor();
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    container.appendChild(particle);
                }
                
                document.body.appendChild(container);
                
                // Eltávolítás
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }, 2000);
            },
            
            // Confetti létrehozása
            createConfetti: function() {
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
                
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 2 + 's';
                        
                        document.body.appendChild(confetti);
                        
                        setTimeout(() => {
                            if (confetti.parentNode) {
                                confetti.parentNode.removeChild(confetti);
                            }
                        }, 3000);
                    }, i * 50);
                }
            },
            
            // Tűzijáték
            createFireworks: function() {
                const colors = ['#FFD700', '#FF1744', '#00E676', '#2196F3', '#FF9800'];
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const container = document.createElement('div');
                        container.className = 'score-fireworks';
                        
                        const centerX = Math.random() * window.innerWidth;
                        const centerY = Math.random() * window.innerHeight * 0.5 + window.innerHeight * 0.2;
                        
                        for (let j = 0; j < 20; j++) {
                            const firework = document.createElement('div');
                            firework.className = 'firework';
                            firework.style.left = centerX + 'px';
                            firework.style.top = centerY + 'px';
                            firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                            firework.style.animationDelay = Math.random() * 0.5 + 's';
                            
                            container.appendChild(firework);
                        }
                        
                        document.body.appendChild(container);
                        
                        setTimeout(() => {
                            if (container.parentNode) {
                                container.parentNode.removeChild(container);
                            }
                        }, 1500);
                    }, i * 300);
                }
            },
            
            // Random szín
            getRandomColor: function() {
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
                return colors[Math.floor(Math.random() * colors.length)];
            },
            
            // Vibráció (mobil)
            vibrate: function(score) {
                if (navigator.vibrate) {
                    if (score >= 95) {
                        navigator.vibrate([200, 100, 200, 100, 200]);
                    } else if (score >= 80) {
                        navigator.vibrate([100, 50, 100]);
                    } else if (score >= 60) {
                        navigator.vibrate(100);
                    }
                }
            }
        };

        console.log('✅ ScoreAnimator betöltve');
    </script>

    <!-- ✅ BEÁGYAZOTT VISITOR COUNTER -->
    <script>
        // ✅ BEÁGYAZOTT VISITOR COUNTER OSZTÁLY
        if (!window.VisitorCounter) {
            console.log('🔧 VisitorCounter beágyazása...');
            
            class VisitorCounter {
                static STORAGE_KEY = 'perfectcircle_visits';
                static SESSION_KEY = 'perfectcircle_session';
                static currentCount = 0;
                static globalCount = 0;
                
                static async init() {
                    console.log('👁️ Beágyazott VisitorCounter inicializálása...');
                    
                    try {
                        // Helyi látogatásszám frissítése
                        this.currentCount = this.updateLocalVisitCount();
                        
                        // Firebase látogatás mentése (ha elérhető)
                        if (window.firebaseAPI && window.firebaseAPI.isReady && window.firebaseAPI.isReady()) {
                            await this.saveVisitToFirebase();
                            await this.loadGlobalVisitCount();
                        } else {
                            console.log('📴 Firebase nem elérhető, csak helyi számláló');
                        }
                        
                        console.log('✅ Beágyazott VisitorCounter inicializálva');
                        return true;
                        
                    } catch (error) {
                        console.error('❌ Beágyazott VisitorCounter hiba:', error);
                        throw error;
                    }
                }
                
                static updateLocalVisitCount() {
                    let localVisits = parseInt(localStorage.getItem(this.STORAGE_KEY) || '0');
                    localVisits++;
                    localStorage.setItem(this.STORAGE_KEY, localVisits.toString());
                    
                    // Időpontok mentése
                    if (!localStorage.getItem('perfectcircle_first_visit')) {
                        localStorage.setItem('perfectcircle_first_visit', new Date().toISOString());
                    }
                    localStorage.setItem('perfectcircle_last_visit', new Date().toISOString());
                    
                    // DOM frissítés
                    const visitElement = document.getElementById('visitCount');
                    if (visitElement) {
                        visitElement.textContent = localVisits.toLocaleString('hu-HU');
                    }
                    
                    console.log(`📊 Helyi látogatások: ${localVisits}`);
                    return localVisits;
                }
                
                static async saveVisitToFirebase() {
                    if (!window.firebaseAPI || !window.firebaseAPI.saveVisit) {
                        console.log('📴 Firebase saveVisit nem elérhető');
                        return;
                    }
                    
                    try {
                        const visitData = {
                            timestamp: new Date().toISOString(),
                            date: new Date().toLocaleDateString('hu-HU'),
                            time: new Date().toLocaleTimeString('hu-HU'),
                            sessionId: this.getSessionId(),
                            userAgent: navigator.userAgent.substring(0, 200),
                            language: navigator.language,
                            screen: `${screen.width}x${screen.height}`,
                            viewport: `${window.innerWidth}x${window.innerHeight}`,
                            referrer: (document.referrer || 'közvetlen').substring(0, 200),
                            url: window.location.href,
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            platform: navigator.platform
                        };
                        
                        await window.firebaseAPI.saveVisit(visitData);
                        console.log('✅ Látogatás mentve Firebase-be');
                        
                    } catch (error) {
                        console.error('❌ Firebase látogatás mentési hiba:', error);
                    }
                }
                
                static async loadGlobalVisitCount() {
                    if (!window.firebaseAPI || !window.firebaseAPI.getVisitCount) {
                        console.log('📴 Firebase getVisitCount nem elérhető');
                        return;
                    }
                    
                    try {
                        const globalCount = await window.firebaseAPI.getVisitCount();
                        this.globalCount = globalCount;
                        console.log(`🌍 Globális látogatások: ${globalCount}`);
                        
                    } catch (error) {
                        console.error('❌ Globális látogatásszám lekérési hiba:', error);
                    }
                }
                
                static getSessionId() {
                    let sessionId = sessionStorage.getItem(this.SESSION_KEY);
                    if (!sessionId) {
                        sessionId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                        sessionStorage.setItem(this.SESSION_KEY, sessionId);
                    }
                    return sessionId;
                }
                
                static getCurrentCount() {
                    return this.currentCount;
                }
                
                static getGlobalCount() {
                    return this.globalCount;
                }
                
                static showStats() {
                    const localVisits = localStorage.getItem(this.STORAGE_KEY) || 0;
                    const firstVisit = localStorage.getItem('perfectcircle_first_visit');
                    const lastVisit = localStorage.getItem('perfectcircle_last_visit');
                    
                    let message = `👥 Látogatási statisztikák:\n\n`;
                    message += `🔢 Helyi látogatások: ${localVisits}\n`;
                    
                    if (this.globalCount > 0) {
                        message += `🌍 Globális látogatások: ${this.globalCount.toLocaleString('hu-HU')}\n`;
                    }
                    
                    if (firstVisit) {
                        const firstDate = new Date(firstVisit);
                        message += `🆕 Első látogatás: ${firstDate.toLocaleDateString('hu-HU')}\n`;
                    }
                    
                    if (lastVisit) {
                        const lastDate = new Date(lastVisit);
                        message += `🕐 Utolsó látogatás: ${lastDate.toLocaleDateString('hu-HU')} ${lastDate.toLocaleTimeString('hu-HU')}\n`;
                    }
                    
                    const sessionId = this.getSessionId();
                    message += `🆔 Session ID: ${sessionId.substring(0, 8)}...`;
                    
                    alert(message);
                }
            }
            
            // Globális export
            window.VisitorCounter = VisitorCounter;
            console.log('✅ Beágyazott VisitorCounter létrehozva');
        }
    </script>

    <script src="js/i18n/languageDetector.js"></script>
    <script src="js/i18n/i18nManager.js"></script>
    
    <!-- Firebase Scripts -->
    <script src="js/firebase/firebase-config.js" type="module"></script>
    
    <!-- Utility Scripts -->
    <script src="js/utils/audioManager.js"></script>
    <script src="js/utils/effectsManager.js"></script>
    
    <!-- Game Scripts -->
    <script src="js/game/transformations.js"></script>
    <script src="js/game/circleAnalyzer.js"></script>
    <script src="js/game/gameEngine.js"></script>
    
    <!-- Manager Scripts -->
    <script src="js/managers/scoreManager.js"></script>
    <script src="js/managers/visitorCounter.js"></script>
    <script src="js/managers/leaderboardManager.js"></script>

    <script src="leaderboard-fix.js"></script>

    <!-- Main App Script UTOLJÁRA -->
    <script src="js/app.js" type="module"></script>

    <!-- FIREBASE GLOBÁLIS LEADERBOARD TÁMOGATÁS -->
    <script>
        // Várakozás a Firebase API-ra
        function waitForFirebaseAPI() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100;
                
                const checkAPI = () => {
                    attempts++;
                    
                    if (window.firebaseAPI && typeof window.firebaseAPI.isReady === 'function') {
                        console.log('✅ Firebase API elérhető globális leaderboard-hoz!');
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        console.error('❌ Firebase API timeout!');
                        resolve(false);
                    } else {
                        setTimeout(checkAPI, 100);
                    }
                };
                checkAPI();
            });
        }

        // ✅ JAVÍTOTT GLOBÁLIS LEADERBOARD BETÖLTÉSE
        window.loadGlobalLeaderboard = async function() {
            console.log('🌍 Globális leaderboard betöltése...');
            
            // ✅ AZONNAL BEÁLLÍTJUK A TÍPUST
            window.currentLeaderboardType = 'global';
            
            const leaderboardList = document.getElementById('leaderboardList');
            const leaderboardStatus = document.getElementById('leaderboardStatus');
            
            if (!leaderboardList) return;
            
            // Loading állapot
            leaderboardList.innerHTML = '<div class="score-entry">🔄 Globális eredmények betöltése...</div>';
            if (leaderboardStatus) {
                leaderboardStatus.textContent = '🌍 Globális eredmények betöltése...';
            }
            
            try {
                // Várunk a Firebase API-ra
                const apiReady = await waitForFirebaseAPI();
                
                if (!apiReady || !window.firebaseAPI.isReady()) {
                    throw new Error('Firebase nem elérhető');
                }
                
                // Globális eredmények lekérése
                const globalScores = await window.firebaseAPI.getTopScores(20);
                
                console.log('✅ Globális eredmények betöltve:', globalScores.length);
                
                // ✅ ELLENŐRIZZÜK HOGY MÉG MINDIG GLOBÁLIS MÓDBAN VAGYUNK
                if (window.currentLeaderboardType !== 'global') {
                    console.log('⚠️ Már nem globális módban vagyunk, leállítás...');
                    return;
                }
                
                // Status frissítés
                if (leaderboardStatus) {
                    leaderboardStatus.textContent = `🌍 ${globalScores.length} globális eredmény`;
                }
                
                // Lista megjelenítése
                if (globalScores.length === 0) {
                    leaderboardList.innerHTML = `
                        <div class="score-entry">
                            <span>🌍 Még nincsenek globális eredmények</span>
                        </div>
                    `;
                } else {
                    leaderboardList.innerHTML = globalScores.map((score, index) => {
                        // Dátum formázása
                        let dateText = 'Ma';
                        if (score.timestamp && score.timestamp.seconds) {
                            const date = new Date(score.timestamp.seconds * 1000);
                            dateText = date.toLocaleDateString('hu-HU');
                        } else if (score.date) {
                            dateText = score.date;
                        }
                        
                        // Thumbnail kezelése
                        const thumbnailHTML = score.thumbnail ? 
                            `<div class="thumbnail-container">
                                <img src="${score.thumbnail}" 
                                     class="leaderboard-thumbnail" 
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer;" 
                                     onclick="window.ThumbnailGenerator.showThumbnailModal('${score.thumbnail}')"
                                     title="Kattints a nagyításhoz">
                            </div>` : 
                            `<div class="thumbnail-container">
                                <div class="no-thumbnail" style="width: 40px; height: 40px; background: linear-gradient(45deg, #f0f0f0, #e0e0e0); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">🌍</div>
                            </div>`;
                        
                        return `
                            <div class="leaderboard-entry global-entry" data-score-id="${score.id}">
                                ${thumbnailHTML}
                                <div class="entry-content">
                                    <div class="entry-main">
                                        <span class="rank" style="font-weight: bold; color: #666; min-width: 30px;">#${index + 1}</span>
                                        <span class="name" style="font-weight: 500; color: #333; margin-right: 8px;">${score.playerName || 'Névtelen'}</span>
                                        <span class="score" style="font-weight: bold; color: #4CAF50; margin-left: auto;">${score.score} pont</span>
                                    </div>
                                    <div class="entry-details">
                                        <span style="color: #888;">🌍 ${dateText}</span>
                                        ${score.transformation ? ` • <span style="color: #666;">🎨 ${score.transformation}</span>` : ''}
                                        ${score.difficulty && score.difficulty !== 'easy' ? ` • <span style="color: #ff9800;">🌀 ${score.difficulty}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
            } catch (error) {
                console.error('❌ Globális leaderboard betöltési hiba:', error);
                
                // ✅ ELLENŐRIZZÜK HOGY MÉG MINDIG GLOBÁLIS MÓDBAN VAGYUNK
                if (window.currentLeaderboardType !== 'global') {
                    console.log('⚠️ Már nem globális módban vagyunk, hiba megjelenítés kihagyva...');
                    return;
                }
                
                // Hiba megjelenítése
                leaderboardList.innerHTML = `
                    <div class="score-entry" style="color: #f44336;">
                        <span>❌ Hiba a globális eredmények betöltésekor</span>
                        <div style="font-size: 12px; margin-top: 5px; color: #666;">
                            ${error.message}
                        </div>
                    </div>
                `;
                
                if (leaderboardStatus) {
                    leaderboardStatus.textContent = '❌ Globális eredmények nem elérhetők';
                }
            }
        };

        // Firebase score mentés globálisan
// A showScore függvényben (már van, de ellenőrizzük):
// ✅ JAVÍTOTT - csak átadja az adatot, nem készít új thumbnail-t
window.saveScoreToFirebase = async function(scoreData) {
    try {
        if (!window.firebaseAPI || !window.firebaseAPI.isReady()) {
            console.log('⚠️ Firebase nem elérhető, score nem mentve globálisan');
            return null;
        }
        
        console.log('📤 Firebase mentés indítása:', {
            playerName: scoreData.playerName,
            score: scoreData.score,
            hasThumbnail: !!scoreData.thumbnail,
            thumbnailSize: scoreData.thumbnail ? Math.round(scoreData.thumbnail.length / 1024) + 'KB' : 'nincs'
        });
        
        const result = await window.firebaseAPI.saveScore(scoreData);
        console.log('✅ Score mentve Firebase-be:', result?.id);
        return result;
        
    } catch (error) {
        console.error('❌ Firebase score mentési hiba:', error);
        return null;
    }
};


    </script>

    <!-- Inicializálás -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🌍 DOM betöltve, i18n inicializálás...');
            
            if (window.languageData && window.languageData.hu) {
                window.simpleTranslate = function(key, params = {}) {
                    const keys = key.split('.');
                    let value = window.languageData.hu;
                    
                    for (const k of keys) {
                        if (value && typeof value === 'object' && value[k] !== undefined) {
                            value = value[k];
                        } else {
                            return key;
                        }
                    }
                    
                    if (typeof value === 'string' && params) {
                        Object.keys(params).forEach(param => {
                            value = value.replace(`{${param}}`, params[param]);
                        });
                    }
                    
                    return value;
                };
                
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const translation = window.simpleTranslate(key);
                    
                    if (translation && translation !== key) {
                        if (element.tagName === 'INPUT' && element.type === 'text') {
                            element.placeholder = translation;
                        } else {
                            element.innerHTML = translation;
                        }
                    }
                });
                
                console.log('✅ Egyszerűsített i18n inicializálva');
            }
        });
    </script>

    <!-- ✅ JAVÍTOTT LEADERBOARD FÜGGVÉNYEK -->
    <script>
        // ✅ AUTOMATIKUS LEADERBOARD FRISSÍTŐ THUMBNAILOKKAL - VÉDETT VERZIÓ
        window.refreshLeaderboard = function() {
            try {
                // ✅ ELLENŐRIZZÜK A LEADERBOARD TÍPUST
                if (window.currentLeaderboardType === 'global') {
                    console.log('🛡️ VÉDELEM: refreshLeaderboard blokkolva globális módban');
                    return;
                }
                
                const leaderboardList = document.getElementById('leaderboardList');
                const leaderboardStatus = document.getElementById('leaderboardStatus');
                
                if (!leaderboardList || !window.ScoreManager) return;
                
                const scores = window.ScoreManager.getScores();
                
                // Status frissítés
                if (leaderboardStatus) {
                    leaderboardStatus.textContent = `📱 ${scores.length} helyi eredmény`;
                }
                
                // Lista frissítés
                if (scores.length === 0) {
                    leaderboardList.innerHTML = `
                        <div class="score-entry">
                            <span>Még nincsenek eredmények</span>
                        </div>
                    `;
                } else {
                    leaderboardList.innerHTML = scores.map((score, index) => {
                        const thumbnailHTML = score.thumbnail ? 
                            `<div class="thumbnail-container">
                                <img src="${score.thumbnail}" 
                                     class="leaderboard-thumbnail" 
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer;" 
                                     onclick="window.ThumbnailGenerator.showThumbnailModal('${score.thumbnail}')"
                                     title="Kattints a nagyításhoz">
                            </div>` : 
                            `<div class="thumbnail-container">
                                <div class="no-thumbnail" style="width: 40px; height: 40px; background: linear-gradient(45deg, #f0f0f0, #e0e0e0); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">🎨</div>
                            </div>`;
                        
                        return `
                            <div class="leaderboard-entry local-entry" data-score-id="${score.id}">
                                ${thumbnailHTML}
                                <div class="entry-content">
                                    <div class="entry-main">
                                        <span class="rank" style="font-weight: bold; color: #666; min-width: 30px;">#${index + 1}</span>
                                        <span class="name" style="font-weight: 500; color: #333; margin-right: 8px;">${score.playerName || 'Névtelen'}</span>
                                        <span class="score" style="font-weight: bold; color: #4CAF50; margin-left: auto;">${score.score} pont</span>
                                    </div>
                                    <div class="entry-details">
                                        <span style="color: #888;">${score.date || 'Ma'}</span>
                                        ${score.transformation ? ` • <span style="color: #666;">🎨 ${score.transformation}</span>` : ''}
                                        ${score.difficulty && score.difficulty !== 'easy' ? ` • <span style="color: #ff9800;">🌀 ${score.difficulty}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log(`✅ Leaderboard frissítve thumbnailokkal: ${scores.length} eredmény`);
                
            } catch (error) {
                console.error('❌ Leaderboard frissítési hiba:', error);
            }
        };

        // ✅ FELTÉTELES AUTOMATIKUS FRISSÍTÉS
        let refreshInterval = null;
        
        function startLocalRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (window.currentLeaderboardType === 'local') {
                    window.refreshLeaderboard();
                }
            }, 3000); // 3 másodpercenként
            console.log('✅ Helyi leaderboard automatikus frissítő elindítva');
        }
        
        function stopLocalRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('🛑 Helyi leaderboard automatikus frissítő leállítva');
            }
        }

        // ✅ JAVÍTOTT SWITCHLEADERBOARD FÜGGVÉNY
        window.switchLeaderboard = function(type) {
            console.log('🔄 HTML switchLeaderboard hívás:', type);
            
            // ✅ AZONNAL BEÁLLÍTJUK A TÍPUST
            window.currentLeaderboardType = type;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const targetTab = document.getElementById(type + 'Tab');
            if (targetTab) targetTab.classList.add('active');
            
            const listContainer = document.getElementById('leaderboardList');
            const statusContainer = document.getElementById('leaderboardStatus');
            
            if (statusContainer) {
                statusContainer.textContent = type === 'local' ? '📱 Helyi eredmények' : '🌍 Globális eredmények';
            }
            
            if (listContainer) {
                if (type === 'local') {
                    startLocalRefresh(); // Helyi frissítő bekapcsolása
                    window.refreshLeaderboard();
                } else {
                    stopLocalRefresh(); // Helyi frissítő kikapcsolása
                    window.loadGlobalLeaderboard();
                }
            }
        };

        // Indítás
        setTimeout(startLocalRefresh, 2000);
    </script>

    <!-- SHOWSCORE FELÜLÍRÁSA FIREBASE MENTÉSSEL -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('🔄 showScore felülírása Firebase támogatással...');
                
                // ÚJ showScore függvény Firebase mentéssel
                window.showScore = async function(score, analysis, transformationName = '') {
                    console.log('🏆 ÚJ showScore hívva Firebase mentéssel:', { score, analysis, transformationName });
                    
                    try {
                        // Score validálás
                        const roundedScore = Math.round(Number(score));
                        if (isNaN(roundedScore)) {
                            console.error('❌ Érvénytelen score:', score);
                            return;
                        }
                        
                        // SCORE ANIMÁCIÓ INDÍTÁSA
                        if (window.ScoreAnimator) {
                            window.ScoreAnimator.animateScore(roundedScore, analysis, transformationName);
                            window.ScoreAnimator.vibrate(roundedScore);
                        }
                        
                        // UI elemek frissítése
                        setTimeout(() => {
                            const elements = {
                                scoreDisplay: document.getElementById('scoreDisplay'),
                                finalScore: document.getElementById('finalScore'),
                                currentScore: document.getElementById('currentScore'),
                                scoreBreakdown: document.getElementById('scoreBreakdown')
                            };
                            
                            if (elements.finalScore) elements.finalScore.textContent = roundedScore;
                            if (elements.currentScore) elements.currentScore.textContent = roundedScore;
                            
                            if (elements.scoreBreakdown && analysis) {
                                let breakdownHTML = '';
                                if (analysis.shape !== undefined) breakdownHTML += `<div>🔵 Köralak: ${Math.round(analysis.shape)}/40</div>`;
                                if (analysis.closure !== undefined) breakdownHTML += `<div>🔗 Záródás: ${Math.round(analysis.closure)}/20</div>`;
                                if (analysis.smoothness !== undefined) breakdownHTML += `<div>🌊 Egyenletesség: ${Math.round(analysis.smoothness)}/25</div>`;
                                if (analysis.size !== undefined) breakdownHTML += `<div>📏 Méret: ${Math.round(analysis.size)}/15</div>`;
                                elements.scoreBreakdown.innerHTML = breakdownHTML;
                            }
                            
                            if (elements.scoreDisplay) {
                                elements.scoreDisplay.style.display = 'block';
                                elements.scoreDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 2500);
                        
                        // THUMBNAIL KÉSZÍTÉSE ÉS MENTÉS
                        if (roundedScore > 0 && window.ScoreManager && window.ThumbnailGenerator) {
                            console.log('💾 Score mentése thumbnaillal és Firebase-be...');
                            
                            const thumbnail = await window.ThumbnailGenerator.captureTransformationThumbnail(1000);
                            const difficulty = window.gameEngine?.getDifficulty() || 'easy';
                            const playerName = document.getElementById('playerName')?.value?.trim() || 'Névtelen';
                            
                            // Helyi mentés
                            let savedScore;
                            if (window.ScoreManager.saveScore.length >= 5) {
                                savedScore = window.ScoreManager.saveScore(
                                    roundedScore,
                                    analysis,
                                    difficulty,
                                    transformationName,
                                    thumbnail
                                );
                            } else {
                                savedScore = window.ScoreManager.saveScore(
                                    roundedScore,
                                    analysis,
                                    difficulty,
                                    transformationName
                                );
                                
                                if (thumbnail && savedScore && savedScore.id) {
                                    const scores = window.ScoreManager.getScores();
                                    const scoreIndex = scores.findIndex(s => s.id === savedScore.id);
                                    if (scoreIndex !== -1) {
                                        scores[scoreIndex].thumbnail = thumbnail;
                                        localStorage.setItem('perfectcircle_scores', JSON.stringify(scores));
                                    }
                                }
                            }
                            
                            // Firebase mentés
                            const firebaseData = {
                                playerName: playerName,
                                score: roundedScore,
                                difficulty: difficulty,
                                transformation: transformationName,
                                thumbnail: thumbnail
                            };
                            
                            const firebaseResult = await window.saveScoreToFirebase(firebaseData);
                            if (firebaseResult) {
                                console.log('✅ Score mentve Firebase-be is:', firebaseResult);
                            }
                            
                            console.log('✅ Score mentve thumbnaillal:', savedScore);
                            
                            // Thumbnail megjelenítése
                            setTimeout(() => {
                                const scoreDisplay = document.getElementById('scoreDisplay');
                                if (thumbnail && scoreDisplay) {
                                    window.ThumbnailGenerator.displayThumbnail(thumbnail, 'scoreDisplay', 'current-score-thumbnail');
                                }
                            }, 3000);
                            
                            // ✅ LEADERBOARD FRISSÍTÉSE - CSAK HELYI MÓDBAN
                            setTimeout(() => {
                                if (window.currentLeaderboardType === 'local') {
                                    window.refreshLeaderboard();
                                    console.log('🔄 Helyi leaderboard frissítve showScore után');
                                } else {
                                    console.log('🌍 Globális módban vagyunk, helyi leaderboard frissítés kihagyva');
                                }
                            }, 100);
                            
                            // Statisztikák frissítése
                            setTimeout(() => {
                                if (window.updateStats) {
                                    window.updateStats();
                                }
                            }, 200);
                        }
                        
                    } catch (error) {
                        console.error('❌ showScore hiba:', error);
                    }
                };
                
                console.log('✅ showScore sikeresen felülírva Firebase támogatással');
                
            }, 1000);
        });
    </script>

    <!-- ✅ VISITOR COUNTER INICIALIZÁLÁS -->
    <script>
        // ✅ VISITOR COUNTER INICIALIZÁLÁS - JAVÍTOTT VERZIÓ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 VisitorCounter inicializálás indítása...');
            
            // Várjunk egy kicsit, hogy minden script betöltődjön
            setTimeout(() => {
                initVisitorCounterWithRetry();
            }, 2000);
        });
        
        function initVisitorCounterWithRetry() {
            let attempts = 0;
            const maxAttempts = 20; // Csökkentve
            
            const tryInit = () => {
                attempts++;
                console.log(`🔄 VisitorCounter kísérlet ${attempts}/${maxAttempts}...`);
                
                // Ellenőrizzük hogy létezik-e a VisitorCounter
                if (window.VisitorCounter) {
                    console.log('✅ VisitorCounter megtalálva!');
                    console.log('- Típus:', typeof window.VisitorCounter);
                    console.log('- Init metódus:', typeof window.VisitorCounter.init);
                    
                    if (typeof window.VisitorCounter.init === 'function') {
                        console.log('🚀 VisitorCounter.init() hívása...');
                        
                        window.VisitorCounter.init()
                            .then(() => {
                                console.log('✅ VisitorCounter sikeresen inicializálva!');
                            })
                            .catch(error => {
                                console.error('❌ VisitorCounter init hiba:', error);
                                startFallbackCounter();
                            });
                        return;
                    } else {
                        console.error('❌ VisitorCounter.init nem függvény!');
                    }
                }
                
                // Ha még nem érhető el és van még kísérlet
                if (attempts < maxAttempts) {
                    setTimeout(tryInit, 200);
                } else {
                    console.warn('⚠️ VisitorCounter nem található, fallback indítása...');
                    startFallbackCounter();
                }
            };
            
            tryInit();
        }
        
        function startFallbackCounter() {
            console.log('🔄 Fallback visitor counter indítása...');
            
            try {
                let visits = parseInt(localStorage.getItem('perfectcircle_visits') || '0');
                visits++;
                localStorage.setItem('perfectcircle_visits', visits.toString());
                localStorage.setItem('perfectcircle_last_visit', new Date().toISOString());
                
                if (!localStorage.getItem('perfectcircle_first_visit')) {
                    localStorage.setItem('perfectcircle_first_visit', new Date().toISOString());
                }
                
                const visitCountElement = document.getElementById('visitCount');
                if (visitCountElement) {
                    visitCountElement.textContent = visits;
                    console.log('✅ Visitor count frissítve DOM-ban:', visits);
                } else {
                    console.error('❌ visitCount elem nem található!');
                }
                
                console.log('👥 Fallback látogatásszámláló inicializálva:', visits);
                
            } catch (error) {
                console.error('❌ Fallback counter hiba:', error);
            }
        }
    </script>

    <!-- EGYÉB SEGÉDFÜGGVÉNYEK -->
    <script>
        window.updateStats = function() {
            console.log('📊 updateStats called');
            
            if (window.ScoreManager) {
                const stats = window.ScoreManager.getStats();
                
                const currentScore = document.getElementById('currentScore');
                const bestScore = document.getElementById('bestScore');
                const gamesPlayed = document.getElementById('gamesPlayed');
                const averageScore = document.getElementById('averageScore');
                
                if (currentScore) currentScore.textContent = stats.currentScore || 0;
                if (bestScore) bestScore.textContent = stats.best || 0;
                if (gamesPlayed) gamesPlayed.textContent = stats.games || 0;
                if (averageScore) averageScore.textContent = Math.round(stats.average) || 0;
                
                console.log('✅ Statisztikák frissítve:', stats);
            } else {
                console.log('⚠️ ScoreManager nem elérhető');
            }
        };

        window.showVisitStats = function() {
            console.log('📊 Látogatási statisztikák lekérése...');
            
            if (window.VisitorCounter && typeof window.VisitorCounter.showStats === 'function') {
                // Firebase-alapú statisztikák
                window.VisitorCounter.showStats();
            } else {
                // Fallback helyi statisztikák
                const visitCount = localStorage.getItem('perfectcircle_visits') || 0;
                const firstVisit = localStorage.getItem('perfectcircle_first_visit');
                const lastVisit = localStorage.getItem('perfectcircle_last_visit');
                
                let message = `👥 Helyi látogatási statisztikák:\n\n`;
                message += `🔢 Helyi látogatások: ${visitCount}\n`;
                
                if (firstVisit) {
                    const firstDate = new Date(firstVisit);
                    message += `🆕 Első helyi látogatás: ${firstDate.toLocaleDateString('hu-HU')}\n`;
                }
                
                if (lastVisit) {
                    const lastDate = new Date(lastVisit);
                    message += `🕐 Utolsó látogatás: ${lastDate.toLocaleDateString('hu-HU')} ${lastDate.toLocaleTimeString('hu-HU')}\n\n`;
                }
                
                message += `⚠️ Firebase látogatásszámláló nem elérhető.`;
                
                alert(message);
            }
        };

        window.setDifficulty = function(level) {
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-difficulty="${level}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            localStorage.setItem('perfectcircle_difficulty', level);
            
            if (window.gameEngine && window.gameEngine.setDifficulty) {
                window.gameEngine.setDifficulty(level);
            }
            
            console.log(`✅ Nehézség beállítva: ${level}`);
        };
    </script>

    <!-- ✅ VISITOR COUNTER DEBUG -->
    <script>
        // ✅ VISITOR COUNTER DEBUG
        window.debugVisitorCounter = function() {
            console.log('🔍 === VISITOR COUNTER DEBUG ===');
            console.log('- window.VisitorCounter:', !!window.VisitorCounter);
            console.log('- VisitorCounter típusa:', typeof window.VisitorCounter);
            console.log('- VisitorCounter.init:', typeof window.VisitorCounter?.init);
            
            if (window.VisitorCounter) {
                console.log('- VisitorCounter metódusok:', Object.getOwnPropertyNames(window.VisitorCounter));
            }
            
            // Script fájlok ellenőrzése
            const scripts = Array.from(document.querySelectorAll('script[src]'));
            const visitorScript = scripts.find(s => s.src.includes('visitorCounter'));
            console.log('- VisitorCounter script betöltve:', !!visitorScript);
            
            if (visitorScript) {
                console.log('- Script src:', visitorScript.src);
                console.log('- Script loaded:', !visitorScript.hasAttribute('async') || visitorScript.readyState === 'complete');
            }
            
            // Helyi adatok
            const localVisits = localStorage.getItem('perfectcircle_visits');
            console.log('- Helyi látogatások:', localVisits);
            
            // DOM elem
            const visitElement = document.getElementById('visitCount');
            console.log('- Visit count elem:', !!visitElement);
            console.log('- Jelenlegi érték:', visitElement?.textContent);
            
            console.log('=== DEBUG VÉGE ===');
        };
        
        // Automatikus debug 3 másodperc után
        setTimeout(() => {
            console.log('🔍 Automatikus VisitorCounter debug...');
            window.debugVisitorCounter();
        }, 3000);
    </script>

    <!-- EMERGENCY BUTTON HANDLERS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Emergency button handlers loading...');
            
            // Leaderboard tabok
            const localTab = document.getElementById('localTab');
            const globalTab = document.getElementById('globalTab');
            
            if (localTab) {
                localTab.addEventListener('click', function() {
                    console.log('Local tab clicked');
                    window.switchLeaderboard('local');
                });
            }
            
            if (globalTab) {
                globalTab.addEventListener('click', function() {
                    console.log('Global tab clicked');
                    window.switchLeaderboard('global');
                });
            }
            
            // Start gomb
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    console.log('Start button clicked');
                    if (window.gameEngine && typeof window.gameEngine.startDrawing === 'function') {
                        window.gameEngine.startDrawing();
                    } else {
                        console.log('GameEngine not ready');
                    }
                });
            }
            
            // Clear gomb
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    console.log('Clear button clicked');
                    if (window.gameEngine && typeof window.gameEngine.clearCanvas === 'function') {
                        window.gameEngine.clearCanvas();
                    } else {
                        console.log('GameEngine not ready');
                    }
                });
            }
            
            // Help gomb
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', function() {
                    console.log('Help button clicked');
                    alert('🎯 PERFECT CIRCLE\n\nRajzolj tökéletes kört egyetlen mozdulattal!\n\n🎮 Irányítás:\n• Egér: Kattints és húzd\n• Mobil: Érintsd és húzd\n\n🏆 Pontszámítás:\n• Köralak (40p)\n• Záródás (20p)\n• Egyenletesség (25p)\n• Méret (15p)\n\nSok sikert! 🍀');
                });
            }
            
            // Save Name gomb
            const saveNameBtn = document.getElementById('saveNameBtn');
            if (saveNameBtn) {
                saveNameBtn.addEventListener('click', function() {
                    console.log('Save name button clicked');
                    const input = document.getElementById('playerName');
                    const name = input ? input.value.trim() : '';
                    if (name) {
                        localStorage.setItem('perfectcircle_playername', name);
                        alert('Név mentve: ' + name + ' ✅');
                    } else {
                        alert('Kérlek add meg a neved! ❌');
                    }
                });
            }
            
            // Clear Scores gomb
            const clearScoresBtn = document.getElementById('clearScoresBtn');
            if (clearScoresBtn) {
                clearScoresBtn.addEventListener('click', function() {
                    console.log('Clear scores button clicked');
                    if (confirm('Biztosan törölni szeretnéd az összes helyi eredményt?')) {
                        if (window.ScoreManager && window.ScoreManager.clearScores) {
                            window.ScoreManager.clearScores();
                            alert('Helyi eredmények törölve! ✅');
                            
                            // Statisztikák frissítése
                            if (window.updateStats) {
                                window.updateStats();
                            }
                            
                            // Leaderboard frissítése
                            if (window.currentLeaderboardType === 'local') {
                                window.refreshLeaderboard();
                            }
                        } else {
                            alert('ScoreManager nem elérhető! ❌');
                        }
                    }
                });
            }
            
            console.log('✅ Emergency button handlers loaded');
        });

        // Emergency global functions
        window.startDrawing = function() {
            console.log('Global startDrawing called');
            if (window.gameEngine && window.gameEngine.startDrawing) {
                window.gameEngine.startDrawing();
            } else {
                console.log('GameEngine not ready for startDrawing');
            }
        };

        window.clearCanvas = function() {
            console.log('Global clearCanvas called');
            if (window.gameEngine && window.gameEngine.clearCanvas) {
                window.gameEngine.clearCanvas();
            } else {
                console.log('GameEngine not ready for clearCanvas');
            }
        };

        window.showInstructions = function() {
            console.log('Global showInstructions called');
            alert('🎯 PERFECT CIRCLE\n\nRajzolj tökéletes kört egyetlen mozdulattal!');
        };

        window.savePlayerName = function() {
            console.log('Global savePlayerName called');
            const input = document.getElementById('playerName');
            const name = input ? input.value.trim() : '';
            if (name) {
                localStorage.setItem('perfectcircle_playername', name);
                alert('Név mentve: ' + name);
                return true;
            } else {
                alert('Add meg a neved!');
                return false;
            }
        };

        window.clearAllScores = function() {
            console.log('Global clearAllScores called');
            if (confirm('Biztosan törölni szeretnéd az összes helyi eredményt?')) {
                if (window.ScoreManager && window.ScoreManager.clearScores) {
                    window.ScoreManager.clearScores();
                    alert('Helyi eredmények törölve!');
                    if (window.currentLeaderboardType === 'local') {
                        window.refreshLeaderboard();
                    }
                } else {
                    alert('ScoreManager nem elérhető!');
                }
            }
        };
    </script>

</body>
</html>
