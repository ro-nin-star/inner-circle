<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Perfect Circle - Rajzolj TÃ¶kÃ©letes KÃ¶rt!</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- âœ… GLOBÃLIS LEADERBOARD TÃPUS KÃ–VETÃ‰SE - HTML SZINTEN -->
    <script>
        window.currentLeaderboardType = 'local';
        console.log('ğŸ”§ HTML szintÅ± leaderboard tÃ­pus beÃ¡llÃ­tva:', window.currentLeaderboardType);
    </script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

</head>

<body>

<!-- JÃTÃ‰KMÃ“D VÃLASZTÃ“ MODAL -->
<div id="gameModeModal" class="game-mode-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ¯ VÃ¡lassz JÃ¡tÃ©kmÃ³dot!</h2>
            <p>Melyik kihÃ­vÃ¡st szeretnÃ©d kiprÃ³bÃ¡lni?</p>
        </div>
        
        <div class="mode-selection">
            <div class="mode-card" onclick="selectGameMode('circle')">
                <div class="mode-icon">ğŸ¯</div>
                <h3>Verseny MÃ³d</h3>
                <p>Rajzolj tÃ¶kÃ©letes kÃ¶rÃ¶ket Ã©s versenyezz mÃ¡sokkal!</p>
                <ul>
                    <li>âœ¨ KÃ¶rrajzolÃ¡s kihÃ­vÃ¡s</li>
                    <li>ğŸ† GlobÃ¡lis ranglista</li>
                    <li>ğŸ¨ VarÃ¡zslatos transzformÃ¡ciÃ³k</li>
                    <li>âš¡ Gyors jÃ¡tÃ©kmenet</li>
                </ul>
                <button class="mode-select-btn">Verseny IndÃ­tÃ¡sa</button>
            </div>
            
            <div class="mode-card" onclick="selectGameMode('drawing')">
                <div class="mode-icon">ğŸ¨</div>
                <h3>Rajz MÃ³d</h3>
                <p>KÃ¶vesd le kÃ¼lÃ¶nbÃ¶zÅ‘ alakzatokat idÅ‘re!</p>
                <ul>
                    <li>ğŸ“ KÃ¼lÃ¶nbÃ¶zÅ‘ alakzatok</li>
                    <li>â±ï¸ IdÅ‘mÃ©rÃ©s</li>
                    <li>ğŸ¯ ProgresszÃ­v nehÃ©zsÃ©g</li>
                    <li>ğŸ… TeljesÃ­tmÃ©ny kÃ¶vetÃ©s</li>
                </ul>
                <button class="mode-select-btn">Rajz KezdÃ©se</button>
            </div>
        </div>
        
        <div class="modal-footer">
            <p><small>ğŸ’¡ BÃ¡rmikor vÃ¡lthat a mÃ³dok kÃ¶zÃ¶tt a beÃ¡llÃ­tÃ¡sokban</small></p>
        </div>
    </div>
</div>


    <!-- JÃ¡tÃ©kos animÃ¡lt hÃ¡ttÃ©r elemek -->
    <div class="decoration-circle"></div>
    <div class="decoration-circle"></div>
    <div class="decoration-circle"></div>

    <!-- ===== JÃTÃ‰KOS FELSÅ FIX FEJLÃ‰C ===== -->
    <div class="top-fixed-header">
        <!-- Firebase Status -->
        <div class="firebase-status connecting" id="firebaseStatus" data-i18n="firebase.connecting">ğŸŸ¡ KapcsolÃ³dÃ¡s...</div>
        <!-- Nyelv vÃ¡ltÃ³ -->
        <div class="language-selector" id="languageSelector">
            <div class="current-language" onclick="window.i18nManager?.toggleLanguageMenu()">
                <span id="currentLanguageFlag">ğŸ‡­ğŸ‡º</span>
                <span id="currentLanguageCode">HU</span>
            </div>
            <div class="language-menu" id="languageMenu">
                <!-- Dinamikusan tÃ¶ltÅ‘dik a JavaScript Ã¡ltal -->
            </div>
        </div>
    </div>
    <!-- ==================================================== -->

    <div class="game-container" id="gameContainer">
        <h1 data-i18n="title">ğŸ¯ Perfect Circle</h1>
        <p class="subtitle" data-i18n="subtitle">Rajzolj a lehetÅ‘ legtÃ¶kÃ©letesebb kÃ¶rt egyetlen mozdulattal!</p>
        
        <div class="instructions">
            <strong data-i18n="instructions.title">ğŸ® Hogyan jÃ¡tssz:</strong> 
            <span data-i18n="instructions.text">Kattints Ã©s hÃºzd az egeret (vagy Ã©rintsd Ã©s hÃºzd az ujjad) hogy egy kÃ¶rt rajzolj. MinÃ©l tÃ¶kÃ©letesebb a kÃ¶rÃ¶d, annÃ¡l tÃ¶bb pontot kapsz! A kÃ¶r varÃ¡zslatos mÃ³don Ã¡t fog vÃ¡ltozni! âœ¨</span>
        </div>

        <!-- Offline notice -->
        <div class="offline-notice" id="offlineNotice" style="display: none;">
            <span data-i18n="firebase.offlineNotice">âš ï¸ <strong>Offline mÃ³d:</strong> A globÃ¡lis ranglista nem elÃ©rhetÅ‘. Az eredmÃ©nyek helyben mentÅ‘dnek.</span>
        </div>

        <!-- PLAYER NAME SECTION Ã‰S NEHÃ‰ZSÃ‰G VÃLASZTÃ“ EGY SORBAN -->
        <div class="player-difficulty-row">
            <div class="player-name-section">
                <label for="playerName"><strong data-i18n="player.label">NÃ©v:</strong></label>
                <input type="text" id="playerName" class="player-name-input" data-i18n="player.placeholder" placeholder="Add meg a neved" maxlength="20" value="">
                <button id="saveNameBtn" data-i18n="buttons.save">ğŸ’¾ MentÃ©s</button>
            </div>

            <div class="difficulty-selector">
                <strong data-i18n="difficulty.label">ğŸ¯ NehÃ©zsÃ©g:</strong><br>
                <button class="difficulty-btn active" onclick="setDifficulty('easy')" data-difficulty="easy" data-i18n="difficulty.easy">KÃ¶nnyÅ± ğŸ˜Š</button>
                <button class="difficulty-btn" onclick="setDifficulty('hard')" data-difficulty="hard" data-i18n="difficulty.hard">NehÃ©z ğŸŒ€</button>
            </div>
        </div>
<!-- ğŸ¯ RAJZOLÃS GOMB - FELÃœL -->

<!-- âœ… JAVÃTOTT STATISZTIKÃK HTML -->
<div class="stats-container">
    <div class="stat-item">
        <div class="stat-label">Jelenlegi</div>
        <div class="stat-value" id="currentScore">0</div>
    </div>
    <div class="stat-item">
        <div class="stat-label">Legjobb</div>
        <div class="stat-value" id="bestScore">0</div>
    </div>
    <div class="stat-item">
        <div class="stat-label">JÃ¡tÃ©kok</div>
        <div class="stat-value" id="gamesPlayed">0</div>
    </div>
    <div class="stat-item">
        <div class="stat-label">Ãtlag</div>
        <div class="stat-value" id="averageScore">0</div>
    </div>
</div>


        <!-- âœ… NÃ‰GYZETES CANVAS CONTAINER -->
        <div class="canvas-container">
            <canvas id="gameCanvas" width="460" height="460"></canvas>
            <canvas id="idealCircleCanvas" width="460" height="460"></canvas>
            <div class="canvas-overlay" id="canvasOverlay"></div>
            <div class="transformation-overlay" id="transformationOverlay">
                <div class="transformation-content">
                    <h2 id="transformationText" data-i18n="transformation.magic">âœ¨ VarÃ¡zslat tÃ¶rtÃ©nik... âœ¨</h2>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" data-i18n="buttons.startDrawing" >ğŸ¯ RajzolÃ¡s KezdÃ©se</button>
            <button id="clearBtn" disabled data-i18n="buttons.clear">ğŸ—‘ï¸ TÃ¶rlÃ©s</button>
            <button id="helpBtn" data-i18n="buttons.help">â“ SegÃ­tsÃ©g</button>
            <button id="clearScoresBtn" data-i18n="buttons.clearScores">ğŸ—‘ï¸ Helyi EredmÃ©nyek TÃ¶rlÃ©se</button>
            <button id="guideBtn" onclick="window.toggleCanvasGuide?.()" data-i18n="buttons.guide">ğŸ“ SegÃ©dvonal</button>
            <button id="switchModeBtn" onclick="window.GameModeManager?.showModeSelector()" data-i18n="buttons.switchMode">ğŸ”„ MÃ³d VÃ¡ltÃ¡s</button>

        </div>

        <!-- PontszÃ¡m megjelenÃ­tÅ‘ -->
        <div class="score-display" id="scoreDisplay" style="display: none;">
            <h3 id="scoreTitle" data-i18n="scoreTitle.result">ğŸ† EredmÃ©ny</h3>
            <div class="score-number">
                <span id="finalScore">0</span>/100 <span data-i18n="common.points">pont</span>
            </div>
            <div class="score-breakdown" id="scoreBreakdown">
                <!-- Dinamikusan tÃ¶ltÅ‘dik -->
            </div>
            
            <!-- IdeÃ¡lis kÃ¶r Ã¶sszehasonlÃ­tÃ¡s -->
            <div id="idealCircleContainer" class="ideal-circle-container" style="display: none;">
                <h4 data-i18n="analysis.idealCircle">IdeÃ¡lis kÃ¶r Ã¶sszehasonlÃ­tÃ¡s:</h4>
                <div class="ideal-circle-canvas-container">
                    <canvas id="idealComparisonCanvas" width="200" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD WITH TABS -->
        <div class="leaderboard">
            <h3 data-i18n="leaderboard.title">ğŸ† Ranglista</h3>
            <div class="leaderboard-tabs">
                <button id="localTab" class="tab-btn active">
                    ğŸ“± Helyi
                </button>
                <button id="globalTab" class="tab-btn">
                    ğŸŒ GlobÃ¡lis
                </button>
            </div>

            <div class="leaderboard-status" id="leaderboardStatus" data-i18n="leaderboard.localResults">
                ğŸ“± Helyi eredmÃ©nyek
            </div>
            <div id="leaderboardList">
                <div class="score-entry">
                    <span data-i18n="leaderboard.noResults">MÃ©g nincsenek eredmÃ©nyek</span>
                </div>
            </div>
        </div>

        <!-- RÃ©szletes instrukciÃ³k -->
        <div class="detailed-instructions">
            <h3 data-i18n="instructions.detailedTitle">ğŸ“– RÃ©szletes ÃštmutatÃ³</h3>
            <div class="instruction-section">
                <h4 data-i18n="instructions.gameplayTitle">ğŸ® JÃ¡tÃ©kmenet:</h4>
                <ul>
                    <li data-i18n="instructions.step1">Kattints a "RajzolÃ¡s KezdÃ©se" gombra</li>
                    <li data-i18n="instructions.step2">Rajzolj egy kÃ¶rt egyetlen mozdulattal</li>
                    <li data-i18n="instructions.step3">NÃ©zd meg az eredmÃ©nyed Ã©s a transzformÃ¡ciÃ³t!</li>
                </ul>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.scoringTitle">ğŸ“Š PontszÃ¡mÃ­tÃ¡s:</h4>
                <ul>
                    <li data-i18n="instructions.shapeScore">ğŸ”µ KÃ¶ralak (40 pont): Mennyire hasonlÃ­t kÃ¶rre</li>
                    <li data-i18n="instructions.closureScore">ğŸ”— ZÃ¡rÃ³dÃ¡s (20 pont): Mennyire zÃ¡rt a forma</li>
                    <li data-i18n="instructions.smoothnessScore">ğŸŒŠ EgyenletessÃ©g (25 pont): Mennyire egyenletes a vonal</li>
                    <li data-i18n="instructions.sizeScore">ğŸ“ MÃ©ret (15 pont): OptimÃ¡lis mÃ©ret hasznÃ¡lata</li>
                </ul>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.transformationsTitle">ğŸ¨ TranszformÃ¡ciÃ³k:</h4>
                <p data-i18n="instructions.transformationsText">70+ pont esetÃ©n a kÃ¶rÃ¶d varÃ¡zslatos alakzattÃ¡ vÃ¡ltozik! Minden transzformÃ¡ciÃ³ utÃ¡n egy mosolygÃ³ arc jelenik meg! ğŸ˜Š</p>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.controlsTitle">âŒ¨ï¸ BillentyÅ± parancsok:</h4>
                <ul>
                    <li data-i18n="instructions.ctrlS">Ctrl+S: RajzolÃ¡s kezdÃ©se</li>
                    <li data-i18n="instructions.ctrlR">Ctrl+R: TÃ¶rlÃ©s</li>
                    <li data-i18n="instructions.ctrlH">Ctrl+H: SegÃ­tsÃ©g</li>
                    <li data-i18n="instructions.ctrlL">Ctrl+L: Nyelv menÃ¼</li>
                    <li data-i18n="instructions.escape">Esc: JÃ¡tÃ©k megszakÃ­tÃ¡sa</li>
                    <li data-i18n="instructions.f1">F1: SegÃ­tsÃ©g</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- LÃ¡togatÃ¡sszÃ¡mlÃ¡lÃ³ -->
    <div class="visitor-counter" id="visitorCounter" onclick="showVisitStats()">
        <span data-i18n="visitors.label">ğŸ‘¥ LÃ¡togatÃ¡sok:</span> <span class="visitor-number" id="visitCount">0</span>
    </div>

    <!-- FejlesztÅ‘i informÃ¡ciÃ³k -->
    <div class="dev-info">
        <span data-i18n="dev.version">v2.1</span> | 
        <span onclick="window.debugGameEngine?.()" data-i18n="dev.debug">Debug</span>
    </div>
<!-- JÃTÃ‰KMÃ“D KEZELÅ -->
<!-- JAVÃTOTT JÃTÃ‰KMÃ“D KEZELÅ -->
<!-- JAVÃTOTT JÃTÃ‰KMÃ“D KEZELÅ - TIMER CSAK RAJZOLÃS KEZDÃ‰SEKOR -->
<script>
// INTELLIGENS ALAKZAT FELISMERÅ JÃTÃ‰KMÃ“D KEZELÅ
window.GameModeManager = {
    currentMode: 'circle',
    drawingMode: {
        currentLevel: 1,
        currentShape: null,
        startTime: null,
        timeLimit: 30,
        timer: null,
        isActive: false,
        shapes: [
            { 
                name: 'NÃ©gyzet', 
                icon: 'â¬œ', 
                points: [[0.2,0.2], [0.8,0.2], [0.8,0.8], [0.2,0.8], [0.2,0.2]],
                type: 'rectangle',
                minCorners: 4,
                expectedAngles: [90, 90, 90, 90]
            },
            { 
                name: 'HÃ¡romszÃ¶g', 
                icon: 'ğŸ”º', 
                points: [[0.5,0.2], [0.8,0.8], [0.2,0.8], [0.5,0.2]],
                type: 'triangle',
                minCorners: 3,
                expectedAngles: [60, 60, 60]
            },
            { 
                name: 'KÃ¶r', 
                icon: 'â­•', 
                points: [], // KÃ¶r esetÃ©n nincs szÃ¼ksÃ©g pontokra
                type: 'circle',
                minCorners: 0,
                expectedAngles: []
            },
            { 
                name: 'Csillag', 
                icon: 'â­', 
                points: [[0.5,0.1], [0.6,0.4], [0.9,0.4], [0.7,0.6], [0.8,0.9], [0.5,0.7], [0.2,0.9], [0.3,0.6], [0.1,0.4], [0.4,0.4], [0.5,0.1]],
                type: 'star',
                minCorners: 10,
                expectedAngles: []
            },
            { 
                name: 'SzÃ­v', 
                icon: 'â¤ï¸', 
                points: [[0.5,0.3], [0.4,0.2], [0.3,0.2], [0.2,0.3], [0.2,0.4], [0.3,0.5], [0.5,0.8], [0.7,0.5], [0.8,0.4], [0.8,0.3], [0.7,0.2], [0.6,0.2], [0.5,0.3]],
                type: 'heart',
                minCorners: 0,
                expectedAngles: []
            }
        ],
        completedShapes: 0,
        totalTime: 0
    },
    
    showModeSelector: function() {
        const modal = document.getElementById('gameModeModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    },
    
    selectMode: function(mode) {
        console.log(`ğŸ”„ MÃ³d vÃ¡ltÃ¡s: ${mode}`);
        this.currentMode = mode;
        localStorage.setItem('perfectcircle_gamemode', mode);
        
        const modal = document.getElementById('gameModeModal');
        if (modal) {
            modal.style.display = 'none';
        }
        
        if (mode === 'drawing') {
            this.initDrawingMode();
        } else {
            this.initCircleMode();
        }
    },
    
initDrawingMode: function() {
    console.log('ğŸ¨ Rajz mÃ³d inicializÃ¡lÃ¡sa...');
    
    // âœ… CANVAS TELJES TISZTÃTÃSA
    this.clearAllCanvas();
    
    // âœ… GAMEENGINE LEÃLLÃTÃSA
    if (window.gameEngine && window.gameEngine.reset) {
        window.gameEngine.reset();
    }
    
    document.body.classList.add('drawing-mode-active');
    this.createDrawingModeUI();
    this.startNewChallenge();
    this.setupDrawingDetection();
    this.blockOriginalShowScore();
},

    
    initCircleMode: function() {
        console.log('ğŸ¯ Verseny mÃ³d inicializÃ¡lÃ¡sa...');
        document.body.classList.remove('drawing-mode-active');
        this.removeDrawingModeUI();
        this.restoreOriginalShowScore();
    },
    clearAllCanvas: function() {
    // FÅ‘ canvas
    const canvas = document.getElementById('gameCanvas');
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // âœ… CANVAS RESET
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.globalAlpha = 1;
        ctx.globalCompositeOperation = 'source-over';
    }
    
    // IdeÃ¡lis kÃ¶r canvas
    const idealCanvas = document.getElementById('idealCircleCanvas');
    if (idealCanvas) {
        const idealCtx = idealCanvas.getContext('2d');
        idealCtx.clearRect(0, 0, idealCanvas.width, idealCanvas.height);
    }
    
    // TranszformÃ¡ciÃ³ overlay elrejtÃ©se
    const transformationOverlay = document.getElementById('transformationOverlay');
    if (transformationOverlay) {
        transformationOverlay.style.display = 'none';
    }
    
    console.log('ğŸ§¹ Minden canvas megtisztÃ­tva');
},
restoreOriginalShowScore: function() {
    if (this.originalShowScore) {
        window.showScore = this.originalShowScore;
        console.log('ğŸ”„ Eredeti showScore visszaÃ¡llÃ­tva');
    }
    
    // âœ… CANVAS ESEMÃ‰NYEK VISSZAÃLLÃTÃSA
    const canvas = document.getElementById('gameCanvas');
    if (canvas) {
        canvas.style.pointerEvents = 'auto';
    }
    
    // âœ… GAMEENGINE ÃšJRAINDÃTÃSA
    if (window.gameEngine && window.gameEngine.init) {
        setTimeout(() => {
            window.gameEngine.init();
        }, 100);
    }
},

blockOriginalShowScore: function() {
    if (!this.originalShowScore) {
        this.originalShowScore = window.showScore;
    }
    
    // âœ… ÃšJ: gameEngine rajzolÃ¡s blokkolÃ¡sa is
    if (!this.originalGameEngineEvents && window.gameEngine) {
        this.originalGameEngineEvents = true;
        
        // Blokkolja a gameEngine canvas esemÃ©nyeit
        const canvas = document.getElementById('gameCanvas');
        if (canvas) {
            // EltÃ¡volÃ­tja az Ã¶sszes gameEngine esemÃ©nykezelÅ‘t
            canvas.style.pointerEvents = 'none';
            
            // Majd visszaadja csak a rajz mÃ³d esemÃ©nyeit
            setTimeout(() => {
                canvas.style.pointerEvents = 'auto';
            }, 100);
        }
    }
    
    window.showScore = function(score, analysis, transformationName = '') {
        console.log('ğŸš« showScore blokkolva rajz mÃ³dban:', score);
        return;
    };
    
    console.log('ğŸš« Eredeti showScore Ã©s gameEngine blokkolva rajz mÃ³dban');
},

    createDrawingModeUI: function() {
        if (document.getElementById('shapeChallenge')) return;
        
        const statsContainer = document.querySelector('.stats-container');
        if (!statsContainer) return;
        
        const challengeDiv = document.createElement('div');
        challengeDiv.id = 'shapeChallenge';
        challengeDiv.className = 'shape-challenge';
        challengeDiv.innerHTML = `
            <h3>ğŸ¨ Alakzat KihÃ­vÃ¡s</h3>
            <div>Szint: <span id="currentLevel">1</span></div>
            <div class="current-shape" id="currentShapeDisplay">â¬œ</div>
            <div>KÃ¶vesd le: <span id="currentShapeName">NÃ©gyzet</span></div>
            <div class="challenge-timer" id="challengeTimer">Kattints a "RajzolÃ¡s KezdÃ©se" gombra!</div>
            <div class="challenge-progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div>TeljesÃ­tett: <span id="completedCount">0</span>/5</div>
            <div class="drawing-instructions">
                <small>ğŸ’¡ Rajzold le az alakzatot pontosan! A felismerÃ©s szigorÃº.</small>
            </div>
        `;
        
        statsContainer.insertAdjacentElement('afterend', challengeDiv);
    },
    
    removeDrawingModeUI: function() {
        const challengeDiv = document.getElementById('shapeChallenge');
        if (challengeDiv) {
            challengeDiv.remove();
        }
        
        if (this.drawingMode.timer) {
            clearInterval(this.drawingMode.timer);
            this.drawingMode.timer = null;
        }
    },
    
    startNewChallenge: function() {
        const shapeIndex = (this.drawingMode.currentLevel - 1) % this.drawingMode.shapes.length;
        this.drawingMode.currentShape = this.drawingMode.shapes[shapeIndex];
        this.drawingMode.isActive = false;
        
        this.updateChallengeUI();
        
        setTimeout(() => {
            this.clearCanvas();
            this.drawShapeGuide();
        }, 100);
        
        console.log(`ğŸ¯ Ãšj kihÃ­vÃ¡s: ${this.drawingMode.currentShape.name}`);
    },
    
    updateChallengeUI: function() {
        const levelSpan = document.getElementById('currentLevel');
        const shapeDisplay = document.getElementById('currentShapeDisplay');
        const shapeName = document.getElementById('currentShapeName');
        const completedCount = document.getElementById('completedCount');
        const timerElement = document.getElementById('challengeTimer');
        
        if (levelSpan) levelSpan.textContent = this.drawingMode.currentLevel;
        if (shapeDisplay) shapeDisplay.textContent = this.drawingMode.currentShape.icon;
        if (shapeName) shapeName.textContent = this.drawingMode.currentShape.name;
        if (completedCount) completedCount.textContent = this.drawingMode.completedShapes;
        if (timerElement) timerElement.textContent = 'Kattints a "RajzolÃ¡s KezdÃ©se" gombra!';
        
        const startBtn = document.getElementById('startBtn');
        if (startBtn) {
            startBtn.textContent = 'ğŸ¯ RajzolÃ¡s KezdÃ©se';
            startBtn.disabled = false;
        }
    },
    
    clearCanvas: function() {
        const canvas = document.getElementById('gameCanvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    },
    
    drawShapeGuide: function() {
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const shape = this.drawingMode.currentShape;
        
        if (!shape) return;
        
        ctx.save();
        ctx.strokeStyle = 'rgba(33, 150, 243, 0.4)';
        ctx.lineWidth = 3;
        ctx.setLineDash([8, 8]);
        
        ctx.beginPath();
        
        if (shape.type === 'circle') {
            // KÃ¶r rajzolÃ¡sa
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.3;
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        } else if (shape.points && shape.points.length > 0) {
            // Pontok alapjÃ¡n rajzolÃ¡s
            shape.points.forEach((point, index) => {
                const x = point[0] * canvas.width;
                const y = point[1] * canvas.height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
        }
        
        ctx.stroke();
        ctx.restore();
    },
    
setupDrawingDetection: function() {
    const canvas = document.getElementById('gameCanvas');
    if (!canvas) return;
    
    let isDrawing = false;
    let drawnPoints = [];
    
    // âœ… EGÃ‰R ESEMÃ‰NYEK - PONTOK
    canvas.addEventListener('mousedown', (e) => {
        if (this.currentMode === 'drawing' && this.drawingMode.isActive) {
            isDrawing = true;
            drawnPoints = [];
            
            const rect = canvas.getBoundingClientRect();
            const point = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            
            drawnPoints.push(point);
            
            // PONT RAJZOLÃSA
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(point.x, point.y, 2, 0, 2 * Math.PI);
            ctx.fill();
            
            console.log('ğŸ¨ EgÃ©r pontrajzolÃ¡s kezdÃ©se');
        }
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (this.currentMode === 'drawing' && this.drawingMode.isActive && isDrawing) {
            const rect = canvas.getBoundingClientRect();
            const point = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            
            drawnPoints.push(point);
            
            // âœ… PONTOK RAJZOLÃSA (NEM VONALAK!)
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(point.x, point.y, 2, 0, 2 * Math.PI);
            ctx.fill();
        }
    });
    
    canvas.addEventListener('mouseup', () => {
        if (this.currentMode === 'drawing' && this.drawingMode.isActive && isDrawing) {
            isDrawing = false;
            console.log('ğŸ EgÃ©r pontrajzolÃ¡s befejezve, pontok:', drawnPoints.length);
            
            setTimeout(() => {
                this.evaluateDrawing(drawnPoints);
            }, 300);
        }
    });
    
    // âœ… TOUCH ESEMÃ‰NYEK - PONTOK
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (this.currentMode === 'drawing' && this.drawingMode.isActive) {
            isDrawing = true;
            drawnPoints = [];
            
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const point = {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
            
            drawnPoints.push(point);
            
            // PONT RAJZOLÃSA
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
            ctx.fill();
            
            console.log('ğŸ¨ Touch pontrajzolÃ¡s kezdÃ©se:', point);
        }
    }, { passive: false });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (this.currentMode === 'drawing' && this.drawingMode.isActive && isDrawing) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const point = {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
            
            drawnPoints.push(point);
            
            // âœ… PONTOK RAJZOLÃSA (NEM VONALAK!)
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
            ctx.fill();
        }
    }, { passive: false });
    
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (this.currentMode === 'drawing' && this.drawingMode.isActive && isDrawing) {
            isDrawing = false;
            console.log('ğŸ Touch pontrajzolÃ¡s befejezve, pontok:', drawnPoints.length);
            
            setTimeout(() => {
                this.evaluateDrawing(drawnPoints);
            }, 300);
        }
    }, { passive: false });
    
    canvas.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        if (this.currentMode === 'drawing' && this.drawingMode.isActive && isDrawing) {
            isDrawing = false;
            console.log('âŒ Touch pontrajzolÃ¡s megszakÃ­tva');
        }
    }, { passive: false });
    
    console.log('âœ… PontrajzolÃ¡s beÃ¡llÃ­tva rajz mÃ³dhoz');
},


    
    startTimer: function() {
        if (this.drawingMode.timer) {
            clearInterval(this.drawingMode.timer);
        }
        
        this.drawingMode.startTime = Date.now();
        this.drawingMode.isActive = true;
        let timeLeft = this.drawingMode.timeLimit;
        
        const timerElement = document.getElementById('challengeTimer');
        const progressBar = document.getElementById('progressBar');
        const startBtn = document.getElementById('startBtn');
        
        if (startBtn) {
            startBtn.textContent = 'ğŸ¯ Rajzold le az alakzatot!';
            startBtn.disabled = true;
        }
        
        console.log('â° Timer elindÃ­tva!');
        
        this.drawingMode.timer = setInterval(() => {
            timeLeft--;
            
            if (timerElement) {
                timerElement.textContent = timeLeft + 's';
                timerElement.style.color = timeLeft <= 10 ? '#f44336' : '#ff9800';
            }
            
            if (progressBar) {
                const progress = ((this.drawingMode.timeLimit - timeLeft) / this.drawingMode.timeLimit) * 100;
                progressBar.style.width = progress + '%';
            }
            
            if (timeLeft <= 0) {
                this.timeUp();
            }
        }, 1000);
    },
    
    timeUp: function() {
        clearInterval(this.drawingMode.timer);
        this.drawingMode.timer = null;
        this.drawingMode.isActive = false;
        
        alert(`â° IdÅ‘ lejÃ¡rt!\n\nNem sikerÃ¼lt befejezni: ${this.drawingMode.currentShape.name}\n\nPrÃ³bÃ¡ld Ãºjra!`);
        
        setTimeout(() => {
            this.startNewChallenge();
        }, 1000);
    },
    
    evaluateDrawing: function(drawnPoints) {
        if (!this.drawingMode.isActive) return;
        
        // Timer leÃ¡llÃ­tÃ¡sa
        if (this.drawingMode.timer) {
            clearInterval(this.drawingMode.timer);
            this.drawingMode.timer = null;
        }
        
        this.drawingMode.isActive = false;
        
        if (drawnPoints.length < 10) {
            this.showFailureMessage(0, 'TÃºl rÃ¶vid rajz!', 'Rajzolj egy teljes alakzatot!');
            return;
        }
        
        // âœ… INTELLIGENS ALAKZAT FELISMERÃ‰S
        const analysis = this.analyzeShape(drawnPoints);
        const score = this.calculateSmartScore(analysis);
        
        console.log(`ğŸ“Š Alakzat analÃ­zis:`, analysis);
        console.log(`ğŸ“Š VÃ‰GLEGES PONTSZÃM: ${score}`);
        
        this.updateGameStats(score);
        this.showDrawingScoreDisplay(score, analysis);
        
        if (score >= 70) {
            this.saveDrawingScore(score);
            setTimeout(() => {
                this.shapeCompleted(score);
            }, 2000);
        } else {
            setTimeout(() => {
                this.showFailureMessage(score, 'Nem sikerÃ¼lt!', analysis.feedback);
            }, 2000);
        }
    },
    
    // âœ… INTELLIGENS ALAKZAT ANALÃZIS
    analyzeShape: function(drawnPoints) {
        const shape = this.drawingMode.currentShape;
        const analysis = {
            shapeType: shape.type,
            shapeName: shape.name,
            accuracy: 0,
            feedback: '',
            details: {}
        };
        
        // Pontok simÃ­tÃ¡sa (zajszÅ±rÃ©s)
        const smoothedPoints = this.smoothPoints(drawnPoints);
        
        switch (shape.type) {
            case 'rectangle':
                return this.analyzeRectangle(smoothedPoints, analysis);
            case 'triangle':
                return this.analyzeTriangle(smoothedPoints, analysis);
            case 'circle':
                return this.analyzeCircle(smoothedPoints, analysis);
            case 'star':
                return this.analyzeStar(smoothedPoints, analysis);
            case 'heart':
                return this.analyzeHeart(smoothedPoints, analysis);
            default:
                analysis.accuracy = 0;
                analysis.feedback = 'Ismeretlen alakzat';
                return analysis;
        }
    },
    
    // Pontok simÃ­tÃ¡sa
    smoothPoints: function(points) {
        if (points.length < 3) return points;
        
        const smoothed = [points[0]];
        
        for (let i = 1; i < points.length - 1; i++) {
            const prev = points[i - 1];
            const curr = points[i];
            const next = points[i + 1];
            
            const smoothX = (prev.x + curr.x + next.x) / 3;
            const smoothY = (prev.y + curr.y + next.y) / 3;
            
            smoothed.push({ x: smoothX, y: smoothY });
        }
        
        smoothed.push(points[points.length - 1]);
        return smoothed;
    },
    
    // NÃ©gyzet analÃ­zis
    analyzeRectangle: function(points, analysis) {
        const corners = this.findCorners(points);
        analysis.details.corners = corners.length;
        
        if (corners.length < 4) {
            analysis.accuracy = Math.max(0, corners.length * 20);
            analysis.feedback = `Csak ${corners.length} sarok talÃ¡lhatÃ³, 4 kell!`;
            return analysis;
        }
        
        // SzÃ¶gek ellenÅ‘rzÃ©se
        const angles = this.calculateAngles(corners);
        const rightAngles = angles.filter(angle => Math.abs(angle - 90) < 15).length;
        
        // Oldalak hosszÃ¡nak ellenÅ‘rzÃ©se
        const sides = this.calculateSideLengths(corners);
        const avgSide = sides.reduce((a, b) => a + b, 0) / sides.length;
        const sideVariation = Math.max(...sides) / Math.min(...sides);
        
        // PontszÃ¡mÃ­tÃ¡s
        let accuracy = 0;
        accuracy += rightAngles * 15; // 15 pont sarokonkÃ©nt
        accuracy += Math.max(0, 40 - (sideVariation - 1) * 100); // OldalarÃ¡ny
        
        analysis.accuracy = Math.min(100, accuracy);
        analysis.details.rightAngles = rightAngles;
        analysis.details.sideVariation = sideVariation.toFixed(2);
        
        if (accuracy >= 70) {
            analysis.feedback = 'JÃ³ nÃ©gyzet!';
        } else {
            analysis.feedback = `${rightAngles}/4 jÃ³ szÃ¶g, oldalarÃ¡ny: ${sideVariation.toFixed(2)}`;
        }
        
        return analysis;
    },
    
    // HÃ¡romszÃ¶g analÃ­zis
    analyzeTriangle: function(points, analysis) {
        const corners = this.findCorners(points);
        analysis.details.corners = corners.length;
        
        if (corners.length < 3) {
            analysis.accuracy = Math.max(0, corners.length * 25);
            analysis.feedback = `Csak ${corners.length} sarok talÃ¡lhatÃ³, 3 kell!`;
            return analysis;
        }
        
        // ZÃ¡rÃ³dÃ¡s ellenÅ‘rzÃ©se
        const isClosed = this.isShapeClosed(points);
        const closureBonus = isClosed ? 30 : 0;
        
        // SzÃ¶gek Ã¶sszege (180Â° kell legyen)
        const angles = this.calculateAngles(corners.slice(0, 3));
        const angleSum = angles.reduce((a, b) => a + b, 0);
        const angleSumAccuracy = Math.max(0, 40 - Math.abs(angleSum - 180) * 2);
        
        analysis.accuracy = Math.min(100, closureBonus + angleSumAccuracy + 30);
        analysis.details.angleSum = Math.round(angleSum);
        analysis.details.isClosed = isClosed;
        
        if (analysis.accuracy >= 70) {
            analysis.feedback = 'JÃ³ hÃ¡romszÃ¶g!';
        } else {
            analysis.feedback = `SzÃ¶gÃ¶sszeg: ${Math.round(angleSum)}Â° (180Â° kell)`;
        }
        
        return analysis;
    },
    
    // KÃ¶r analÃ­zis
    analyzeCircle: function(points, analysis) {
        if (points.length < 20) {
            analysis.accuracy = 0;
            analysis.feedback = 'TÃºl kevÃ©s pont a kÃ¶rhÃ¶z!';
            return analysis;
        }
        
        // KÃ¶zpont meghatÃ¡rozÃ¡sa
        const center = this.findCenter(points);
        
        // TÃ¡volsÃ¡gok a kÃ¶zponttÃ³l
        const distances = points.map(p => 
            Math.sqrt((p.x - center.x) ** 2 + (p.y - center.y) ** 2)
        );
        
        const avgRadius = distances.reduce((a, b) => a + b, 0) / distances.length;
        const radiusVariation = Math.max(...distances) / Math.min(...distances);
        
        // ZÃ¡rÃ³dÃ¡s ellenÅ‘rzÃ©se
        const isClosed = this.isShapeClosed(points);
        
        // PontszÃ¡mÃ­tÃ¡s
        let accuracy = 0;
        accuracy += isClosed ? 40 : 0; // ZÃ¡rÃ³dÃ¡s
        accuracy += Math.max(0, 60 - (radiusVariation - 1) * 200); // KÃ¶ralak
        
        analysis.accuracy = Math.min(100, accuracy);
        analysis.details.radiusVariation = radiusVariation.toFixed(2);
        analysis.details.isClosed = isClosed;
        
        if (accuracy >= 70) {
            analysis.feedback = 'JÃ³ kÃ¶r!';
        } else {
            analysis.feedback = `SugÃ¡rvÃ¡ltozÃ¡s: ${radiusVariation.toFixed(2)} (1.0 a tÃ¶kÃ©letes)`;
        }
        
        return analysis;
    },
    
    // Csillag Ã©s szÃ­v egyszerÅ±sÃ­tett analÃ­zis
    analyzeStar: function(points, analysis) {
        const corners = this.findCorners(points);
        const minCorners = 8; // Csillaghoz minimum 8 sarok
        
        analysis.accuracy = Math.min(100, (corners.length / minCorners) * 80 + 20);
        analysis.details.corners = corners.length;
        analysis.feedback = corners.length >= minCorners ? 'JÃ³ csillag!' : `${corners.length}/${minCorners} sarok`;
        
        return analysis;
    },
    
    analyzeHeart: function(points, analysis) {
        // SzÃ­v esetÃ©n egyszerÅ±bb: zÃ¡rÃ³dÃ¡s Ã©s forma komplexitÃ¡s
        const isClosed = this.isShapeClosed(points);
        const complexity = points.length > 50 ? 60 : points.length;
        
        analysis.accuracy = (isClosed ? 40 : 0) + complexity;
        analysis.details.isClosed = isClosed;
        analysis.details.complexity = points.length;
        analysis.feedback = isClosed ? 'JÃ³ szÃ­v!' : 'A szÃ­v nincs lezÃ¡rva!';
        
        return analysis;
    },
    
    // SegÃ©dfÃ¼ggvÃ©nyek
    findCorners: function(points) {
        if (points.length < 3) return [];
        
        const corners = [];
        const angleThreshold = 30; // fok
        
        for (let i = 1; i < points.length - 1; i++) {
            const prev = points[i - 1];
            const curr = points[i];
            const next = points[i + 1];
            
            const angle1 = Math.atan2(curr.y - prev.y, curr.x - prev.x);
            const angle2 = Math.atan2(next.y - curr.y, next.x - curr.x);
            
            let angleDiff = Math.abs(angle2 - angle1) * 180 / Math.PI;
            if (angleDiff > 180) angleDiff = 360 - angleDiff;
            
            if (angleDiff > angleThreshold) {
                corners.push(curr);
            }
        }
        
        return corners;
    },
    
    calculateAngles: function(corners) {
        if (corners.length < 3) return [];
        
        const angles = [];
        
        for (let i = 0; i < corners.length; i++) {
            const prev = corners[(i - 1 + corners.length) % corners.length];
            const curr = corners[i];
            const next = corners[(i + 1) % corners.length];
            
            const angle1 = Math.atan2(prev.y - curr.y, prev.x - curr.x);
            const angle2 = Math.atan2(next.y - curr.y, next.x - curr.x);
            
            let angle = Math.abs(angle2 - angle1) * 180 / Math.PI;
            if (angle > 180) angle = 360 - angle;
            
            angles.push(angle);
        }
        
        return angles;
    },
    
    calculateSideLengths: function(corners) {
        const sides = [];
        
        for (let i = 0; i < corners.length; i++) {
            const curr = corners[i];
            const next = corners[(i + 1) % corners.length];
            
            const length = Math.sqrt((next.x - curr.x) ** 2 + (next.y - curr.y) ** 2);
            sides.push(length);
        }
        
        return sides;
    },
    
    findCenter: function(points) {
        const sumX = points.reduce((sum, p) => sum + p.x, 0);
        const sumY = points.reduce((sum, p) => sum + p.y, 0);
        
        return {
            x: sumX / points.length,
            y: sumY / points.length
        };
    },
    
    isShapeClosed: function(points) {
        if (points.length < 3) return false;
        
        const first = points[0];
        const last = points[points.length - 1];
        const distance = Math.sqrt((last.x - first.x) ** 2 + (last.y - first.y) ** 2);
        
        return distance < 50; // 50 pixel tolerancia
    },
    
    // âœ… OKOS PONTSZÃMÃTÃS
    calculateSmartScore: function(analysis) {
        let baseScore = analysis.accuracy;
        
        // IdÅ‘ bÃ³nusz/bÃ¼ntetÃ©s
        const elapsedTime = (Date.now() - this.drawingMode.startTime) / 1000;
        let timeMultiplier = 1.0;
        
        if (elapsedTime < 10) {
            timeMultiplier = 1.1; // 10% bÃ³nusz
        } else if (elapsedTime > 25) {
            timeMultiplier = 0.9; // 10% bÃ¼ntetÃ©s
        }
        
        const finalScore = Math.max(0, Math.min(100, Math.round(baseScore * timeMultiplier)));
        
        console.log(`ğŸ§® Okos pontszÃ¡mÃ­tÃ¡s:
            - Alakzat pontossÃ¡g: ${baseScore.toFixed(1)}
            - IdÅ‘ (${elapsedTime.toFixed(1)}s): ${timeMultiplier}x
            - VÃ‰GSÅ: ${finalScore}`);
        
        return finalScore;
    },
    
    showDrawingScoreDisplay: function(score, analysis) {
        const scoreDisplay = document.getElementById('scoreDisplay');
        const finalScore = document.getElementById('finalScore');
        const currentScore = document.getElementById('currentScore');
        const scoreBreakdown = document.getElementById('scoreBreakdown');
        
        if (finalScore) finalScore.textContent = score;
        if (currentScore) currentScore.textContent = score;
        
        if (scoreBreakdown && analysis) {
            const elapsedTime = (Date.now() - this.drawingMode.startTime) / 1000;
            
            scoreBreakdown.innerHTML = `
                <div>ğŸ¨ ${analysis.shapeName}: ${score}/100</div>
                <div>â±ï¸ IdÅ‘: ${elapsedTime.toFixed(1)}s</div>
                <div>ğŸ¯ PontossÃ¡g: ${analysis.accuracy.toFixed(1)}%</div>
                <div>ğŸ’¬ ${analysis.feedback}</div>
                ${analysis.details.corners ? `<div>ğŸ“ Sarkok: ${analysis.details.corners}</div>` : ''}
                ${analysis.details.isClosed !== undefined ? `<div>ğŸ”— ZÃ¡rt: ${analysis.details.isClosed ? 'Igen' : 'Nem'}</div>` : ''}
            `;
        }
        
        if (scoreDisplay) {
            scoreDisplay.style.display = 'block';
            scoreDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        console.log(`ğŸ“Š Score display frissÃ­tve: ${score} pont`);
    },
    
    updateGameStats: function(score) {
        try {
            const currentScoreElement = document.getElementById('currentScore');
            if (currentScoreElement) {
                currentScoreElement.textContent = score;
            }
            
            if (window.updateStats) {
                setTimeout(() => {
                    window.updateStats();
                }, 100);
            }
            
            console.log('ğŸ“Š StatisztikÃ¡k frissÃ­tve:', score);
        } catch (error) {
            console.error('âŒ Statisztika frissÃ­tÃ©si hiba:', error);
        }
    },
    
    saveDrawingScore: function(score) {
        try {
            if (window.ScoreManager && window.ScoreManager.saveScore) {
                const playerName = document.getElementById('playerName')?.value?.trim() || 'NÃ©vtelen';
                const shapeName = this.drawingMode.currentShape.name;
                
                const analysis = {
                    shape: score * 0.4,
                    closure: score * 0.2,
                    smoothness: score * 0.25,
                    size: score * 0.15
                };
                
                const savedScore = window.ScoreManager.saveScore(
                    score,
                    analysis,
                    'drawing',
                    `Rajz: ${shapeName}`
                );
                
                console.log('ğŸ’¾ Rajz mÃ³d score mentve:', savedScore);
                
                setTimeout(() => {
                    if (window.currentLeaderboardType === 'local' && window.refreshLeaderboard) {
                        window.refreshLeaderboard();
                    }
                }, 200);
            }
        } catch (error) {
            console.error('âŒ Score mentÃ©si hiba:', error);
        }
    },
    
    showFailureMessage: function(score, message, details = '') {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(244, 67, 54, 0.9); display: flex; justify-content: center; align-items: center;
            z-index: 10000; color: white; font-size: 2em; text-align: center;
        `;
        
        overlay.innerHTML = `
            <div>
                <div style="font-size: 4em; margin-bottom: 20px;">âŒ</div>
                <div>${message}</div>
                <div style="font-size: 0.8em; margin-top: 10px;">${score}/100 pont</div>
                <div style="font-size: 0.6em; margin-top: 5px;">LegalÃ¡bb 70 pont kell!</div>
                ${details ? `<div style="font-size: 0.5em; margin-top: 10px;">${details}</div>` : ''}
                <div style="font-size: 0.5em; margin-top: 15px;">Ãšjra prÃ³bÃ¡lkozÃ¡s...</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        setTimeout(() => {
            if (overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
            this.startNewChallenge();
        }, 4000);
    },
    
    shapeCompleted: function(score) {
        const elapsedTime = (Date.now() - this.drawingMode.startTime) / 1000;
        this.drawingMode.totalTime += elapsedTime;
        this.drawingMode.completedShapes++;
        
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(76, 175, 80, 0.9); display: flex; justify-content: center; align-items: center;
            z-index: 10000; color: white; font-size: 2em; text-align: center;
        `;
        
        overlay.innerHTML = `
            <div>
                <div style="font-size: 4em; margin-bottom: 20px;">âœ…</div>
                <div>Alakzat TeljesÃ­tve!</div>
                <div style="font-size: 0.8em; margin-top: 10px;">${score} pont</div>
                <div style="font-size: 0.6em; margin-top: 5px;">${elapsedTime.toFixed(1)}s</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        setTimeout(() => {
            if (overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
            
            if (this.drawingMode.completedShapes >= 5) {
                this.levelCompleted();
            } else {
                this.drawingMode.currentLevel++;
                this.startNewChallenge();
            }
        }, 3000);
    },
    
    levelCompleted: function() {
        const avgTime = (this.drawingMode.totalTime / 5).toFixed(1);
        alert(`ğŸ† Szint TeljesÃ­tve!\n\nâœ… 5/5 alakzat teljesÃ­tve\nâ±ï¸ Ãtlag idÅ‘: ${avgTime}s\n\nKÃ¶vetkezÅ‘ szint indul...`);
        
        this.drawingMode.completedShapes = 0;
        this.drawingMode.totalTime = 0;
        setTimeout(() => {
            this.startNewChallenge();
        }, 1000);
    },
    
    init: function() {
        const savedMode = localStorage.getItem('perfectcircle_gamemode');
        
        if (!savedMode) {
            setTimeout(() => {
                this.showModeSelector();
            }, 1000);
        } else {
            this.currentMode = savedMode;
            if (savedMode === 'drawing') {
                setTimeout(() => {
                    this.initDrawingMode();
                }, 1000);
            }
        }
    }
};

// GlobÃ¡lis fÃ¼ggvÃ©nyek
window.selectGameMode = function(mode) {
    window.GameModeManager.selectMode(mode);
};

// Start gomb override rajz mÃ³dhoz
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const startBtn = document.getElementById('startBtn');
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                if (window.GameModeManager.currentMode === 'drawing') {
                    if (!window.GameModeManager.drawingMode.isActive) {
                        console.log('ğŸ¨ Rajz mÃ³d timer indÃ­tÃ¡sa');
                        window.GameModeManager.startTimer();
                    }
                } else {
                    // NormÃ¡l kÃ¶r jÃ¡tÃ©k
                    if (window.gameEngine && window.gameEngine.startDrawing) {
                        window.gameEngine.startDrawing();
                    }
                }
            });
        }
        
        window.GameModeManager.init();
    }, 2000);
});

console.log('âœ… Intelligens alakzat felismerÅ‘ GameModeManager betÃ¶ltve');
</script>


    <!-- JavaScript fÃ¡jlok betÃ¶ltÃ©se -->
    <script>
        
        // GlobÃ¡lis nyelvi adatok tÃ¡rolÃ³ja
        window.languageData = {};
        
        // Magyar nyelv beÃ¡gyazÃ¡sa (egyszerÅ±sÃ­tett verziÃ³)
        window.languageData.hu = {
            title: "Perfect Circle - Rajzolj TÃ¶kÃ©letes KÃ¶rt!",
            subtitle: "Rajzolj a lehetÅ‘ legtÃ¶kÃ©letesebb kÃ¶rt egyetlen mozdulattal!",
            instructions: {
                title: "ğŸ® Hogyan jÃ¡tssz:",
                text: "Kattints Ã©s hÃºzd az egeret (vagy Ã©rintsd Ã©s hÃºzd az ujjad) hogy egy kÃ¶rt rajzolj. MinÃ©l tÃ¶kÃ©letesebb a kÃ¶rÃ¶d, annÃ¡l tÃ¶bb pontot kapsz! A kÃ¶r varÃ¡zslatos mÃ³don Ã¡t fog vÃ¡ltozni! âœ¨"
            },
            buttons: {
                startDrawing: "ğŸ¯ RajzolÃ¡s KezdÃ©se",
                clear: "ğŸ—‘ï¸ TÃ¶rlÃ©s",
                help: "â“ SegÃ­tsÃ©g",
                save: "ğŸ’¾ MentÃ©s",
                clearScores: "ğŸ—‘ï¸ Helyi EredmÃ©nyek TÃ¶rlÃ©se",
                guide: "ğŸ“ SegÃ©dvonal",
                switchMode: "ğŸ”„ MÃ³d VÃ¡ltÃ¡s" 


            },
            player: {
                label: "NÃ©v:",
                placeholder: "Add meg a neved"
            },
            difficulty: {
                label: "ğŸ¯ NehÃ©zsÃ©g:",
                easy: "KÃ¶nnyÅ± ğŸ˜Š",
                hard: "NehÃ©z ğŸŒ€"
            },
            stats: {
                currentScore: "Jelenlegi PontszÃ¡m",
                bestScore: "Legjobb EredmÃ©ny",
                gamesPlayed: "JÃ¡tÃ©kok SzÃ¡ma",
                averageScore: "Ãtlag PontszÃ¡m"
            },
            leaderboard: {
                title: "ğŸ† Ranglista",
                localResults: "ğŸ“± Helyi eredmÃ©nyek",
                noResults: "MÃ©g nincsenek eredmÃ©nyek"
            },
            common: {
                points: "pont"
            },
            scoreTitle: {
                result: "ğŸ† EredmÃ©ny"
            },
            transformation: {
                magic: "âœ¨ VarÃ¡zslat tÃ¶rtÃ©nik... âœ¨"
            },
            firebase: {
                connecting: "ğŸŸ¡ KapcsolÃ³dÃ¡s...",
                offlineNotice: "âš ï¸ <strong>Offline mÃ³d:</strong> A globÃ¡lis ranglista nem elÃ©rhetÅ‘. Az eredmÃ©nyek helyben mentÅ‘dnek."
            },
            visitors: {
                label: "ğŸ‘¥ LÃ¡togatÃ¡sok:"
            },
            dev: {
                version: "v2.1",
                debug: "Debug"
            }
        };
    </script>

    <!-- THUMBNAIL GENERATOR BEÃGYAZVA -->
    <script>
        
        // js/utils/thumbnailGenerator.js - BEÃGYAZVA
        window.ThumbnailGenerator = {
            
            // Canvas tartalom mentÃ©se thumbnail-kÃ©nt
            captureCanvasThumbnail: function(canvasId, maxWidth = 100, maxHeight = 100, quality = 0.8) {
                try {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) {
                        console.error('âŒ Canvas nem talÃ¡lhatÃ³:', canvasId);
                        return null;
                    }
                    
                    // Thumbnail canvas lÃ©trehozÃ¡sa
                    const thumbCanvas = document.createElement('canvas');
                    const thumbCtx = thumbCanvas.getContext('2d');
                    
                    // ArÃ¡nyos Ã¡tmÃ©retezÃ©s szÃ¡mÃ­tÃ¡sa
                    const originalWidth = canvas.width;
                    const originalHeight = canvas.height;
                    const aspectRatio = originalWidth / originalHeight;
                    
                    let thumbWidth = maxWidth;
                    let thumbHeight = maxHeight;
                    
                    if (aspectRatio > 1) {
                        thumbHeight = maxWidth / aspectRatio;
                    } else {
                        thumbWidth = maxHeight * aspectRatio;
                    }
                    
                    thumbCanvas.width = Math.round(thumbWidth);
                    thumbCanvas.height = Math.round(thumbHeight);
                    
                    // HÃ¡ttÃ©r beÃ¡llÃ­tÃ¡sa (Ã¡tlÃ¡tszÃ³ helyett fehÃ©r)
                    thumbCtx.fillStyle = '#ffffff';
                    thumbCtx.fillRect(0, 0, thumbCanvas.width, thumbCanvas.height);
                    
                    // Eredeti canvas tartalom Ã¡tmÃ¡solÃ¡sa
                    thumbCtx.drawImage(canvas, 0, 0, thumbCanvas.width, thumbCanvas.height);
                    
                    // Base64 string visszaadÃ¡sa
                    const thumbnailData = thumbCanvas.toDataURL('image/jpeg', quality);
                    
                    console.log('âœ… Thumbnail kÃ©szÃ­tve:', {
                        originalSize: `${originalWidth}x${originalHeight}`,
                        thumbnailSize: `${thumbCanvas.width}x${thumbCanvas.height}`,
                        dataSize: Math.round(thumbnailData.length / 1024) + 'KB'
                    });
                    
                    return thumbnailData;
                    
                } catch (error) {
                    console.error('âŒ Thumbnail kÃ©szÃ­tÃ©si hiba:', error);
                    return null;
                }
            },

            // TranszformÃ¡ciÃ³ utÃ¡n thumbnail kÃ©szÃ­tÃ©s
            captureTransformationThumbnail: function(delay = 500) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // PrÃ³bÃ¡ljuk meg a gameCanvas-rÃ³l
                        let thumbnail = this.captureCanvasThumbnail('gameCanvas');
                        
                        // Ha nincs, prÃ³bÃ¡ljuk az idealCircleCanvas-rÃ³l
                        if (!thumbnail) {
                            thumbnail = this.captureCanvasThumbnail('idealCircleCanvas');
                        }
                        
                        resolve(thumbnail);
                    }, delay);
                });
            },

            // Thumbnail megjelenÃ­tÃ©se DOM elemben
            displayThumbnail: function(thumbnailData, containerId, className = 'score-thumbnail') {
                try {
                    if (!thumbnailData) return false;
                    
                    const container = document.getElementById(containerId);
                    if (!container) return false;
                    
                    // MeglÃ©vÅ‘ thumbnail eltÃ¡volÃ­tÃ¡sa
                    const existingThumbnail = container.querySelector('.' + className);
                    if (existingThumbnail) {
                        existingThumbnail.remove();
                    }
                    
                    // Ãšj thumbnail elem lÃ©trehozÃ¡sa
                    const img = document.createElement('img');
                    img.src = thumbnailData;
                    img.className = className;
                    img.style.cssText = `
                        width: 60px;
                        height: 60px;
                        object-fit: cover;
                        border-radius: 8px;
                        border: 2px solid #ddd;
                        margin-left: 10px;
                        cursor: pointer;
                        transition: transform 0.2s;
                    `;
                    
                    // Hover effekt
                    img.addEventListener('mouseenter', () => {
                        img.style.transform = 'scale(1.1)';
                    });
                    
                    img.addEventListener('mouseleave', () => {
                        img.style.transform = 'scale(1)';
                    });
                    
                    // KattintÃ¡sra nagyÃ­tÃ¡s
                    img.addEventListener('click', () => {
                        this.showThumbnailModal(thumbnailData);
                    });
                    
                    container.appendChild(img);
                    return true;
                    
                } catch (error) {
                    console.error('âŒ Thumbnail megjelenÃ­tÃ©si hiba:', error);
                    return false;
                }
            },

            // Thumbnail modal megjelenÃ­tÃ©se
            showThumbnailModal: function(thumbnailData) {
                // Modal lÃ©trehozÃ¡sa
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    cursor: pointer;
                `;
                
                const img = document.createElement('img');
                img.src = thumbnailData;
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                `;
                
                modal.appendChild(img);
                document.body.appendChild(modal);
                
                // KattintÃ¡sra bezÃ¡rÃ¡s
                modal.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // ESC billentyÅ±re bezÃ¡rÃ¡s
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }
        };

        console.log('âœ… ThumbnailGenerator betÃ¶ltve');
    </script>

    <!-- SCORE ANIMATOR -->
    <script>
        window.ScoreAnimator = {
            
            // FÅ‘bb animÃ¡ciÃ³ indÃ­tÃ¡sa
            animateScore: function(score, breakdown, transformationName = '') {
                console.log('ğŸ‰ Score animÃ¡ciÃ³ indÃ­tÃ¡sa:', score);
                
                try {
                    // Score kategÃ³ria meghatÃ¡rozÃ¡sa
                    const category = this.getScoreCategory(score);
                    
                    // Nagy score felfedÃ©s
                    this.showBigScoreReveal(score, category);
                    
                    // RÃ©szletek animÃ¡lÃ¡sa
                    setTimeout(() => {
                        this.animateScoreBreakdown(breakdown);
                    }, 1500);
                    
                    // EgyÃ©b effektek
                    setTimeout(() => {
                        this.addScoreEffects(score, category);
                    }, 500);
                    
                    // Score display animÃ¡lÃ¡sa
                    setTimeout(() => {
                        this.animateScoreDisplay(score, category);
                    }, 2000);
                    
                } catch (error) {
                    console.error('âŒ Score animÃ¡ciÃ³ hiba:', error);
                }
            },
            
            // Score kategÃ³ria meghatÃ¡rozÃ¡sa
            getScoreCategory: function(score) {
                if (score >= 95) return { name: 'perfect', text: 'TÃ–KÃ‰LETES!', emoji: 'ğŸ†' };
                if (score >= 85) return { name: 'excellent', text: 'KIVÃLÃ“!', emoji: 'â­' };
                if (score >= 70) return { name: 'good', text: 'JÃ“!', emoji: 'ğŸ‘' };
                if (score >= 50) return { name: 'fair', text: 'ELFOGADHATÃ“', emoji: 'ğŸ‘Œ' };
                return { name: 'poor', text: 'GYAKOROLJ MÃ‰G!', emoji: 'ğŸ’ª' };
            },
            
            // Nagy score felfedÃ©s
            showBigScoreReveal: function(score, category) {
                // Overlay lÃ©trehozÃ¡sa
                const overlay = document.createElement('div');
                overlay.className = 'score-animation-overlay';
                
                // Score szÃ¶veg
                const scoreText = document.createElement('div');
                scoreText.className = `score-big-reveal score-${category.name}`;
                scoreText.innerHTML = `
                    <div style="font-size: 0.3em; margin-bottom: 10px;">${category.emoji} ${category.text} ${category.emoji}</div>
                    <div>${Math.round(score)}</div>
                    <div style="font-size: 0.4em; margin-top: 10px;">PONT</div>
                `;
                
                overlay.appendChild(scoreText);
                document.body.appendChild(overlay);
                
                // Hang lejÃ¡tszÃ¡sa (ha van AudioManager)
                if (window.AudioManager && window.AudioManager.playScoreReveal) {
                    window.AudioManager.playScoreReveal(score);
                }
                
                // EltÃ¡volÃ­tÃ¡s
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 3000);
            },
            
            // Score breakdown animÃ¡lÃ¡sa
            animateScoreBreakdown: function(breakdown) {
                const scoreBreakdown = document.getElementById('scoreBreakdown');
                if (!scoreBreakdown || !breakdown) return;
                
                // Elemek animÃ¡lÃ¡sa egyenkÃ©nt
                const items = scoreBreakdown.querySelectorAll('div');
                items.forEach((item, index) => {
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(-50px)';
                    item.style.transition = 'all 0.5s ease';
                    
                    setTimeout(() => {
                        item.style.opacity = '1';
                        item.style.transform = 'translateX(0)';
                    }, index * 200);
                });
            },
            
            // Score display animÃ¡lÃ¡sa
            animateScoreDisplay: function(score, category) {
                const scoreDisplay = document.getElementById('scoreDisplay');
                if (!scoreDisplay) return;
                
                // CSS class hozzÃ¡adÃ¡sa
                scoreDisplay.classList.add('score-revealed');
                
                // Badge hozzÃ¡adÃ¡sa
                this.addScoreBadge(scoreDisplay, category);
                
                // Class eltÃ¡volÃ­tÃ¡sa
                setTimeout(() => {
                    scoreDisplay.classList.remove('score-revealed');
                }, 2000);
            },
            
            // Score badge hozzÃ¡adÃ¡sa
            addScoreBadge: function(container, category) {
                // MeglÃ©vÅ‘ badge eltÃ¡volÃ­tÃ¡sa
                const existingBadge = container.querySelector('.score-grade-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Ãšj badge
                const badge = document.createElement('div');
                badge.className = 'score-grade-badge';
                badge.textContent = category.emoji + ' ' + category.text;
                
                container.style.position = 'relative';
                container.appendChild(badge);
                
                // Badge eltÃ¡volÃ­tÃ¡sa
                setTimeout(() => {
                    if (badge.parentNode) {
                        badge.parentNode.removeChild(badge);
                    }
                }, 3000);
            },
            
            // EgyÃ©b effektek
            addScoreEffects: function(score, category) {
                // Particle effekt
                this.createParticles(score);
                
                // Confetti nagy score esetÃ©n
                if (score >= 80) {
                    this.createConfetti();
                }
                
                // TÅ±zijÃ¡tÃ©k tÃ¶kÃ©letes score esetÃ©n
                if (score >= 95) {
                    this.createFireworks();
                }
            },
            
            // Particle effekt
            createParticles: function(score) {
                const container = document.createElement('div');
                container.className = 'score-particles';
                
                const particleCount = Math.min(score / 2, 50);
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'score-particle';
                    
                    // Random pozÃ­ciÃ³ Ã©s irÃ¡ny
                    const angle = (Math.PI * 2 * i) / particleCount;
                    const distance = 100 + Math.random() * 100;
                    const dx = Math.cos(angle) * distance;
                    const dy = Math.sin(angle) * distance;
                    
                    particle.style.setProperty('--dx', dx + 'px');
                    particle.style.setProperty('--dy', dy + 'px');
                    particle.style.backgroundColor = this.getRandomColor();
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    container.appendChild(particle);
                }
                
                document.body.appendChild(container);
                
                // EltÃ¡volÃ­tÃ¡s
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }, 2000);
            },
            
            // Confetti lÃ©trehozÃ¡sa
            createConfetti: function() {
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
                
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 2 + 's';
                        
                        document.body.appendChild(confetti);
                        
                        setTimeout(() => {
                            if (confetti.parentNode) {
                                confetti.parentNode.removeChild(confetti);
                            }
                        }, 3000);
                    }, i * 50);
                }
            },
            
            // TÅ±zijÃ¡tÃ©k
            createFireworks: function() {
                const colors = ['#FFD700', '#FF1744', '#00E676', '#2196F3', '#FF9800'];
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const container = document.createElement('div');
                        container.className = 'score-fireworks';
                        
                        const centerX = Math.random() * window.innerWidth;
                        const centerY = Math.random() * window.innerHeight * 0.5 + window.innerHeight * 0.2;
                        
                        for (let j = 0; j < 20; j++) {
                            const firework = document.createElement('div');
                            firework.className = 'firework';
                            firework.style.left = centerX + 'px';
                            firework.style.top = centerY + 'px';
                            firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                            firework.style.animationDelay = Math.random() * 0.5 + 's';
                            
                            container.appendChild(firework);
                        }
                        
                        document.body.appendChild(container);
                        
                        setTimeout(() => {
                            if (container.parentNode) {
                                container.parentNode.removeChild(container);
                            }
                        }, 1500);
                    }, i * 300);
                }
            },
            
            // Random szÃ­n
            getRandomColor: function() {
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
                return colors[Math.floor(Math.random() * colors.length)];
            },
            
            // VibrÃ¡ciÃ³ (mobil)
            vibrate: function(score) {
                if (navigator.vibrate) {
                    if (score >= 95) {
                        navigator.vibrate([200, 100, 200, 100, 200]);
                    } else if (score >= 80) {
                        navigator.vibrate([100, 50, 100]);
                    } else if (score >= 60) {
                        navigator.vibrate(100);
                    }
                }
            }
        };

        console.log('âœ… ScoreAnimator betÃ¶ltve');
    </script>

    <!-- âœ… BEÃGYAZOTT VISITOR COUNTER -->
    <script>
        // âœ… BEÃGYAZOTT VISITOR COUNTER OSZTÃLY
        if (!window.VisitorCounter) {
            console.log('ğŸ”§ VisitorCounter beÃ¡gyazÃ¡sa...');
            
            class VisitorCounter {
                static STORAGE_KEY = 'perfectcircle_visits';
                static SESSION_KEY = 'perfectcircle_session';
                static currentCount = 0;
                static globalCount = 0;
                
                static async init() {
                    console.log('ğŸ‘ï¸ BeÃ¡gyazott VisitorCounter inicializÃ¡lÃ¡sa...');
                    
                    try {
                        // Helyi lÃ¡togatÃ¡sszÃ¡m frissÃ­tÃ©se
                        this.currentCount = this.updateLocalVisitCount();
                        
                        // Firebase lÃ¡togatÃ¡s mentÃ©se (ha elÃ©rhetÅ‘)
                        if (window.firebaseAPI && window.firebaseAPI.isReady && window.firebaseAPI.isReady()) {
                            await this.saveVisitToFirebase();
                            await this.loadGlobalVisitCount();
                        } else {
                            console.log('ğŸ“´ Firebase nem elÃ©rhetÅ‘, csak helyi szÃ¡mlÃ¡lÃ³');
                        }
                        
                        console.log('âœ… BeÃ¡gyazott VisitorCounter inicializÃ¡lva');
                        return true;
                        
                    } catch (error) {
                        console.error('âŒ BeÃ¡gyazott VisitorCounter hiba:', error);
                        throw error;
                    }
                }
                
                static updateLocalVisitCount() {
                    let localVisits = parseInt(localStorage.getItem(this.STORAGE_KEY) || '0');
                    localVisits++;
                    localStorage.setItem(this.STORAGE_KEY, localVisits.toString());
                    
                    // IdÅ‘pontok mentÃ©se
                    if (!localStorage.getItem('perfectcircle_first_visit')) {
                        localStorage.setItem('perfectcircle_first_visit', new Date().toISOString());
                    }
                    localStorage.setItem('perfectcircle_last_visit', new Date().toISOString());
                    
                    // DOM frissÃ­tÃ©s
                    const visitElement = document.getElementById('visitCount');
                    if (visitElement) {
                        visitElement.textContent = localVisits.toLocaleString('hu-HU');
                    }
                    
                    console.log(`ğŸ“Š Helyi lÃ¡togatÃ¡sok: ${localVisits}`);
                    return localVisits;
                }
                
                static async saveVisitToFirebase() {
                    if (!window.firebaseAPI || !window.firebaseAPI.saveVisit) {
                        console.log('ğŸ“´ Firebase saveVisit nem elÃ©rhetÅ‘');
                        return;
                    }
                    
                    try {
                        const visitData = {
                            timestamp: new Date().toISOString(),
                            date: new Date().toLocaleDateString('hu-HU'),
                            time: new Date().toLocaleTimeString('hu-HU'),
                            sessionId: this.getSessionId(),
                            userAgent: navigator.userAgent.substring(0, 200),
                            language: navigator.language,
                            screen: `${screen.width}x${screen.height}`,
                            viewport: `${window.innerWidth}x${window.innerHeight}`,
                            referrer: (document.referrer || 'kÃ¶zvetlen').substring(0, 200),
                            url: window.location.href,
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            platform: navigator.platform
                        };
                        
                        await window.firebaseAPI.saveVisit(visitData);
                        console.log('âœ… LÃ¡togatÃ¡s mentve Firebase-be');
                        
                    } catch (error) {
                        console.error('âŒ Firebase lÃ¡togatÃ¡s mentÃ©si hiba:', error);
                    }
                }
                
                static async loadGlobalVisitCount() {
                    if (!window.firebaseAPI || !window.firebaseAPI.getVisitCount) {
                        console.log('ğŸ“´ Firebase getVisitCount nem elÃ©rhetÅ‘');
                        return;
                    }
                    
                    try {
                        const globalCount = await window.firebaseAPI.getVisitCount();
                        this.globalCount = globalCount;
                        console.log(`ğŸŒ GlobÃ¡lis lÃ¡togatÃ¡sok: ${globalCount}`);
                        
                    } catch (error) {
                        console.error('âŒ GlobÃ¡lis lÃ¡togatÃ¡sszÃ¡m lekÃ©rÃ©si hiba:', error);
                    }
                }
                
                static getSessionId() {
                    let sessionId = sessionStorage.getItem(this.SESSION_KEY);
                    if (!sessionId) {
                        sessionId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                        sessionStorage.setItem(this.SESSION_KEY, sessionId);
                    }
                    return sessionId;
                }
                
                static getCurrentCount() {
                    return this.currentCount;
                }
                
                static getGlobalCount() {
                    return this.globalCount;
                }
                
                static showStats() {
                    const localVisits = localStorage.getItem(this.STORAGE_KEY) || 0;
                    const firstVisit = localStorage.getItem('perfectcircle_first_visit');
                    const lastVisit = localStorage.getItem('perfectcircle_last_visit');
                    
                    let message = `ğŸ‘¥ LÃ¡togatÃ¡si statisztikÃ¡k:\n\n`;
                    message += `ğŸ”¢ Helyi lÃ¡togatÃ¡sok: ${localVisits}\n`;
                    
                    if (this.globalCount > 0) {
                        message += `ğŸŒ GlobÃ¡lis lÃ¡togatÃ¡sok: ${this.globalCount.toLocaleString('hu-HU')}\n`;
                    }
                    
                    if (firstVisit) {
                        const firstDate = new Date(firstVisit);
                        message += `ğŸ†• ElsÅ‘ lÃ¡togatÃ¡s: ${firstDate.toLocaleDateString('hu-HU')}\n`;
                    }
                    
                    if (lastVisit) {
                        const lastDate = new Date(lastVisit);
                        message += `ğŸ• UtolsÃ³ lÃ¡togatÃ¡s: ${lastDate.toLocaleDateString('hu-HU')} ${lastDate.toLocaleTimeString('hu-HU')}\n`;
                    }
                    
                    const sessionId = this.getSessionId();
                    message += `ğŸ†” Session ID: ${sessionId.substring(0, 8)}...`;
                    
                    alert(message);
                }
            }
            
            // GlobÃ¡lis export
            window.VisitorCounter = VisitorCounter;
            console.log('âœ… BeÃ¡gyazott VisitorCounter lÃ©trehozva');
        }
    </script>

    <script src="js/i18n/languageDetector.js"></script>
    <script src="js/i18n/i18nManager.js"></script>
    
    <!-- Firebase Scripts -->
    <script src="js/firebase/firebase-config.js" type="module"></script>
    
    <!-- Utility Scripts -->
    <script src="js/utils/audioManager.js"></script>
    <script src="js/utils/effectsManager.js"></script>
    
    <!-- Game Scripts -->
    <script src="js/game/transformations.js"></script>
    <script src="js/game/circleAnalyzer.js"></script>
    <script src="js/game/gameEngine.js"></script>
    
    <!-- Manager Scripts -->
    <script src="js/managers/scoreManager.js"></script>
    <script src="js/managers/visitorCounter.js"></script>
    <script src="js/managers/leaderboardManager.js"></script>

    <script src="leaderboard-fix.js"></script>

    <!-- Main App Script UTOLJÃRA -->
    <script src="js/app.js" type="module"></script>

    <!-- FIREBASE GLOBÃLIS LEADERBOARD TÃMOGATÃS -->
    <script>
        // VÃ¡rakozÃ¡s a Firebase API-ra
        function waitForFirebaseAPI() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100;
                
                const checkAPI = () => {
                    attempts++;
                    
                    if (window.firebaseAPI && typeof window.firebaseAPI.isReady === 'function') {
                        console.log('âœ… Firebase API elÃ©rhetÅ‘ globÃ¡lis leaderboard-hoz!');
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        console.error('âŒ Firebase API timeout!');
                        resolve(false);
                    } else {
                        setTimeout(checkAPI, 100);
                    }
                };
                checkAPI();
            });
        }

        // âœ… JAVÃTOTT GLOBÃLIS LEADERBOARD BETÃ–LTÃ‰SE
        window.loadGlobalLeaderboard = async function() {
            console.log('ğŸŒ GlobÃ¡lis leaderboard betÃ¶ltÃ©se...');
            
            // âœ… AZONNAL BEÃLLÃTJUK A TÃPUST
            window.currentLeaderboardType = 'global';
            
            const leaderboardList = document.getElementById('leaderboardList');
            const leaderboardStatus = document.getElementById('leaderboardStatus');
            
            if (!leaderboardList) return;
            
            // Loading Ã¡llapot
            leaderboardList.innerHTML = '<div class="score-entry">ğŸ”„ GlobÃ¡lis eredmÃ©nyek betÃ¶ltÃ©se...</div>';
            if (leaderboardStatus) {
                leaderboardStatus.textContent = 'ğŸŒ GlobÃ¡lis eredmÃ©nyek betÃ¶ltÃ©se...';
            }
            
            try {
                // VÃ¡runk a Firebase API-ra
                const apiReady = await waitForFirebaseAPI();
                
                if (!apiReady || !window.firebaseAPI.isReady()) {
                    throw new Error('Firebase nem elÃ©rhetÅ‘');
                }
                
                // GlobÃ¡lis eredmÃ©nyek lekÃ©rÃ©se
                const globalScores = await window.firebaseAPI.getTopScores(20);
                
                console.log('âœ… GlobÃ¡lis eredmÃ©nyek betÃ¶ltve:', globalScores.length);
                
                // âœ… ELLENÅRIZZÃœK HOGY MÃ‰G MINDIG GLOBÃLIS MÃ“DBAN VAGYUNK
                if (window.currentLeaderboardType !== 'global') {
                    console.log('âš ï¸ MÃ¡r nem globÃ¡lis mÃ³dban vagyunk, leÃ¡llÃ­tÃ¡s...');
                    return;
                }
                
                // Status frissÃ­tÃ©s
                if (leaderboardStatus) {
                    leaderboardStatus.textContent = `ğŸŒ ${globalScores.length} globÃ¡lis eredmÃ©ny`;
                }
                
                // Lista megjelenÃ­tÃ©se
                if (globalScores.length === 0) {
                    leaderboardList.innerHTML = `
                        <div class="score-entry">
                            <span>ğŸŒ MÃ©g nincsenek globÃ¡lis eredmÃ©nyek</span>
                        </div>
                    `;
                } else {
                    leaderboardList.innerHTML = globalScores.map((score, index) => {
                        // DÃ¡tum formÃ¡zÃ¡sa
                        let dateText = 'Ma';
                        if (score.timestamp && score.timestamp.seconds) {
                            const date = new Date(score.timestamp.seconds * 1000);
                            dateText = date.toLocaleDateString('hu-HU');
                        } else if (score.date) {
                            dateText = score.date;
                        }
                        
                        // Thumbnail kezelÃ©se
                        const thumbnailHTML = score.thumbnail ? 
                            `<div class="thumbnail-container">
                                <img src="${score.thumbnail}" 
                                     class="leaderboard-thumbnail" 
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer;" 
                                     onclick="window.ThumbnailGenerator.showThumbnailModal('${score.thumbnail}')"
                                     title="Kattints a nagyÃ­tÃ¡shoz">
                            </div>` : 
                            `<div class="thumbnail-container">
                                <div class="no-thumbnail" style="width: 40px; height: 40px; background: linear-gradient(45deg, #f0f0f0, #e0e0e0); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">ğŸŒ</div>
                            </div>`;
                        
                        return `
                            <div class="leaderboard-entry global-entry" data-score-id="${score.id}">
                                ${thumbnailHTML}
                                <div class="entry-content">
                                    <div class="entry-main">
                                        <span class="rank" style="font-weight: bold; color: #666; min-width: 30px;">#${index + 1}</span>
                                        <span class="name" style="font-weight: 500; color: #333; margin-right: 8px;">${score.playerName || 'NÃ©vtelen'}</span>
                                        <span class="score" style="font-weight: bold; color: #4CAF50; margin-left: auto;">${score.score} pont</span>
                                    </div>
                                    <div class="entry-details">
                                        <span style="color: #888;">ğŸŒ ${dateText}</span>
                                        ${score.transformation ? ` â€¢ <span style="color: #666;">ğŸ¨ ${score.transformation}</span>` : ''}
                                        ${score.difficulty && score.difficulty !== 'easy' ? ` â€¢ <span style="color: #ff9800;">ğŸŒ€ ${score.difficulty}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
            } catch (error) {
                console.error('âŒ GlobÃ¡lis leaderboard betÃ¶ltÃ©si hiba:', error);
                
                // âœ… ELLENÅRIZZÃœK HOGY MÃ‰G MINDIG GLOBÃLIS MÃ“DBAN VAGYUNK
                if (window.currentLeaderboardType !== 'global') {
                    console.log('âš ï¸ MÃ¡r nem globÃ¡lis mÃ³dban vagyunk, hiba megjelenÃ­tÃ©s kihagyva...');
                    return;
                }
                
                // Hiba megjelenÃ­tÃ©se
                leaderboardList.innerHTML = `
                    <div class="score-entry" style="color: #f44336;">
                        <span>âŒ Hiba a globÃ¡lis eredmÃ©nyek betÃ¶ltÃ©sekor</span>
                        <div style="font-size: 12px; margin-top: 5px; color: #666;">
                            ${error.message}
                        </div>
                    </div>
                `;
                
                if (leaderboardStatus) {
                    leaderboardStatus.textContent = 'âŒ GlobÃ¡lis eredmÃ©nyek nem elÃ©rhetÅ‘k';
                }
            }
        };

        // Firebase score mentÃ©s globÃ¡lisan
// A showScore fÃ¼ggvÃ©nyben (mÃ¡r van, de ellenÅ‘rizzÃ¼k):
// âœ… JAVÃTOTT - csak Ã¡tadja az adatot, nem kÃ©szÃ­t Ãºj thumbnail-t
window.saveScoreToFirebase = async function(scoreData) {
    try {
        if (!window.firebaseAPI || !window.firebaseAPI.isReady()) {
            console.log('âš ï¸ Firebase nem elÃ©rhetÅ‘, score nem mentve globÃ¡lisan');
            return null;
        }
        
        console.log('ğŸ“¤ Firebase mentÃ©s indÃ­tÃ¡sa:', {
            playerName: scoreData.playerName,
            score: scoreData.score,
            hasThumbnail: !!scoreData.thumbnail,
            thumbnailSize: scoreData.thumbnail ? Math.round(scoreData.thumbnail.length / 1024) + 'KB' : 'nincs'
        });
        
        const result = await window.firebaseAPI.saveScore(scoreData);
        console.log('âœ… Score mentve Firebase-be:', result?.id);
        return result;
        
    } catch (error) {
        console.error('âŒ Firebase score mentÃ©si hiba:', error);
        return null;
    }
};


    </script>

    <!-- InicializÃ¡lÃ¡s -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸŒ DOM betÃ¶ltve, i18n inicializÃ¡lÃ¡s...');
            
            if (window.languageData && window.languageData.hu) {
                window.simpleTranslate = function(key, params = {}) {
                    const keys = key.split('.');
                    let value = window.languageData.hu;
                    
                    for (const k of keys) {
                        if (value && typeof value === 'object' && value[k] !== undefined) {
                            value = value[k];
                        } else {
                            return key;
                        }
                    }
                    
                    if (typeof value === 'string' && params) {
                        Object.keys(params).forEach(param => {
                            value = value.replace(`{${param}}`, params[param]);
                        });
                    }
                    
                    return value;
                };
                
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const translation = window.simpleTranslate(key);
                    
                    if (translation && translation !== key) {
                        if (element.tagName === 'INPUT' && element.type === 'text') {
                            element.placeholder = translation;
                        } else {
                            element.innerHTML = translation;
                        }
                    }
                });
                
                console.log('âœ… EgyszerÅ±sÃ­tett i18n inicializÃ¡lva');
            }
        });
    </script>

    <!-- âœ… JAVÃTOTT LEADERBOARD FÃœGGVÃ‰NYEK -->
    <script>
        // âœ… AUTOMATIKUS LEADERBOARD FRISSÃTÅ THUMBNAILOKKAL - VÃ‰DETT VERZIÃ“
        window.refreshLeaderboard = function() {
            try {
                // âœ… ELLENÅRIZZÃœK A LEADERBOARD TÃPUST
                if (window.currentLeaderboardType === 'global') {
                    console.log('ğŸ›¡ï¸ VÃ‰DELEM: refreshLeaderboard blokkolva globÃ¡lis mÃ³dban');
                    return;
                }
                
                const leaderboardList = document.getElementById('leaderboardList');
                const leaderboardStatus = document.getElementById('leaderboardStatus');
                
                if (!leaderboardList || !window.ScoreManager) return;
                
                const scores = window.ScoreManager.getScores();
                
                // Status frissÃ­tÃ©s
                if (leaderboardStatus) {
                    leaderboardStatus.textContent = `ğŸ“± ${scores.length} helyi eredmÃ©ny`;
                }
                
                // Lista frissÃ­tÃ©s
                if (scores.length === 0) {
                    leaderboardList.innerHTML = `
                        <div class="score-entry">
                            <span>MÃ©g nincsenek eredmÃ©nyek</span>
                        </div>
                    `;
                } else {
                    leaderboardList.innerHTML = scores.map((score, index) => {
                        const thumbnailHTML = score.thumbnail ? 
                            `<div class="thumbnail-container">
                                <img src="${score.thumbnail}" 
                                     class="leaderboard-thumbnail" 
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer;" 
                                     onclick="window.ThumbnailGenerator.showThumbnailModal('${score.thumbnail}')"
                                     title="Kattints a nagyÃ­tÃ¡shoz">
                            </div>` : 
                            `<div class="thumbnail-container">
                                <div class="no-thumbnail" style="width: 40px; height: 40px; background: linear-gradient(45deg, #f0f0f0, #e0e0e0); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">ğŸ¨</div>
                            </div>`;
                        
                        return `
                            <div class="leaderboard-entry local-entry" data-score-id="${score.id}">
                                ${thumbnailHTML}
                                <div class="entry-content">
                                    <div class="entry-main">
                                        <span class="rank" style="font-weight: bold; color: #666; min-width: 30px;">#${index + 1}</span>
                                        <span class="name" style="font-weight: 500; color: #333; margin-right: 8px;">${score.playerName || 'NÃ©vtelen'}</span>
                                        <span class="score" style="font-weight: bold; color: #4CAF50; margin-left: auto;">${score.score} pont</span>
                                    </div>
                                    <div class="entry-details">
                                        <span style="color: #888;">${score.date || 'Ma'}</span>
                                        ${score.transformation ? ` â€¢ <span style="color: #666;">ğŸ¨ ${score.transformation}</span>` : ''}
                                        ${score.difficulty && score.difficulty !== 'easy' ? ` â€¢ <span style="color: #ff9800;">ğŸŒ€ ${score.difficulty}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log(`âœ… Leaderboard frissÃ­tve thumbnailokkal: ${scores.length} eredmÃ©ny`);
                
            } catch (error) {
                console.error('âŒ Leaderboard frissÃ­tÃ©si hiba:', error);
            }
        };

        // âœ… FELTÃ‰TELES AUTOMATIKUS FRISSÃTÃ‰S
        let refreshInterval = null;
        
        function startLocalRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (window.currentLeaderboardType === 'local') {
                    window.refreshLeaderboard();
                }
            }, 3000); // 3 mÃ¡sodpercenkÃ©nt
            console.log('âœ… Helyi leaderboard automatikus frissÃ­tÅ‘ elindÃ­tva');
        }
        
        function stopLocalRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('ğŸ›‘ Helyi leaderboard automatikus frissÃ­tÅ‘ leÃ¡llÃ­tva');
            }
        }

        // âœ… JAVÃTOTT SWITCHLEADERBOARD FÃœGGVÃ‰NY
        window.switchLeaderboard = function(type) {
            console.log('ğŸ”„ HTML switchLeaderboard hÃ­vÃ¡s:', type);
            
            // âœ… AZONNAL BEÃLLÃTJUK A TÃPUST
            window.currentLeaderboardType = type;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const targetTab = document.getElementById(type + 'Tab');
            if (targetTab) targetTab.classList.add('active');
            
            const listContainer = document.getElementById('leaderboardList');
            const statusContainer = document.getElementById('leaderboardStatus');
            
            if (statusContainer) {
                statusContainer.textContent = type === 'local' ? 'ğŸ“± Helyi eredmÃ©nyek' : 'ğŸŒ GlobÃ¡lis eredmÃ©nyek';
            }
            
            if (listContainer) {
                if (type === 'local') {
                    startLocalRefresh(); // Helyi frissÃ­tÅ‘ bekapcsolÃ¡sa
                    window.refreshLeaderboard();
                } else {
                    stopLocalRefresh(); // Helyi frissÃ­tÅ‘ kikapcsolÃ¡sa
                    window.loadGlobalLeaderboard();
                }
            }
        };

        // IndÃ­tÃ¡s
        setTimeout(startLocalRefresh, 2000);
    </script>

    <!-- SHOWSCORE FELÃœLÃRÃSA FIREBASE MENTÃ‰SSEL -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('ğŸ”„ showScore felÃ¼lÃ­rÃ¡sa Firebase tÃ¡mogatÃ¡ssal...');
                
                // ÃšJ showScore fÃ¼ggvÃ©ny Firebase mentÃ©ssel
                window.showScore = async function(score, analysis, transformationName = '') {
                    console.log('ğŸ† ÃšJ showScore hÃ­vva Firebase mentÃ©ssel:', { score, analysis, transformationName });
                    
                    try {
                        // Score validÃ¡lÃ¡s
                        const roundedScore = Math.round(Number(score));
                        if (isNaN(roundedScore)) {
                            console.error('âŒ Ã‰rvÃ©nytelen score:', score);
                            return;
                        }
                        
                        // SCORE ANIMÃCIÃ“ INDÃTÃSA
                        if (window.ScoreAnimator) {
                            window.ScoreAnimator.animateScore(roundedScore, analysis, transformationName);
                            window.ScoreAnimator.vibrate(roundedScore);
                        }
                        
                        // UI elemek frissÃ­tÃ©se
                        setTimeout(() => {
                            const elements = {
                                scoreDisplay: document.getElementById('scoreDisplay'),
                                finalScore: document.getElementById('finalScore'),
                                currentScore: document.getElementById('currentScore'),
                                scoreBreakdown: document.getElementById('scoreBreakdown')
                            };
                            
                            if (elements.finalScore) elements.finalScore.textContent = roundedScore;
                            if (elements.currentScore) elements.currentScore.textContent = roundedScore;
                            
                            if (elements.scoreBreakdown && analysis) {
                                let breakdownHTML = '';
                                if (analysis.shape !== undefined) breakdownHTML += `<div>ğŸ”µ KÃ¶ralak: ${Math.round(analysis.shape)}/40</div>`;
                                if (analysis.closure !== undefined) breakdownHTML += `<div>ğŸ”— ZÃ¡rÃ³dÃ¡s: ${Math.round(analysis.closure)}/20</div>`;
                                if (analysis.smoothness !== undefined) breakdownHTML += `<div>ğŸŒŠ EgyenletessÃ©g: ${Math.round(analysis.smoothness)}/25</div>`;
                                if (analysis.size !== undefined) breakdownHTML += `<div>ğŸ“ MÃ©ret: ${Math.round(analysis.size)}/15</div>`;
                                elements.scoreBreakdown.innerHTML = breakdownHTML;
                            }
                            
                            if (elements.scoreDisplay) {
                                elements.scoreDisplay.style.display = 'block';
                                elements.scoreDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 2500);
                        
                        // THUMBNAIL KÃ‰SZÃTÃ‰SE Ã‰S MENTÃ‰S
                        if (roundedScore > 0 && window.ScoreManager && window.ThumbnailGenerator) {
                            console.log('ğŸ’¾ Score mentÃ©se thumbnaillal Ã©s Firebase-be...');
                            
                            const thumbnail = await window.ThumbnailGenerator.captureTransformationThumbnail(1000);
                            const difficulty = window.gameEngine?.getDifficulty() || 'easy';
                            const playerName = document.getElementById('playerName')?.value?.trim() || 'NÃ©vtelen';
                            
                            // Helyi mentÃ©s
                            let savedScore;
                            if (window.ScoreManager.saveScore.length >= 5) {
                                savedScore = window.ScoreManager.saveScore(
                                    roundedScore,
                                    analysis,
                                    difficulty,
                                    transformationName,
                                    thumbnail
                                );
                            } else {
                                savedScore = window.ScoreManager.saveScore(
                                    roundedScore,
                                    analysis,
                                    difficulty,
                                    transformationName
                                );
                                
                                if (thumbnail && savedScore && savedScore.id) {
                                    const scores = window.ScoreManager.getScores();
                                    const scoreIndex = scores.findIndex(s => s.id === savedScore.id);
                                    if (scoreIndex !== -1) {
                                        scores[scoreIndex].thumbnail = thumbnail;
                                        localStorage.setItem('perfectcircle_scores', JSON.stringify(scores));
                                    }
                                }
                            }
                            
                            // Firebase mentÃ©s
                            const firebaseData = {
                                playerName: playerName,
                                score: roundedScore,
                                difficulty: difficulty,
                                transformation: transformationName,
                                thumbnail: thumbnail
                            };
                            
                            const firebaseResult = await window.saveScoreToFirebase(firebaseData);
                            if (firebaseResult) {
                                console.log('âœ… Score mentve Firebase-be is:', firebaseResult);
                            }
                            
                            console.log('âœ… Score mentve thumbnaillal:', savedScore);
                            
                            // Thumbnail megjelenÃ­tÃ©se
                            setTimeout(() => {
                                const scoreDisplay = document.getElementById('scoreDisplay');
                                if (thumbnail && scoreDisplay) {
                                    window.ThumbnailGenerator.displayThumbnail(thumbnail, 'scoreDisplay', 'current-score-thumbnail');
                                }
                            }, 3000);
                            
                            // âœ… LEADERBOARD FRISSÃTÃ‰SE - CSAK HELYI MÃ“DBAN
                            setTimeout(() => {
                                if (window.currentLeaderboardType === 'local') {
                                    window.refreshLeaderboard();
                                    console.log('ğŸ”„ Helyi leaderboard frissÃ­tve showScore utÃ¡n');
                                } else {
                                    console.log('ğŸŒ GlobÃ¡lis mÃ³dban vagyunk, helyi leaderboard frissÃ­tÃ©s kihagyva');
                                }
                            }, 100);
                            
                            // StatisztikÃ¡k frissÃ­tÃ©se
                            setTimeout(() => {
                                if (window.updateStats) {
                                    window.updateStats();
                                }
                            }, 200);
                        }
                        
                    } catch (error) {
                        console.error('âŒ showScore hiba:', error);
                    }
                };
                
                console.log('âœ… showScore sikeresen felÃ¼lÃ­rva Firebase tÃ¡mogatÃ¡ssal');
                
            }, 1000);
        });
    </script>
<!-- RAJZ MÃ“D INTEGRÃCIÃ“ -->


    <!-- âœ… VISITOR COUNTER INICIALIZÃLÃS -->
    <script>
        // âœ… VISITOR COUNTER INICIALIZÃLÃS - JAVÃTOTT VERZIÃ“
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”„ VisitorCounter inicializÃ¡lÃ¡s indÃ­tÃ¡sa...');
            
            // VÃ¡rjunk egy kicsit, hogy minden script betÃ¶ltÅ‘djÃ¶n
            setTimeout(() => {
                initVisitorCounterWithRetry();
            }, 2000);
        });
        
        function initVisitorCounterWithRetry() {
            let attempts = 0;
            const maxAttempts = 20; // CsÃ¶kkentve
            
            const tryInit = () => {
                attempts++;
                console.log(`ğŸ”„ VisitorCounter kÃ­sÃ©rlet ${attempts}/${maxAttempts}...`);
                
                // EllenÅ‘rizzÃ¼k hogy lÃ©tezik-e a VisitorCounter
                if (window.VisitorCounter) {
                    console.log('âœ… VisitorCounter megtalÃ¡lva!');
                    console.log('- TÃ­pus:', typeof window.VisitorCounter);
                    console.log('- Init metÃ³dus:', typeof window.VisitorCounter.init);
                    
                    if (typeof window.VisitorCounter.init === 'function') {
                        console.log('ğŸš€ VisitorCounter.init() hÃ­vÃ¡sa...');
                        
                        window.VisitorCounter.init()
                            .then(() => {
                                console.log('âœ… VisitorCounter sikeresen inicializÃ¡lva!');
                            })
                            .catch(error => {
                                console.error('âŒ VisitorCounter init hiba:', error);
                                startFallbackCounter();
                            });
                        return;
                    } else {
                        console.error('âŒ VisitorCounter.init nem fÃ¼ggvÃ©ny!');
                    }
                }
                
                // Ha mÃ©g nem Ã©rhetÅ‘ el Ã©s van mÃ©g kÃ­sÃ©rlet
                if (attempts < maxAttempts) {
                    setTimeout(tryInit, 200);
                } else {
                    console.warn('âš ï¸ VisitorCounter nem talÃ¡lhatÃ³, fallback indÃ­tÃ¡sa...');
                    startFallbackCounter();
                }
            };
            
            tryInit();
        }
        
        function startFallbackCounter() {
            console.log('ğŸ”„ Fallback visitor counter indÃ­tÃ¡sa...');
            
            try {
                let visits = parseInt(localStorage.getItem('perfectcircle_visits') || '0');
                visits++;
                localStorage.setItem('perfectcircle_visits', visits.toString());
                localStorage.setItem('perfectcircle_last_visit', new Date().toISOString());
                
                if (!localStorage.getItem('perfectcircle_first_visit')) {
                    localStorage.setItem('perfectcircle_first_visit', new Date().toISOString());
                }
                
                const visitCountElement = document.getElementById('visitCount');
                if (visitCountElement) {
                    visitCountElement.textContent = visits;
                    console.log('âœ… Visitor count frissÃ­tve DOM-ban:', visits);
                } else {
                    console.error('âŒ visitCount elem nem talÃ¡lhatÃ³!');
                }
                
                console.log('ğŸ‘¥ Fallback lÃ¡togatÃ¡sszÃ¡mlÃ¡lÃ³ inicializÃ¡lva:', visits);
                
            } catch (error) {
                console.error('âŒ Fallback counter hiba:', error);
            }
        }
    </script>

    <!-- EGYÃ‰B SEGÃ‰DFÃœGGVÃ‰NYEK -->
    <script>
        window.updateStats = function() {
            console.log('ğŸ“Š updateStats called');
            
            if (window.ScoreManager) {
                const stats = window.ScoreManager.getStats();
                
                const currentScore = document.getElementById('currentScore');
                const bestScore = document.getElementById('bestScore');
                const gamesPlayed = document.getElementById('gamesPlayed');
                const averageScore = document.getElementById('averageScore');
                
                if (currentScore) currentScore.textContent = stats.currentScore || 0;
                if (bestScore) bestScore.textContent = stats.best || 0;
                if (gamesPlayed) gamesPlayed.textContent = stats.games || 0;
                if (averageScore) averageScore.textContent = Math.round(stats.average) || 0;
                
                console.log('âœ… StatisztikÃ¡k frissÃ­tve:', stats);
            } else {
                console.log('âš ï¸ ScoreManager nem elÃ©rhetÅ‘');
            }
        };

        window.showVisitStats = function() {
            console.log('ğŸ“Š LÃ¡togatÃ¡si statisztikÃ¡k lekÃ©rÃ©se...');
            
            if (window.VisitorCounter && typeof window.VisitorCounter.showStats === 'function') {
                // Firebase-alapÃº statisztikÃ¡k
                window.VisitorCounter.showStats();
            } else {
                // Fallback helyi statisztikÃ¡k
                const visitCount = localStorage.getItem('perfectcircle_visits') || 0;
                const firstVisit = localStorage.getItem('perfectcircle_first_visit');
                const lastVisit = localStorage.getItem('perfectcircle_last_visit');
                
                let message = `ğŸ‘¥ Helyi lÃ¡togatÃ¡si statisztikÃ¡k:\n\n`;
                message += `ğŸ”¢ Helyi lÃ¡togatÃ¡sok: ${visitCount}\n`;
                
                if (firstVisit) {
                    const firstDate = new Date(firstVisit);
                    message += `ğŸ†• ElsÅ‘ helyi lÃ¡togatÃ¡s: ${firstDate.toLocaleDateString('hu-HU')}\n`;
                }
                
                if (lastVisit) {
                    const lastDate = new Date(lastVisit);
                    message += `ğŸ• UtolsÃ³ lÃ¡togatÃ¡s: ${lastDate.toLocaleDateString('hu-HU')} ${lastDate.toLocaleTimeString('hu-HU')}\n\n`;
                }
                
                message += `âš ï¸ Firebase lÃ¡togatÃ¡sszÃ¡mlÃ¡lÃ³ nem elÃ©rhetÅ‘.`;
                
                alert(message);
            }
        };

        window.setDifficulty = function(level) {
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-difficulty="${level}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            localStorage.setItem('perfectcircle_difficulty', level);
            
            if (window.gameEngine && window.gameEngine.setDifficulty) {
                window.gameEngine.setDifficulty(level);
            }
            
            console.log(`âœ… NehÃ©zsÃ©g beÃ¡llÃ­tva: ${level}`);
        };
    </script>

    <!-- âœ… VISITOR COUNTER DEBUG -->
    <script>
        // âœ… VISITOR COUNTER DEBUG
        window.debugVisitorCounter = function() {
            console.log('ğŸ” === VISITOR COUNTER DEBUG ===');
            console.log('- window.VisitorCounter:', !!window.VisitorCounter);
            console.log('- VisitorCounter tÃ­pusa:', typeof window.VisitorCounter);
            console.log('- VisitorCounter.init:', typeof window.VisitorCounter?.init);
            
            if (window.VisitorCounter) {
                console.log('- VisitorCounter metÃ³dusok:', Object.getOwnPropertyNames(window.VisitorCounter));
            }
            
            // Script fÃ¡jlok ellenÅ‘rzÃ©se
            const scripts = Array.from(document.querySelectorAll('script[src]'));
            const visitorScript = scripts.find(s => s.src.includes('visitorCounter'));
            console.log('- VisitorCounter script betÃ¶ltve:', !!visitorScript);
            
            if (visitorScript) {
                console.log('- Script src:', visitorScript.src);
                console.log('- Script loaded:', !visitorScript.hasAttribute('async') || visitorScript.readyState === 'complete');
            }
            
            // Helyi adatok
            const localVisits = localStorage.getItem('perfectcircle_visits');
            console.log('- Helyi lÃ¡togatÃ¡sok:', localVisits);
            
            // DOM elem
            const visitElement = document.getElementById('visitCount');
            console.log('- Visit count elem:', !!visitElement);
            console.log('- Jelenlegi Ã©rtÃ©k:', visitElement?.textContent);
            
            console.log('=== DEBUG VÃ‰GE ===');
        };
        
        // Automatikus debug 3 mÃ¡sodperc utÃ¡n
        setTimeout(() => {
            console.log('ğŸ” Automatikus VisitorCounter debug...');
            window.debugVisitorCounter();
        }, 3000);
    </script>

    <!-- EMERGENCY BUTTON HANDLERS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ Emergency button handlers loading...');
            
            // Leaderboard tabok
            const localTab = document.getElementById('localTab');
            const globalTab = document.getElementById('globalTab');
            
            if (localTab) {
                localTab.addEventListener('click', function() {
                    console.log('Local tab clicked');
                    window.switchLeaderboard('local');
                });
            }
            
            if (globalTab) {
                globalTab.addEventListener('click', function() {
                    console.log('Global tab clicked');
                    window.switchLeaderboard('global');
                });
            }

            // Clear gomb
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    console.log('Clear button clicked');
                    if (window.gameEngine && typeof window.gameEngine.clearCanvas === 'function') {
                        window.gameEngine.clearCanvas();
                    } else {
                        console.log('GameEngine not ready');
                    }
                });
            }
            
            // Help gomb
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', function() {
                    console.log('Help button clicked');
                    alert('ğŸ¯ PERFECT CIRCLE\n\nRajzolj tÃ¶kÃ©letes kÃ¶rt egyetlen mozdulattal!\n\nğŸ® IrÃ¡nyÃ­tÃ¡s:\nâ€¢ EgÃ©r: Kattints Ã©s hÃºzd\nâ€¢ Mobil: Ã‰rintsd Ã©s hÃºzd\n\nğŸ† PontszÃ¡mÃ­tÃ¡s:\nâ€¢ KÃ¶ralak (40p)\nâ€¢ ZÃ¡rÃ³dÃ¡s (20p)\nâ€¢ EgyenletessÃ©g (25p)\nâ€¢ MÃ©ret (15p)\n\nSok sikert! ğŸ€');
                });
            }
            
            // Save Name gomb
            const saveNameBtn = document.getElementById('saveNameBtn');
            if (saveNameBtn) {
                saveNameBtn.addEventListener('click', function() {
                    console.log('Save name button clicked');
                    const input = document.getElementById('playerName');
                    const name = input ? input.value.trim() : '';
                    if (name) {
                        localStorage.setItem('perfectcircle_playername', name);
                        alert('NÃ©v mentve: ' + name + ' âœ…');
                    } else {
                        alert('KÃ©rlek add meg a neved! âŒ');
                    }
                });
            }
            
            // Clear Scores gomb
            const clearScoresBtn = document.getElementById('clearScoresBtn');
            if (clearScoresBtn) {
                clearScoresBtn.addEventListener('click', function() {
                    console.log('Clear scores button clicked');
                    if (confirm('Biztosan tÃ¶rÃ¶lni szeretnÃ©d az Ã¶sszes helyi eredmÃ©nyt?')) {
                        if (window.ScoreManager && window.ScoreManager.clearScores) {
                            window.ScoreManager.clearScores();
                            alert('Helyi eredmÃ©nyek tÃ¶rÃ¶lve! âœ…');
                            
                            // StatisztikÃ¡k frissÃ­tÃ©se
                            if (window.updateStats) {
                                window.updateStats();
                            }
                            
                            // Leaderboard frissÃ­tÃ©se
                            if (window.currentLeaderboardType === 'local') {
                                window.refreshLeaderboard();
                            }
                        } else {
                            alert('ScoreManager nem elÃ©rhetÅ‘! âŒ');
                        }
                    }
                });
            }
            
            console.log('âœ… Emergency button handlers loaded');
        });

        // Emergency global functions
        window.startDrawing = function() {
            console.log('Global startDrawing called');
            if (window.gameEngine && window.gameEngine.startDrawing) {
                window.gameEngine.startDrawing();
            } else {
                console.log('GameEngine not ready for startDrawing');
            }
        };

        window.clearCanvas = function() {
            console.log('Global clearCanvas called');
            if (window.gameEngine && window.gameEngine.clearCanvas) {
                window.gameEngine.clearCanvas();
            } else {
                console.log('GameEngine not ready for clearCanvas');
            }
        };

        window.showInstructions = function() {
            console.log('Global showInstructions called');
            alert('ğŸ¯ PERFECT CIRCLE\n\nRajzolj tÃ¶kÃ©letes kÃ¶rt egyetlen mozdulattal!');
        };

        window.savePlayerName = function() {
            console.log('Global savePlayerName called');
            const input = document.getElementById('playerName');
            const name = input ? input.value.trim() : '';
            if (name) {
                localStorage.setItem('perfectcircle_playername', name);
                alert('NÃ©v mentve: ' + name);
                return true;
            } else {
                alert('Add meg a neved!');
                return false;
            }
        };

        window.clearAllScores = function() {
            console.log('Global clearAllScores called');
            if (confirm('Biztosan tÃ¶rÃ¶lni szeretnÃ©d az Ã¶sszes helyi eredmÃ©nyt?')) {
                if (window.ScoreManager && window.ScoreManager.clearScores) {
                    window.ScoreManager.clearScores();
                    alert('Helyi eredmÃ©nyek tÃ¶rÃ¶lve!');
                    if (window.currentLeaderboardType === 'local') {
                        window.refreshLeaderboard();
                    }
                } else {
                    alert('ScoreManager nem elÃ©rhetÅ‘!');
                }
            }
        };
    </script>

</body>
</html>
