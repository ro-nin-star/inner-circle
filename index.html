<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Perfect Circle - Rajzolj T√∂k√©letes K√∂rt!</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">
    <style>
        /* Thumbnail st√≠lusok */
        .score-thumbnail, .leaderboard-thumbnail {
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .score-thumbnail:hover, .leaderboard-thumbnail:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
        }

        .current-score-thumbnail {
            margin-top: 10px;
            border: 3px solid #4CAF50;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        .no-thumbnail {
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            color: #999;
        }

        .score-entry {
            transition: background-color 0.2s;
        }

        .score-entry:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-entry:last-child {
            border-bottom: none;
        }

        .thumbnail-container {
            margin-right: 12px;
            flex-shrink: 0;
        }

        .entry-content {
            flex: 1;
            min-width: 0;
        }

        .entry-main {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .entry-details {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>

<body>
    <!-- Dekorat√≠v k√∂r√∂k -->
    <div class="decoration-circle"></div>
    <div class="decoration-circle"></div>
    <div class="decoration-circle"></div>

    <!-- ===== EZ A FELS≈ê FIX FEJL√âC, AMI MINDENT TARTALMAZ ===== -->
    <div class="top-fixed-header">
        <!-- Firebase Status -->
        <div class="firebase-status connecting" id="firebaseStatus" data-i18n="firebase.connecting">üü° Kapcsol√≥d√°s...</div>
        <!-- Nyelv v√°lt√≥ -->
        <div class="language-selector" id="languageSelector">
            <div class="current-language" onclick="window.i18nManager?.toggleLanguageMenu()">
                <span id="currentLanguageFlag">üá≠üá∫</span>
                <span id="currentLanguageCode">HU</span>
            </div>
            <div class="language-menu" id="languageMenu">
                <!-- Dinamikusan t√∂lt≈ëdik a JavaScript √°ltal -->
            </div>
        </div>
    </div>
    <!-- ==================================================== -->

    <div class="game-container" id="gameContainer">
        <h1 data-i18n="title">üéØ Perfect Circle</h1>
        <p class="subtitle" data-i18n="subtitle">Rajzolj a lehet≈ë legt√∂k√©letesebb k√∂rt egyetlen mozdulattal!</p>
        
        <div class="instructions">
            <strong data-i18n="instructions.title">Hogyan j√°tssz:</strong> 
            <span data-i18n="instructions.text">Kattints √©s h√∫zd az egeret (vagy √©rintsd √©s h√∫zd az ujjad) hogy egy k√∂rt rajzolj. Min√©l t√∂k√©letesebb a k√∂r√∂d, ann√°l t√∂bb pontot kapsz! A k√∂r var√°zslatos m√≥don √°t fog v√°ltozni! ‚ú®</span>
        </div>

        <!-- Offline notice -->
        <div class="offline-notice" id="offlineNotice">
            <span data-i18n="firebase.offlineNotice">‚ö†Ô∏è <strong>Offline m√≥d:</strong> A glob√°lis ranglista nem el√©rhet≈ë. Az eredm√©nyek helyben ment≈ëdnek.</span>
        </div>

        <!-- PLAYER NAME SECTION -->
        <div class="player-name-section">
            <label for="playerName"><strong data-i18n="player.label">üë§ J√°t√©kos n√©v:</strong></label>
            <input type="text" id="playerName" class="player-name-input" data-i18n="player.placeholder" placeholder="Add meg a neved" maxlength="20" value="">
            <button id="saveNameBtn" style="padding: 8px 16px; font-size: 12px;" data-i18n="buttons.save">üíæ Ment√©s</button>
        </div>

        <div class="difficulty-selector">
            <strong data-i18n="difficulty.label">Neh√©zs√©g:</strong>
            <button class="difficulty-btn active" onclick="setDifficulty('easy')" data-difficulty="easy" data-i18n="difficulty.easy">K√∂nny≈± üòä</button>
            <button class="difficulty-btn" onclick="setDifficulty('hard')" data-difficulty="hard" data-i18n="difficulty.hard">Neh√©z üåÄ</button>
        </div>

        <div class="game-stats" id="gameStats">
            <div class="stat" id="currentScoreStat">
                <div class="stat-label" data-i18n="stats.currentScore">Jelenlegi Pontsz√°m</div>
                <div class="stat-value" id="currentScore">0</div>
            </div>
            <div class="stat" id="bestScoreStat">
                <div class="stat-label" data-i18n="stats.bestScore">Legjobb Eredm√©ny</div>
                <div class="stat-value" id="bestScore">0</div>
            </div>
            <div class="stat" id="gamesPlayedStat">
                <div class="stat-label" data-i18n="stats.gamesPlayed">J√°t√©kok Sz√°ma</div>
                <div class="stat-value" id="gamesPlayed">0</div>
            </div>
            <div class="stat" id="averageScoreStat">
                <div class="stat-label" data-i18n="stats.averageScore">√Åtlag Pontsz√°m</div>
                <div class="stat-value" id="averageScore">0</div>
            </div>
        </div>

        <!-- Canvas container -->
        <div class="canvas-container">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <canvas id="idealCircleCanvas" width="400" height="400"></canvas>
            <div class="canvas-overlay" id="canvasOverlay"></div>
            <div class="transformation-overlay" id="transformationOverlay">
                <div class="transformation-content">
                    <h2 id="transformationText" data-i18n="transformation.magic">‚ú® Var√°zslat t√∂rt√©nik... ‚ú®</h2>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" data-i18n="buttons.startDrawing">üéØ Rajzol√°s Kezd√©se</button>
            <button id="clearBtn" disabled data-i18n="buttons.clear">üóëÔ∏è T√∂rl√©s</button>
            <button id="helpBtn" data-i18n="buttons.help">‚ùì Seg√≠ts√©g</button>
            <button id="clearScoresBtn" data-i18n="buttons.clearScores">üóëÔ∏è Helyi Eredm√©nyek T√∂rl√©se</button>
        </div>

        <!-- Pontsz√°m megjelen√≠t≈ë -->
        <div class="score-display" id="scoreDisplay">
            <h3 id="scoreTitle" data-i18n="scoreTitle.result">Eredm√©ny</h3>
            <div class="score-number">
                <span id="finalScore">0</span>/100 <span data-i18n="common.points">pont</span>
            </div>
            <div class="score-breakdown" id="scoreBreakdown">
                <!-- Dinamikusan t√∂lt≈ëdik -->
            </div>
            
            <!-- Ide√°lis k√∂r √∂sszehasonl√≠t√°s -->
            <div id="idealCircleContainer" class="ideal-circle-container" style="display: none;">
                <h4 data-i18n="analysis.idealCircle">Ide√°lis k√∂r √∂sszehasonl√≠t√°s:</h4>
                <div class="ideal-circle-canvas-container">
                    <canvas id="idealComparisonCanvas" width="200" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD WITH TABS -->
        <div class="leaderboard">
            <h3 data-i18n="leaderboard.title">üèÜ Ranglista</h3>
            <div class="leaderboard-tabs">
                <button id="localTab" class="tab-btn active">
                    üì± Helyi
                </button>
                <button id="globalTab" class="tab-btn">
                    üåç Glob√°lis
                </button>
            </div>

            <div class="leaderboard-status" id="leaderboardStatus" data-i18n="leaderboard.localResults">
                üì± Helyi eredm√©nyek
            </div>
            <div id="leaderboardList">
                <div class="score-entry">
                    <span data-i18n="leaderboard.noResults">M√©g nincsenek eredm√©nyek</span>
                </div>
            </div>
        </div>

        <!-- R√©szletes instrukci√≥k -->
        <div class="detailed-instructions">
            <h3 data-i18n="instructions.detailedTitle">üìñ R√©szletes √ötmutat√≥</h3>
            <div class="instruction-section">
                <h4 data-i18n="instructions.gameplayTitle">üéÆ J√°t√©kmenet:</h4>
                <ul>
                    <li data-i18n="instructions.step1">Kattints a "Rajzol√°s Kezd√©se" gombra</li>
                    <li data-i18n="instructions.step2">Rajzolj egy k√∂rt egyetlen mozdulattal</li>
                    <li data-i18n="instructions.step3">N√©zd meg az eredm√©nyed √©s a transzform√°ci√≥t!</li>
                </ul>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.scoringTitle">üìä Pontsz√°m√≠t√°s:</h4>
                <ul>
                    <li data-i18n="instructions.shapeScore">üîµ K√∂ralak (40 pont): Mennyire hasonl√≠t k√∂rre</li>
                    <li data-i18n="instructions.closureScore">üîó Z√°r√≥d√°s (20 pont): Mennyire z√°rt a forma</li>
                    <li data-i18n="instructions.smoothnessScore">üåä Egyenletess√©g (25 pont): Mennyire egyenletes a vonal</li>
                    <li data-i18n="instructions.sizeScore">üìè M√©ret (15 pont): Optim√°lis m√©ret haszn√°lata</li>
                </ul>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.transformationsTitle">üé® Transzform√°ci√≥k:</h4>
                <p data-i18n="instructions.transformationsText">70+ pont eset√©n a k√∂r√∂d var√°zslatos alakzatt√° v√°ltozik! Minden transzform√°ci√≥ ut√°n egy mosolyg√≥ arc jelenik meg! üòä</p>
            </div>
            
            <div class="instruction-section">
                <h4 data-i18n="instructions.controlsTitle">‚å®Ô∏è Billenty≈± parancsok:</h4>
                <ul>
                    <li data-i18n="instructions.ctrlS">Ctrl+S: Rajzol√°s kezd√©se</li>
                    <li data-i18n="instructions.ctrlR">Ctrl+R: T√∂rl√©s</li>
                    <li data-i18n="instructions.ctrlH">Ctrl+H: Seg√≠ts√©g</li>
                    <li data-i18n="instructions.ctrlL">Ctrl+L: Nyelv men√º</li>
                    <li data-i18n="instructions.escape">Esc: J√°t√©k megszak√≠t√°sa</li>
                    <li data-i18n="instructions.f1">F1: Seg√≠ts√©g</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- L√°togat√°ssz√°ml√°l√≥ -->
    <div class="visitor-counter" id="visitorCounter" onclick="showVisitStats()">
        <span data-i18n="visitors.label">L√°togat√°sok:</span> <span class="visitor-number" id="visitCount">0</span>
    </div>

    <!-- Fejleszt≈ëi inform√°ci√≥k -->
    <div class="dev-info">
        <span data-i18n="dev.version">v2.0</span> | 
        <span onclick="window.debugGameEngine?.()" data-i18n="dev.debug">Debug</span>
    </div>

    <!-- JavaScript f√°jlok bet√∂lt√©se -->
    <script>
        // Glob√°lis nyelvi adatok t√°rol√≥ja
        window.languageData = {};
        
        // Magyar nyelv be√°gyaz√°sa
        window.languageData.hu = {
            // ... (az el≈ëz≈ë teljes magyar ford√≠t√°s)
        };
    </script>

    <!-- THUMBNAIL GENERATOR BE√ÅGYAZVA -->
    <script>
        // js/utils/thumbnailGenerator.js - BE√ÅGYAZVA

        window.ThumbnailGenerator = {
            
            // Canvas tartalom ment√©se thumbnail-k√©nt
            captureCanvasThumbnail: function(canvasId, maxWidth = 100, maxHeight = 100, quality = 0.8) {
                try {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) {
                        console.error('‚ùå Canvas nem tal√°lhat√≥:', canvasId);
                        return null;
                    }
                    
                    // Thumbnail canvas l√©trehoz√°sa
                    const thumbCanvas = document.createElement('canvas');
                    const thumbCtx = thumbCanvas.getContext('2d');
                    
                    // Ar√°nyos √°tm√©retez√©s sz√°m√≠t√°sa
                    const originalWidth = canvas.width;
                    const originalHeight = canvas.height;
                    const aspectRatio = originalWidth / originalHeight;
                    
                    let thumbWidth = maxWidth;
                    let thumbHeight = maxHeight;
                    
                    if (aspectRatio > 1) {
                        thumbHeight = maxWidth / aspectRatio;
                    } else {
                        thumbWidth = maxHeight * aspectRatio;
                    }
                    
                    thumbCanvas.width = Math.round(thumbWidth);
                    thumbCanvas.height = Math.round(thumbHeight);
                    
                    // H√°tt√©r be√°ll√≠t√°sa (√°tl√°tsz√≥ helyett feh√©r)
                    thumbCtx.fillStyle = '#ffffff';
                    thumbCtx.fillRect(0, 0, thumbCanvas.width, thumbCanvas.height);
                    
                    // Eredeti canvas tartalom √°tm√°sol√°sa
                    thumbCtx.drawImage(canvas, 0, 0, thumbCanvas.width, thumbCanvas.height);
                    
                    // Base64 string visszaad√°sa
                    const thumbnailData = thumbCanvas.toDataURL('image/jpeg', quality);
                    
                    console.log('‚úÖ Thumbnail k√©sz√≠tve:', {
                        originalSize: `${originalWidth}x${originalHeight}`,
                        thumbnailSize: `${thumbCanvas.width}x${thumbCanvas.height}`,
                        dataSize: Math.round(thumbnailData.length / 1024) + 'KB'
                    });
                    
                    return thumbnailData;
                    
                } catch (error) {
                    console.error('‚ùå Thumbnail k√©sz√≠t√©si hiba:', error);
                    return null;
                }
            },

            // Transzform√°ci√≥ ut√°n thumbnail k√©sz√≠t√©s
            captureTransformationThumbnail: function(delay = 500) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Pr√≥b√°ljuk meg a gameCanvas-r√≥l
                        let thumbnail = this.captureCanvasThumbnail('gameCanvas');
                        
                        // Ha nincs, pr√≥b√°ljuk az idealCircleCanvas-r√≥l
                        if (!thumbnail) {
                            thumbnail = this.captureCanvasThumbnail('idealCircleCanvas');
                        }
                        
                        resolve(thumbnail);
                    }, delay);
                });
            },

            // Thumbnail megjelen√≠t√©se DOM elemben
            displayThumbnail: function(thumbnailData, containerId, className = 'score-thumbnail') {
                try {
                    if (!thumbnailData) return false;
                    
                    const container = document.getElementById(containerId);
                    if (!container) return false;
                    
                    // Megl√©v≈ë thumbnail elt√°vol√≠t√°sa
                    const existingThumbnail = container.querySelector('.' + className);
                    if (existingThumbnail) {
                        existingThumbnail.remove();
                    }
                    
                    // √öj thumbnail elem l√©trehoz√°sa
                    const img = document.createElement('img');
                    img.src = thumbnailData;
                    img.className = className;
                    img.style.cssText = `
                        width: 60px;
                        height: 60px;
                        object-fit: cover;
                        border-radius: 8px;
                        border: 2px solid #ddd;
                        margin-left: 10px;
                        cursor: pointer;
                        transition: transform 0.2s;
                    `;
                    
                    // Hover effekt
                    img.addEventListener('mouseenter', () => {
                        img.style.transform = 'scale(1.1)';
                    });
                    
                    img.addEventListener('mouseleave', () => {
                        img.style.transform = 'scale(1)';
                    });
                    
                    // Kattint√°sra nagy√≠t√°s
                    img.addEventListener('click', () => {
                        this.showThumbnailModal(thumbnailData);
                    });
                    
                    container.appendChild(img);
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Thumbnail megjelen√≠t√©si hiba:', error);
                    return false;
                }
            },

            // Thumbnail modal megjelen√≠t√©se
            showThumbnailModal: function(thumbnailData) {
                // Modal l√©trehoz√°sa
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    cursor: pointer;
                `;
                
                const img = document.createElement('img');
                img.src = thumbnailData;
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                `;
                
                modal.appendChild(img);
                document.body.appendChild(modal);
                
                // Kattint√°sra bez√°r√°s
                modal.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // ESC billenty≈±re bez√°r√°s
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }
        };

        console.log('‚úÖ ThumbnailGenerator bet√∂ltve');
    </script>

    <script src="js/i18n/languageDetector.js"></script>
    <script src="js/i18n/i18nManager.js"></script>
    
    <!-- Firebase Scripts -->
    <script src="js/firebase/firebase-config.js" type="module"></script>
    
    <!-- Utility Scripts -->
    <script src="js/utils/audioManager.js"></script>
    <script src="js/utils/effectsManager.js"></script>
    
    <!-- Game Scripts -->
    <script src="js/game/transformations.js"></script>
    <script src="js/game/circleAnalyzer.js"></script>
    <script src="js/game/gameEngine.js"></script>
    
    <!-- Manager Scripts -->
    <script src="js/managers/scoreManager.js"></script>
    <script src="js/managers/visitorCounter.js"></script>
    <script src="js/managers/leaderboardManager.js"></script>

    <script src="leaderboard-fix.js"></script>

    <!-- Main App Script UTOLJ√ÅRA -->
    <script src="js/app.js"></script>

    <!-- Inicializ√°l√°s -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåç DOM bet√∂ltve, i18n inicializ√°l√°s...');
            
            if (window.languageData && window.languageData.hu) {
                window.simpleTranslate = function(key, params = {}) {
                    const keys = key.split('.');
                    let value = window.languageData.hu;
                    
                    for (const k of keys) {
                        if (value && typeof value === 'object' && value[k] !== undefined) {
                            value = value[k];
                        } else {
                            return key;
                        }
                    }
                    
                    if (typeof value === 'string' && params) {
                        Object.keys(params).forEach(param => {
                            value = value.replace(`{${param}}`, params[param]);
                        });
                    }
                    
                    return value;
                };
                
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const translation = window.simpleTranslate(key);
                    
                    if (translation && translation !== key) {
                        if (element.tagName === 'INPUT' && element.type === 'text') {
                            element.placeholder = translation;
                        } else {
                            element.innerHTML = translation;
                        }
                    }
                });
                
                console.log('‚úÖ Egyszer≈±s√≠tett i18n inicializ√°lva');
            }
        });
    </script>

    <!-- EMERGENCY BUTTON HANDLERS -->
    <script>
        // AUTOMATIKUS LEADERBOARD FRISS√çT≈ê THUMBNAILOKKAL
        window.refreshLeaderboard = function() {
            try {
                const leaderboardList = document.getElementById('leaderboardList');
                const leaderboardStatus = document.getElementById('leaderboardStatus');
                
                if (!leaderboardList || !window.ScoreManager) return;
                
                const scores = window.ScoreManager.getScores();
                
                // Status friss√≠t√©s
                if (leaderboardStatus) {
                    leaderboardStatus.textContent = `üì± ${scores.length} helyi eredm√©ny`;
                }
                
                // Lista friss√≠t√©s
                if (scores.length === 0) {
                    leaderboardList.innerHTML = `
                        <div class="score-entry">
                            <span>M√©g nincsenek eredm√©nyek</span>
                        </div>
                    `;
                } else {
                    leaderboardList.innerHTML = scores.map((score, index) => {
                        const thumbnailHTML = score.thumbnail ? 
                            `<div class="thumbnail-container">
                                <img src="${score.thumbnail}" 
                                     class="leaderboard-thumbnail" 
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer;" 
                                     onclick="window.ThumbnailGenerator.showThumbnailModal('${score.thumbnail}')"
                                     title="Kattints a nagy√≠t√°shoz">
                            </div>` : 
                            `<div class="thumbnail-container">
                                <div class="no-thumbnail" style="width: 40px; height: 40px; background: linear-gradient(45deg, #f0f0f0, #e0e0e0); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">üé®</div>
                            </div>`;
                        
                        return `
                            <div class="leaderboard-entry" data-score-id="${score.id}">
                                ${thumbnailHTML}
                                <div class="entry-content">
                                    <div class="entry-main">
                                        <span class="rank" style="font-weight: bold; color: #666; min-width: 30px;">#${index + 1}</span>
                                        <span class="name" style="font-weight: 500; color: #333; margin-right: 8px;">${score.playerName || 'N√©vtelen'}</span>
                                        <span class="score" style="font-weight: bold; color: #4CAF50; margin-left: auto;">${score.score} pont</span>
                                    </div>
                                    <div class="entry-details">
                                        <span style="color: #888;">${score.date || 'Ma'}</span>
                                        ${score.transformation ? ` ‚Ä¢ <span style="color: #666;">üé® ${score.transformation}</span>` : ''}
                                        ${score.difficulty && score.difficulty !== 'easy' ? ` ‚Ä¢ <span style="color: #ff9800;">üåÄ ${score.difficulty}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log(`‚úÖ Leaderboard friss√≠tve thumbnailokkal: ${scores.length} eredm√©ny`);
                
            } catch (error) {
                console.error('‚ùå Leaderboard friss√≠t√©si hiba:', error);
            }
        };

        // Automatikus friss√≠t√©s ind√≠t√°sa
        setInterval(window.refreshLeaderboard, 2000);
        console.log('‚úÖ Automatikus leaderboard friss√≠t≈ë be√°ll√≠tva');

        // SHOWSCORE FEL√úL√çR√ÅSA THUMBNAIL T√ÅMOGAT√ÅSSAL
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('üîÑ showScore fel√ºl√≠r√°sa thumbnail t√°mogat√°ssal...');
                
                // Eredeti showScore ment√©se
                const originalShowScore = window.showScore;
                
                // √öJ showScore f√ºggv√©ny
// A showScore f√ºggv√©nyt m√≥dos√≠tsd √≠gy:
window.showScore = async function(score, analysis, transformationName = '') {
    console.log('üèÜ √öJ showScore h√≠vva thumbnaillal:', { score, analysis, transformationName });
    
    try {
        // Score valid√°l√°s
        const roundedScore = Math.round(Number(score));
        if (isNaN(roundedScore)) {
            console.error('‚ùå √ârv√©nytelen score:', score);
            return;
        }
        
        // SCORE ANIM√ÅCI√ì IND√çT√ÅSA - AZONNAL!
        if (window.ScoreAnimator) {
            window.ScoreAnimator.animateScore(roundedScore, analysis, transformationName);
            window.ScoreAnimator.vibrate(roundedScore);
        }
        
        // UI elemek (kicsit k√©s≈ëbb)
        setTimeout(() => {
            const elements = {
                scoreDisplay: document.getElementById('scoreDisplay'),
                finalScore: document.getElementById('finalScore'),
                currentScore: document.getElementById('currentScore'),
                scoreBreakdown: document.getElementById('scoreBreakdown')
            };
            
            // Score megjelen√≠t√©s
            if (elements.finalScore) elements.finalScore.textContent = roundedScore;
            if (elements.currentScore) elements.currentScore.textContent = roundedScore;
            
            // Breakdown megjelen√≠t√©s
            if (elements.scoreBreakdown && analysis) {
                let breakdownHTML = '';
                if (analysis.shape !== undefined) breakdownHTML += `<div>üîµ K√∂ralak: ${Math.round(analysis.shape)}/40</div>`;
                if (analysis.closure !== undefined) breakdownHTML += `<div>üîó Z√°r√≥d√°s: ${Math.round(analysis.closure)}/20</div>`;
                if (analysis.smoothness !== undefined) breakdownHTML += `<div>üåä Egyenletess√©g: ${Math.round(analysis.smoothness)}/25</div>`;
                if (analysis.size !== undefined) breakdownHTML += `<div>üìè M√©ret: ${Math.round(analysis.size)}/15</div>`;
                elements.scoreBreakdown.innerHTML = breakdownHTML;
            }
            
            // Score display megjelen√≠t√©se
            if (elements.scoreDisplay) {
                elements.scoreDisplay.style.display = 'block';
                elements.scoreDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 2500); // 2.5 m√°sodperc ut√°n jelennek meg a r√©szletek
        
        // THUMBNAIL K√âSZ√çT√âSE √âS MENT√âS
        if (roundedScore > 0 && window.ScoreManager && window.ThumbnailGenerator) {
            console.log('üíæ Score ment√©se thumbnaillal...');
            
            // V√°runk egy kicsit, hogy a transzform√°ci√≥ befejez≈ëdj√∂n
            const thumbnail = await window.ThumbnailGenerator.captureTransformationThumbnail(1000);
            
            const difficulty = window.gameEngine?.getDifficulty() || 'easy';
            
            // Score ment√©s...
            let savedScore;
            if (window.ScoreManager.saveScore.length >= 5) {
                savedScore = window.ScoreManager.saveScore(
                    roundedScore,
                    analysis,
                    difficulty,
                    transformationName,
                    thumbnail
                );
            } else {
                savedScore = window.ScoreManager.saveScore(
                    roundedScore,
                    analysis,
                    difficulty,
                    transformationName
                );
                
                if (thumbnail && savedScore && savedScore.id) {
                    const scores = window.ScoreManager.getScores();
                    const scoreIndex = scores.findIndex(s => s.id === savedScore.id);
                    if (scoreIndex !== -1) {
                        scores[scoreIndex].thumbnail = thumbnail;
                        localStorage.setItem('perfectcircle_scores', JSON.stringify(scores));
                    }
                }
            }
            
            console.log('‚úÖ Score mentve thumbnaillal:', savedScore);
            
            // Thumbnail megjelen√≠t√©se a score display-ben (k√©s≈ëbb)
            setTimeout(() => {
                const elements = {
                    scoreDisplay: document.getElementById('scoreDisplay')
                };
                if (thumbnail && elements.scoreDisplay) {
                    window.ThumbnailGenerator.displayThumbnail(thumbnail, 'scoreDisplay', 'current-score-thumbnail');
                }
            }, 3000);
            
            // LEADERBOARD AZONNALI FRISS√çT√âSE
            setTimeout(() => {
                window.refreshLeaderboard();
                console.log('üîÑ Leaderboard friss√≠tve showScore ut√°n');
            }, 100);
            
            // Statisztik√°k friss√≠t√©se
            setTimeout(() => {
                if (window.updateStats) {
                    window.updateStats();
                }
            }, 200);
        }
        
    } catch (error) {
        console.error('‚ùå showScore hiba:', error);
    }
};

                
                console.log('‚úÖ showScore sikeresen fel√ºl√≠rva thumbnail t√°mogat√°ssal');
                
            }, 1000); // 1 m√°sodperc v√°rakoz√°s
        });

        // EGY√âB SEG√âDF√úGGV√âNYEK
        window.updateStats = function() {
            console.log('üìä updateStats called');
            
            if (window.ScoreManager) {
                const stats = window.ScoreManager.getStats();
                
                const currentScore = document.getElementById('currentScore');
                const bestScore = document.getElementById('bestScore');
                const gamesPlayed = document.getElementById('gamesPlayed');
                const averageScore = document.getElementById('averageScore');
                
                if (currentScore) currentScore.textContent = stats.currentScore || 0;
                if (bestScore) bestScore.textContent = stats.best || 0;
                if (gamesPlayed) gamesPlayed.textContent = stats.games || 0;
                if (averageScore) averageScore.textContent = Math.round(stats.average) || 0;
                
                console.log('‚úÖ Statisztik√°k friss√≠tve:', stats);
            } else {
                console.log('‚ö†Ô∏è ScoreManager nem el√©rhet≈ë');
            }
        };

        window.showVisitStats = function() {
            const visitCount = localStorage.getItem('perfectcircle_visits') || 0;
            const firstVisit = localStorage.getItem('perfectcircle_first_visit');
            const lastVisit = localStorage.getItem('perfectcircle_last_visit');
            
            let message = `üë• L√°togat√°si statisztik√°k:\n\n`;
            message += `üî¢ √ñsszes l√°togat√°s: ${visitCount}\n`;
            
            if (firstVisit) {
                const firstDate = new Date(firstVisit);
                message += `üÜï Els≈ë l√°togat√°s: ${firstDate.toLocaleDateString('hu-HU')}\n`;
            }
            
            if (lastVisit) {
                const lastDate = new Date(lastVisit);
                message += `üïê Utols√≥ l√°togat√°s: ${lastDate.toLocaleDateString('hu-HU')} ${lastDate.toLocaleTimeString('hu-HU')}`;
            }
            
            alert(message);
        };

        window.setDifficulty = function(level) {
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-difficulty="${level}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            localStorage.setItem('perfectcircle_difficulty', level);
            
            if (window.gameEngine && window.gameEngine.setDifficulty) {
                window.gameEngine.setDifficulty(level);
            }
            
            console.log(`‚úÖ Neh√©zs√©g be√°ll√≠tva: ${level}`);
        };

        // VISITOR COUNTER INICIALIZ√ÅL√ÅS
        window.initVisitorCounter = function() {
            let visits = parseInt(localStorage.getItem('perfectcircle_visits') || '0');
            visits++;
            localStorage.setItem('perfectcircle_visits', visits.toString());
            localStorage.setItem('perfectcircle_last_visit', new Date().toISOString());
            
            if (!localStorage.getItem('perfectcircle_first_visit')) {
                localStorage.setItem('perfectcircle_first_visit', new Date().toISOString());
            }
            
            const visitCountElement = document.getElementById('visitCount');
            if (visitCountElement) {
                visitCountElement.textContent = visits;
            }
            
            console.log('üë• L√°togat√°ssz√°ml√°l√≥:', visits);
        };

        // Visitor counter ind√≠t√°sa
        window.initVisitorCounter();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Emergency button handlers loading...');
            
            // Leaderboard tabok
            const localTab = document.getElementById('localTab');
            const globalTab = document.getElementById('globalTab');
            
            if (localTab) {
                localTab.addEventListener('click', function() {
                    console.log('Local tab clicked');
                    
                    // Tab v√°lt√°s
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Lista friss√≠t√©s
                    const list = document.getElementById('leaderboardList');
                    const status = document.getElementById('leaderboardStatus');
                    
                    if (status) status.textContent = 'üì± Helyi eredm√©nyek';
                    if (list) {
                        if (window.perfectCircleApp && window.perfectCircleApp.loadLocalLeaderboard) {
                            window.perfectCircleApp.loadLocalLeaderboard();
                        } else {
                            window.refreshLeaderboard();
                        }
                    }
                });
            }
            
            if (globalTab) {
                globalTab.addEventListener('click', function() {
                    console.log('Global tab clicked');
                    
                    // Tab v√°lt√°s
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Lista friss√≠t√©s
                    const list = document.getElementById('leaderboardList');
                    const status = document.getElementById('leaderboardStatus');
                    
                    if (status) status.textContent = 'üåç Glob√°lis eredm√©nyek';
                    if (list) {
                        if (window.perfectCircleApp && window.perfectCircleApp.loadGlobalLeaderboard) {
                            window.perfectCircleApp.loadGlobalLeaderboard();
                        } else {
                            list.innerHTML = '<div class="score-entry">üåç Glob√°lis eredm√©nyek bet√∂lt√©se...</div>';
                        }
                    }
                });
            }
            
            // Start gomb
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    console.log('Start button clicked');
                    if (window.gameEngine && typeof window.gameEngine.startDrawing === 'function') {
                        window.gameEngine.startDrawing();
                    } else {
                        console.log('GameEngine not ready');
                    }
                });
            }
            
            // Clear gomb
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    console.log('Clear button clicked');
                    if (window.gameEngine && typeof window.gameEngine.clearCanvas === 'function') {
                        window.gameEngine.clearCanvas();
                    } else {
                        console.log('GameEngine not ready');
                    }
                });
            }
            
            // Help gomb
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', function() {
                    console.log('Help button clicked');
                    alert('üéØ PERFECT CIRCLE\n\nRajzolj t√∂k√©letes k√∂rt egyetlen mozdulattal!\n\nüéÆ Ir√°ny√≠t√°s:\n‚Ä¢ Eg√©r: Kattints √©s h√∫zd\n‚Ä¢ Mobil: √ârintsd √©s h√∫zd\n\nüèÜ Pontsz√°m√≠t√°s:\n‚Ä¢ K√∂ralak (40p)\n‚Ä¢ Z√°r√≥d√°s (20p)\n‚Ä¢ Egyenletess√©g (25p)\n‚Ä¢ M√©ret (15p)\n\nSok sikert! üçÄ');
                });
            }
            
            // Save Name gomb
            const saveNameBtn = document.getElementById('saveNameBtn');
            if (saveNameBtn) {
                saveNameBtn.addEventListener('click', function() {
                    console.log('Save name button clicked');
                    const input = document.getElementById('playerName');
                    const name = input ? input.value.trim() : '';
                    if (name) {
                        localStorage.setItem('perfectcircle_playername', name);
                        alert('N√©v mentve: ' + name + ' ‚úÖ');
                    } else {
                        alert('K√©rlek add meg a neved! ‚ùå');
                    }
                });
            }
            
            // Clear Scores gomb
            const clearScoresBtn = document.getElementById('clearScoresBtn');
            if (clearScoresBtn) {
                clearScoresBtn.addEventListener('click', function() {
                    console.log('Clear scores button clicked');
                    if (confirm('Biztosan t√∂r√∂lni szeretn√©d az √∂sszes helyi eredm√©nyt?')) {
                        if (window.ScoreManager && window.ScoreManager.clearScores) {
                            window.ScoreManager.clearScores();
                            alert('Helyi eredm√©nyek t√∂r√∂lve! ‚úÖ');
                            
                            // Statisztik√°k friss√≠t√©se
                            if (window.updateStats) {
                                window.updateStats();
                            }
                            
                            // Leaderboard friss√≠t√©se
                            window.refreshLeaderboard();
                        } else {
                            alert('ScoreManager nem el√©rhet≈ë! ‚ùå');
                        }
                    }
                });
            }
            
            console.log('‚úÖ Emergency button handlers loaded');
        });

        // Emergency global functions
        window.startDrawing = function() {
            console.log('Global startDrawing called');
            if (window.gameEngine && window.gameEngine.startDrawing) {
                window.gameEngine.startDrawing();
            } else {
                console.log('GameEngine not ready for startDrawing');
            }
        };

        window.clearCanvas = function() {
            console.log('Global clearCanvas called');
            if (window.gameEngine && window.gameEngine.clearCanvas) {
                window.gameEngine.clearCanvas();
            } else {
                console.log('GameEngine not ready for clearCanvas');
            }
        };

        window.showInstructions = function() {
            console.log('Global showInstructions called');
            alert('üéØ PERFECT CIRCLE\n\nRajzolj t√∂k√©letes k√∂rt egyetlen mozdulattal!');
        };

        window.savePlayerName = function() {
            console.log('Global savePlayerName called');
            const input = document.getElementById('playerName');
            const name = input ? input.value.trim() : '';
            if (name) {
                localStorage.setItem('perfectcircle_playername', name);
                alert('N√©v mentve: ' + name);
                return true;
            } else {
                alert('Add meg a neved!');
                return false;
            }
        };

        window.switchLeaderboard = function(type) {
            console.log('Global switchLeaderboard called:', type);
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const targetTab = document.getElementById(type + 'Tab');
            if (targetTab) targetTab.classList.add('active');
            
            const listContainer = document.getElementById('leaderboardList');
            const statusContainer = document.getElementById('leaderboardStatus');
            
            if (statusContainer) {
                statusContainer.textContent = type === 'local' ? 'üì± Helyi eredm√©nyek' : 'üåç Glob√°lis eredm√©nyek';
            }
            
            if (listContainer) {
                if (type === 'local') {
                    window.refreshLeaderboard();
                } else {
                    listContainer.innerHTML = '<div class="score-entry">üåç Glob√°lis eredm√©nyek bet√∂lt√©se...</div>';
                }
            }
        };

        window.clearAllScores = function() {
            console.log('Global clearAllScores called');
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d az √∂sszes helyi eredm√©nyt?')) {
                if (window.ScoreManager && window.ScoreManager.clearScores) {
                    window.ScoreManager.clearScores();
                    alert('Helyi eredm√©nyek t√∂r√∂lve!');
                    window.refreshLeaderboard();
                } else {
                    alert('ScoreManager nem el√©rhet≈ë!');
                }
            }
        };
    </script>
    <!-- SCORE ANIMATOR -->
<script>
window.ScoreAnimator = {
    
    // F≈ëbb anim√°ci√≥ ind√≠t√°sa
    animateScore: function(score, breakdown, transformationName = '') {
        console.log('üéâ Score anim√°ci√≥ ind√≠t√°sa:', score);
        
        try {
            // Score kateg√≥ria meghat√°roz√°sa
            const category = this.getScoreCategory(score);
            
            // Nagy score felfed√©s
            this.showBigScoreReveal(score, category);
            
            // R√©szletek anim√°l√°sa
            setTimeout(() => {
                this.animateScoreBreakdown(breakdown);
            }, 1500);
            
            // Egy√©b effektek
            setTimeout(() => {
                this.addScoreEffects(score, category);
            }, 500);
            
            // Score display anim√°l√°sa
            setTimeout(() => {
                this.animateScoreDisplay(score, category);
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Score anim√°ci√≥ hiba:', error);
        }
    },
    
    // Score kateg√≥ria meghat√°roz√°sa
    getScoreCategory: function(score) {
        if (score >= 95) return { name: 'perfect', text: 'T√ñK√âLETES!', emoji: 'üèÜ' };
        if (score >= 85) return { name: 'excellent', text: 'KIV√ÅL√ì!', emoji: '‚≠ê' };
        if (score >= 70) return { name: 'good', text: 'J√ì!', emoji: 'üëç' };
        if (score >= 50) return { name: 'fair', text: 'ELFOGADHAT√ì', emoji: 'üëå' };
        return { name: 'poor', text: 'GYAKOROLJ M√âG!', emoji: 'üí™' };
    },
    
    // Nagy score felfed√©s
    showBigScoreReveal: function(score, category) {
        // Overlay l√©trehoz√°sa
        const overlay = document.createElement('div');
        overlay.className = 'score-animation-overlay';
        
        // Score sz√∂veg
        const scoreText = document.createElement('div');
        scoreText.className = `score-big-reveal score-${category.name}`;
        scoreText.innerHTML = `
            <div style="font-size: 0.3em; margin-bottom: 10px;">${category.emoji} ${category.text} ${category.emoji}</div>
            <div>${Math.round(score)}</div>
            <div style="font-size: 0.4em; margin-top: 10px;">PONT</div>
        `;
        
        overlay.appendChild(scoreText);
        document.body.appendChild(overlay);
        
        // Hang lej√°tsz√°sa (ha van AudioManager)
        if (window.AudioManager && window.AudioManager.playScoreReveal) {
            window.AudioManager.playScoreReveal(score);
        }
        
        // Elt√°vol√≠t√°s
        setTimeout(() => {
            if (overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
        }, 3000);
    },
    
    // Score breakdown anim√°l√°sa
    animateScoreBreakdown: function(breakdown) {
        const scoreBreakdown = document.getElementById('scoreBreakdown');
        if (!scoreBreakdown || !breakdown) return;
        
        // Elemek anim√°l√°sa egyenk√©nt
        const items = scoreBreakdown.querySelectorAll('div');
        items.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-50px)';
            item.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, index * 200);
        });
    },
    
    // Score display anim√°l√°sa
    animateScoreDisplay: function(score, category) {
        const scoreDisplay = document.getElementById('scoreDisplay');
        if (!scoreDisplay) return;
        
        // CSS class hozz√°ad√°sa
        scoreDisplay.classList.add('score-revealed');
        
        // Badge hozz√°ad√°sa
        this.addScoreBadge(scoreDisplay, category);
        
        // Class elt√°vol√≠t√°sa
        setTimeout(() => {
            scoreDisplay.classList.remove('score-revealed');
        }, 2000);
    },
    
    // Score badge hozz√°ad√°sa
    addScoreBadge: function(container, category) {
        // Megl√©v≈ë badge elt√°vol√≠t√°sa
        const existingBadge = container.querySelector('.score-grade-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        // √öj badge
        const badge = document.createElement('div');
        badge.className = 'score-grade-badge';
        badge.textContent = category.emoji + ' ' + category.text;
        
        container.style.position = 'relative';
        container.appendChild(badge);
        
        // Badge elt√°vol√≠t√°sa
        setTimeout(() => {
            if (badge.parentNode) {
                badge.parentNode.removeChild(badge);
            }
        }, 3000);
    },
    
    // Egy√©b effektek
    addScoreEffects: function(score, category) {
        // Particle effekt
        this.createParticles(score);
        
        // Confetti nagy score eset√©n
        if (score >= 80) {
            this.createConfetti();
        }
        
        // T≈±zij√°t√©k t√∂k√©letes score eset√©n
        if (score >= 95) {
            this.createFireworks();
        }
    },
    
    // Particle effekt
    createParticles: function(score) {
        const container = document.createElement('div');
        container.className = 'score-particles';
        
        const particleCount = Math.min(score / 2, 50);
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'score-particle';
            
            // Random poz√≠ci√≥ √©s ir√°ny
            const angle = (Math.PI * 2 * i) / particleCount;
            const distance = 100 + Math.random() * 100;
            const dx = Math.cos(angle) * distance;
            const dy = Math.sin(angle) * distance;
            
            particle.style.setProperty('--dx', dx + 'px');
            particle.style.setProperty('--dy', dy + 'px');
            particle.style.backgroundColor = this.getRandomColor();
            particle.style.animationDelay = Math.random() * 0.5 + 's';
            
            container.appendChild(particle);
        }
        
        document.body.appendChild(container);
        
        // Elt√°vol√≠t√°s
        setTimeout(() => {
            if (container.parentNode) {
                container.parentNode.removeChild(container);
            }
        }, 2000);
    },
    
    // Confetti l√©trehoz√°sa
    createConfetti: function() {
        const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 3000);
            }, i * 50);
        }
    },
    
    // T≈±zij√°t√©k
    createFireworks: function() {
        const colors = ['#FFD700', '#FF1744', '#00E676', '#2196F3', '#FF9800'];
        
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                const container = document.createElement('div');
                container.className = 'score-fireworks';
                
                const centerX = Math.random() * window.innerWidth;
                const centerY = Math.random() * window.innerHeight * 0.5 + window.innerHeight * 0.2;
                
                for (let j = 0; j < 20; j++) {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = centerX + 'px';
                    firework.style.top = centerY + 'px';
                    firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    container.appendChild(firework);
                }
                
                document.body.appendChild(container);
                
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }, 1500);
            }, i * 300);
        }
    },
    
    // Random sz√≠n
    getRandomColor: function() {
        const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
        return colors[Math.floor(Math.random() * colors.length)];
    },
    
    // Vibr√°ci√≥ (mobil)
    vibrate: function(score) {
        if (navigator.vibrate) {
            if (score >= 95) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            } else if (score >= 80) {
                navigator.vibrate([100, 50, 100]);
            } else if (score >= 60) {
                navigator.vibrate(100);
            }
        }
    }
};

console.log('‚úÖ ScoreAnimator bet√∂ltve');
</script>

</body>
</html>
